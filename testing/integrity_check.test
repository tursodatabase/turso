#!/usr/bin/env tclsh

set testdir [file dirname $argv0]
source $testdir/tester.tcl

if {![is_turso_mvcc]} {
    # Test basic integrity_check on empty database
    do_execsql_test_on_specific_db ":memory:" integrity-check-empty {
        PRAGMA integrity_check;
    } {ok}

    # Test basic quick_check on empty database
    do_execsql_test_on_specific_db ":memory:" quick-check-empty {
        PRAGMA quick_check;
    } {ok}

    # Test integrity_check with a simple table
    do_execsql_test_on_specific_db ":memory:" integrity-check-simple-table {
        CREATE TABLE t1(id INTEGER PRIMARY KEY, name TEXT);
        INSERT INTO t1 VALUES (1, 'Alice'), (2, 'Bob'), (3, 'Charlie');
        PRAGMA integrity_check;
    } {ok}

    # Test integrity_check with indexes
    do_execsql_test_on_specific_db ":memory:" integrity-check-with-index {
        CREATE TABLE t1(id INTEGER PRIMARY KEY, name TEXT);
        INSERT INTO t1 VALUES (1, 'Alice'), (2, 'Bob'), (3, 'Charlie');
        CREATE INDEX idx_t1_name ON t1(name);
        PRAGMA integrity_check;
    } {ok}

    # Test integrity_check with NOT NULL columns (valid data)
    do_execsql_test_on_specific_db ":memory:" integrity-check-not-null-valid {
        CREATE TABLE t2(id INTEGER PRIMARY KEY, value INTEGER NOT NULL);
        INSERT INTO t2 VALUES (1, 100), (2, 200);
        PRAGMA integrity_check;
    } {ok}

    # Test quick_check with table and index
    do_execsql_test_on_specific_db ":memory:" quick-check-with-index {
        CREATE TABLE t1(id INTEGER PRIMARY KEY, name TEXT);
        CREATE INDEX idx_t1_name ON t1(name);
        INSERT INTO t1 VALUES (1, 'test');
        PRAGMA quick_check;
    } {ok}

    # Test integrity_check with multiple indexes on same table
    do_execsql_test_on_specific_db ":memory:" integrity-check-multi-index {
        CREATE TABLE t3(a INTEGER PRIMARY KEY, b TEXT, c REAL);
        CREATE INDEX idx_t3_b ON t3(b);
        CREATE INDEX idx_t3_c ON t3(c);
        INSERT INTO t3 VALUES (1, 'x', 1.1), (2, 'y', 2.2), (3, 'z', 3.3);
        PRAGMA integrity_check;
    } {ok}

    # Test integrity_check with configurable max errors
    do_execsql_test_on_specific_db ":memory:" integrity-check-max-errors {
        CREATE TABLE t1(id INTEGER PRIMARY KEY);
        PRAGMA integrity_check(10);
    } {ok}

    # Test quick_check skips index validation (should still return ok)
    do_execsql_test_on_specific_db ":memory:" quick-check-skips-index {
        CREATE TABLE t1(id INTEGER PRIMARY KEY, name TEXT);
        CREATE INDEX idx_t1_name ON t1(name);
        INSERT INTO t1 VALUES (1, 'a'), (2, 'b');
        PRAGMA quick_check;
    } {ok}
}
