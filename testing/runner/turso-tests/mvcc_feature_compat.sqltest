@database :memory:

# Test that incompatible features are properly rejected when MVCC is enabled.
# These tests only run against tursodb since MVCC is turso-specific.

test mvcc-rejects-create-view {
    PRAGMA journal_mode = 'experimental_mvcc';
    CREATE TABLE t1 (id INTEGER PRIMARY KEY, val TEXT);
    CREATE VIEW v1 AS SELECT * FROM t1;
}
expect error {
    Views are not supported in MVCC mode
}

test mvcc-rejects-partial-index {
    PRAGMA journal_mode = 'experimental_mvcc';
    CREATE TABLE t2 (id INTEGER PRIMARY KEY, val INTEGER);
    CREATE INDEX idx_partial ON t2(val) WHERE val > 0;
}
expect error {
    Partial indexes are not supported in MVCC mode
}

test mvcc-rejects-expression-index {
    PRAGMA journal_mode = 'experimental_mvcc';
    CREATE TABLE t3 (id INTEGER PRIMARY KEY, name TEXT);
    CREATE INDEX idx_expr ON t3(UPPER(name));
}
expect error {
    Expression indexes are not supported in MVCC mode
}

test mvcc-rejects-cdc {
    PRAGMA journal_mode = 'experimental_mvcc';
    CREATE TABLE t4 (id INTEGER PRIMARY KEY, val TEXT);
    PRAGMA unstable_capture_data_changes_conn = 'full';
}
expect error {
    CDC is not supported in MVCC mode
}

# DDL statements inside BEGIN CONCURRENT should produce a clear error message
# instead of the confusing "database table is locked".

test mvcc-create-table-in-begin-concurrent {
    PRAGMA journal_mode = 'experimental_mvcc';
    BEGIN CONCURRENT;
    CREATE TABLE t5(x);
}
expect error {
    DDL statements require an exclusive transaction
}

test mvcc-create-index-in-begin-concurrent {
    PRAGMA journal_mode = 'experimental_mvcc';
    CREATE TABLE t6(x INTEGER);
    BEGIN CONCURRENT;
    CREATE INDEX idx6 ON t6(x);
}
expect error {
    DDL statements require an exclusive transaction
}

test mvcc-drop-table-in-begin-concurrent {
    PRAGMA journal_mode = 'experimental_mvcc';
    CREATE TABLE t7(x);
    BEGIN CONCURRENT;
    DROP TABLE t7;
}
expect error {
    DDL statements require an exclusive transaction
}

test mvcc-alter-table-in-begin-concurrent {
    PRAGMA journal_mode = 'experimental_mvcc';
    CREATE TABLE t9(x);
    BEGIN CONCURRENT;
    ALTER TABLE t9 ADD COLUMN y;
}
expect error {
    DDL statements require an exclusive transaction
}

test mvcc-ddl-works-in-exclusive-transaction {
    PRAGMA journal_mode = 'experimental_mvcc';
    BEGIN;
    CREATE TABLE t8(x INTEGER);
    INSERT INTO t8 VALUES (42);
    COMMIT;
    SELECT * FROM t8;
}
expect {
    experimental_mvcc
    42
}
