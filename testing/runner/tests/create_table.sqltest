@database :memory:

@cross-check-integrity
test create_table_one_unique_set {
    CREATE TABLE t4 (a, unique(b));
}
expect error {
}

@cross-check-integrity
test create_table_same_uniques_and_primary_keys {
    CREATE TABLE t2 (a,b, unique(a,b), primary key(a,b));
}
expect {
}

@cross-check-integrity
test create_table_unique_contained_in_primary_keys {
    CREATE TABLE t4 (a,b, primary key(a,b), unique(a));
}
expect {
}

# https://github.com/tursodatabase/turso/issues/3187
@cross-check-integrity
test create_table_unique_constraint_and_autoinc_backticks {
    CREATE TABLE `databases` (`id` integer PRIMARY KEY AUTOINCREMENT,`created_at` datetime,`updated_at` datetime,`deleted_at` datetime,`hostname` text NOT NULL,`namespace` text,`address` text,`primary_address` text,`local` numeric,`allowed_ips` text, CONSTRAINT `uni_databases_hostname` UNIQUE (`hostname`));
}
expect {
}

# https://github.com/tursodatabase/turso/issues/2686
@cross-check-integrity
test create_table_rowid_unique_regression_test {
    create table u(x integer unique primary key);
    insert into u values (1),(2),(3);
    select * from u where x > 2;
}
expect {
    3
}

@backend cli
# https://github.com/tursodatabase/turso/issues/2886#issuecomment-3244885481
@cross-check-integrity
test create_table_with_empty_string_name {
    create table ''('' INTEGER) strict;
    insert into '' values(9);
    select * from '';
}
expect {
    9
}

@cross-check-integrity
test create_table_multiple_column_primary_keys {
    CREATE TABLE t(a primary key, b primary key);
}
expect error {
}

@cross-check-integrity
test create_table_column_and_table_primary_keys {
    CREATE TABLE t(a primary key, b,c, primary key(b,c));
}
expect error {
}

@cross-check-integrity
test create_table_multiple_table_primary_keys {
    CREATE TABLE t(a,b,c,d,primary key(a,b), primary key(c,d));
}
expect error {
}

# https://github.com/tursodatabase/turso/issues/4674
@cross-check-integrity
test create_table_duplicate_primary_key_clause {
    CREATE TABLE t(a primary key primary key);
}
expect error {
}

# https://github.com/tursodatabase/turso/issues/3282
@cross-check-integrity
test col-named-rowid {
    create table t(rowid, a);
    insert into t values (1,2), (2,3), (3,4);
    update t set rowid = 1; -- should allow regular update and not throw unique constraint
    select count(*) from t where rowid = 1;
}
expect {
    3
}

# https://github.com/tursodatabase/turso/issues/3637
@cross-check-integrity
test create_table_duplicate_column_names {
    CREATE TABLE t(a, a);
}
expect error {
}

@cross-check-integrity
test create_table_duplicate_column_names_case_insensitive {
    CREATE TABLE t(A, a);
}
expect error {
}

@cross-check-integrity
test create_table_duplicate_column_names_quoted {
    CREATE TABLE t("a", a);
}
expect error {
}

@cross-check-integrity
test create_table_view_collision-1 {
    CREATE VIEW v_same AS SELECT 1;
    CREATE TABLE v_same(x INT);
}
expect error {
}

@cross-check-integrity
test create_view_table_collision-1 {
    CREATE TABLE t_same(x INT);
    CREATE VIEW t_same AS SELECT 1;
}
expect error {
}

@cross-check-integrity
test create_index_view_collision-1 {
    CREATE VIEW i_same AS SELECT 1;
    CREATE TABLE t1(x);
    CREATE INDEX i_same ON t1(x);
}
expect error {
}

@cross-check-integrity
test create_view_index_collision-1 {
    CREATE TABLE t4(w);
    CREATE INDEX ix_same ON t4(w);
    CREATE VIEW ix_same AS SELECT 1;
}
expect error {
}

@cross-check-integrity
test create_index_table_collision-1 {
    CREATE TABLE i_same(x INT);
    CREATE TABLE t2(y);
    CREATE INDEX i_same ON t2(y);
}
expect error {
}

@cross-check-integrity
test create_table_index_collision-1 {
    CREATE TABLE t3(z);
    CREATE INDEX ix_same ON t3(z);
    CREATE TABLE ix_same(x INT);
}
expect error {
}

# https://github.com/tursodatabase/turso/issues/3796
@cross-check-integrity
test col-default-true {
    create table t(id integer primary key, a default true);
    insert into t (id) values (1);
    SELECT a from t;
}
expect {
    1
}

# https://github.com/tursodatabase/turso/issues/3796
@cross-check-integrity
test col-default-false {
    create table t(id integer primary key, a default false);
    insert into t (id) values (1);
    SELECT a from t;
}
expect {
    0
}

@cross-check-integrity
test create-table-only-generated-column-error {
    CREATE TABLE t(a AS (123));
}
expect error {
}

# https://github.com/tursodatabase/turso/issues/4987
@cross-check-integrity
test create_table_trailing_named_column_constraint {
    CREATE TABLE t (
        a INTEGER CONSTRAINT c PRIMARY KEY,
        b,
        d CONSTRAINT e
    );
    INSERT INTO t (a, b, d) VALUES (10, 'left', 'right');
    SELECT a, b, d FROM t;
}
expect {
    10|left|right
}

# https://github.com/tursodatabase/turso/issues/4987
@cross-check-integrity
test create_table_trailing_named_column_constraint_primary_key_enforced {
    CREATE TABLE t(
        a INTEGER CONSTRAINT c PRIMARY KEY,
        b CONSTRAINT d
    );
    INSERT INTO t VALUES(1, 'x');
    INSERT OR IGNORE INTO t VALUES(1, 'y');
    SELECT count(*), min(b), max(b) FROM t;
}
expect {
    1|x|x
}
