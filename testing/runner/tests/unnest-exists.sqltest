@database :memory:

setup schema {
    CREATE TABLE t1(a INT, b INT);
    CREATE TABLE t2(x INT, y INT);
    INSERT INTO t1 VALUES(1, 10), (2, 20), (3, 30), (4, 40);
    INSERT INTO t2 VALUES(1, 100), (2, 200), (3, 300);
}

@setup schema
test exists-basic {
    SELECT a, b FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
}

@setup schema
test not-exists-basic {
    SELECT a, b FROM t1 WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
    4|40
}

@setup schema
test exists-with-inner-filter {
    SELECT a, b FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a AND t2.y > 150) ORDER BY a;
}
expect {
    2|20
    3|30
}

@setup schema
test not-exists-with-inner-filter {
    SELECT a, b FROM t1 WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a AND t2.y > 150) ORDER BY a;
}
expect {
    1|10
    4|40
}

setup schema_empty {
    CREATE TABLE t1(a INT, b INT);
    CREATE TABLE t2(x INT, y INT);
    INSERT INTO t1 VALUES(1, 10), (2, 20);
}

@setup schema_empty
test exists-empty-inner {
    SELECT a, b FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
}

@setup schema_empty
test not-exists-empty-inner {
    SELECT a, b FROM t1 WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
    1|10
    2|20
}

setup schema_multi {
    CREATE TABLE t1(a INT, b INT, c INT);
    CREATE TABLE t2(x INT, y INT, z INT);
    INSERT INTO t1 VALUES(1, 10, 100), (2, 20, 200), (3, 30, 300);
    INSERT INTO t2 VALUES(1, 10, 999), (2, 99, 999), (3, 30, 999);
}

@setup schema_multi
test exists-multi-correlation {
    SELECT a, b FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a AND t2.y = t1.b) ORDER BY a;
}
expect {
    1|10
    3|30
}

@setup schema
test exists-in-and {
    SELECT a, b FROM t1 WHERE a > 1 AND EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
    2|20
    3|30
}

@setup schema
test not-exists-in-and {
    SELECT a, b FROM t1 WHERE a < 4 AND NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
}

setup schema_null {
    CREATE TABLE t1(a INT, b INT);
    CREATE TABLE t2(x INT, y INT);
    INSERT INTO t1 VALUES(1, 10), (NULL, 20), (3, 30);
    INSERT INTO t2 VALUES(1, 100), (NULL, 200);
}

@setup schema_null
test exists-null-keys {
    SELECT a, b FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY b;
}
expect {
    1|10
}

@setup schema_null
test not-exists-null-keys {
    SELECT a, b FROM t1 WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY b;
}
expect {
    |20
    3|30
}

setup schema_dup {
    CREATE TABLE t1(a INT);
    CREATE TABLE t2(x INT);
    INSERT INTO t1 VALUES(1), (2), (3);
    INSERT INTO t2 VALUES(1), (1), (1), (2);
}

@setup schema_dup
test exists-duplicate-inner {
    SELECT a FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
    1
    2
}

setup schema_indexed {
    CREATE TABLE t1(a INT);
    CREATE TABLE t2(x INT);
    CREATE INDEX idx_t2_x ON t2(x);
    INSERT INTO t1 VALUES(1), (2), (3), (4), (5);
    INSERT INTO t2 VALUES(2), (4);
}

@setup schema_indexed
test exists-indexed {
    SELECT a FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
    2
    4
}

@setup schema_indexed
test not-exists-indexed {
    SELECT a FROM t1 WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY a;
}
expect {
    1
    3
    5
}

setup schema_agg {
    CREATE TABLE orders(id INT, customer_id INT, amount INT);
    CREATE TABLE returns(order_id INT);
    INSERT INTO orders VALUES(1, 10, 100), (2, 10, 200), (3, 20, 300), (4, 20, 400), (5, 30, 500);
    INSERT INTO returns VALUES(1), (3), (5);
}

@setup schema_agg
test not-exists-count {
    SELECT COUNT(*) FROM orders o WHERE NOT EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id);
}
expect {
    2
}

@setup schema_agg
test exists-count {
    SELECT COUNT(*) FROM orders o WHERE EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id);
}
expect {
    3
}

@setup schema_agg
test not-exists-sum {
    SELECT SUM(amount) FROM orders o WHERE NOT EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id);
}
expect {
    600
}

@setup schema_agg
test exists-group-by {
    SELECT customer_id, COUNT(*) FROM orders o
    WHERE EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    GROUP BY customer_id ORDER BY customer_id;
}
expect {
    10|1
    20|1
    30|1
}

@setup schema_agg
test not-exists-group-by {
    SELECT customer_id, SUM(amount) FROM orders o
    WHERE NOT EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    GROUP BY customer_id ORDER BY customer_id;
}
expect {
    10|200
    20|400
}

@setup schema
test exists-order-by {
    SELECT a, b FROM t1 WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY b DESC;
}
expect {
    3|30
    2|20
    1|10
}

@setup schema
test not-exists-order-by {
    SELECT a, b FROM t1 WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) ORDER BY b DESC;
}
expect {
    4|40
}

setup schema_self {
    CREATE TABLE emp(id INT, mgr_id INT, name TEXT);
    INSERT INTO emp VALUES(1, NULL, 'CEO'), (2, 1, 'VP'), (3, 1, 'CTO'), (4, 2, 'Dev'), (5, 99, 'Ghost');
}

@setup schema_self
test exists-self-join {
    SELECT name FROM emp e WHERE EXISTS (SELECT 1 FROM emp m WHERE m.id = e.mgr_id) ORDER BY name;
}
expect {
    CTO
    Dev
    VP
}

@setup schema_self
test not-exists-self-join {
    SELECT name FROM emp e WHERE NOT EXISTS (SELECT 1 FROM emp m WHERE m.id = e.mgr_id) ORDER BY name;
}
expect {
    CEO
    Ghost
}

setup schema_multi_exists {
    CREATE TABLE t1(a INT);
    CREATE TABLE t2(x INT);
    CREATE TABLE t3(y INT);
    INSERT INTO t1 VALUES(1), (2), (3), (4);
    INSERT INTO t2 VALUES(1), (2), (3);
    INSERT INTO t3 VALUES(2), (3), (4);
}

@setup schema_multi_exists
test two-exists {
    SELECT a FROM t1
    WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a)
    ORDER BY a;
}
expect {
    2
    3
}

@setup schema_multi_exists
test two-not-exists {
    SELECT a FROM t1
    WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND NOT EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a)
    ORDER BY a;
}
expect {
}

@setup schema_multi_exists
test exists-and-not-exists {
    SELECT a FROM t1
    WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND NOT EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a)
    ORDER BY a;
}
expect {
    1
}

@setup schema_multi_exists
test not-exists-and-exists {
    SELECT a FROM t1
    WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a)
    ORDER BY a;
}
expect {
    4
}

@setup schema_multi_exists
test two-exists-count {
    SELECT COUNT(*) FROM t1
    WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a);
}
expect {
    2
}

@setup schema_multi_exists
test exists-and-not-exists-count {
    SELECT COUNT(*) FROM t1
    WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND NOT EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a);
}
expect {
    1
}

setup schema_join_exists {
    CREATE TABLE customers(id INT PRIMARY KEY, name TEXT, region INT);
    CREATE TABLE orders(id INT PRIMARY KEY, cust_id INT, amount INT);
    CREATE TABLE returns(order_id INT);
    CREATE TABLE blacklist(cust_id INT);
    INSERT INTO customers VALUES(1, 'Alice', 1), (2, 'Bob', 1), (3, 'Carol', 2), (4, 'Dave', 2), (5, 'Eve', 3);
    INSERT INTO orders VALUES(10, 1, 100), (11, 1, 200), (12, 2, 150), (13, 3, 300), (14, 4, 50);
    INSERT INTO returns VALUES(10), (13);
    INSERT INTO blacklist VALUES(4);
}

@setup schema_join_exists
test join-with-exists {
    SELECT c.name, o.amount FROM customers c
    JOIN orders o ON o.cust_id = c.id
    WHERE EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    ORDER BY c.name;
}
expect {
    Alice|100
    Carol|300
}

@setup schema_join_exists
test join-with-not-exists {
    SELECT c.name, o.amount FROM customers c
    JOIN orders o ON o.cust_id = c.id
    WHERE NOT EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    ORDER BY c.name, o.amount;
}
expect {
    Alice|200
    Bob|150
    Dave|50
}

@setup schema_join_exists
test join-with-two-not-exists {
    SELECT c.name, o.amount FROM customers c
    JOIN orders o ON o.cust_id = c.id
    WHERE NOT EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    AND NOT EXISTS (SELECT 1 FROM blacklist b WHERE b.cust_id = c.id)
    ORDER BY c.name;
}
expect {
    Alice|200
    Bob|150
}

@setup schema_join_exists
test join-with-exists-and-not-exists {
    SELECT c.name FROM customers c
    JOIN orders o ON o.cust_id = c.id
    WHERE EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    AND NOT EXISTS (SELECT 1 FROM blacklist b WHERE b.cust_id = c.id)
    ORDER BY c.name;
}
expect {
    Alice
    Carol
}

@setup schema_join_exists
test left-join-with-exists {
    SELECT c.name, o.amount FROM customers c
    LEFT JOIN orders o ON o.cust_id = c.id
    WHERE EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    ORDER BY c.name;
}
expect {
    Alice|100
    Carol|300
}

@setup schema_join_exists
test exists-on-join-aggregate {
    SELECT c.region, SUM(o.amount) FROM customers c
    JOIN orders o ON o.cust_id = c.id
    WHERE NOT EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    GROUP BY c.region ORDER BY c.region;
}
expect {
    1|350
    2|50
}

setup schema_outer_join_on_exists {
    CREATE TABLE a(x INT);
    CREATE TABLE b(y INT);
    CREATE TABLE c(z INT);
    INSERT INTO a VALUES(1), (2);
    INSERT INTO b VALUES(10), (20);
    INSERT INTO c VALUES(1);
}

@setup schema_outer_join_on_exists
test left-join-on-exists-correlated {
    SELECT a.x, COALESCE(b.y, -1) FROM a
    LEFT JOIN b ON EXISTS (SELECT 1 FROM c WHERE c.z = a.x)
    ORDER BY a.x, b.y;
}
expect {
    1|10
    1|20
    2|-1
}

@setup schema_outer_join_on_exists
test left-join-on-not-exists-correlated {
    SELECT a.x, COALESCE(b.y, -1) FROM a
    LEFT JOIN b ON NOT EXISTS (SELECT 1 FROM c WHERE c.z = a.x)
    ORDER BY a.x, b.y;
}
expect {
    1|-1
    2|10
    2|20
}

@setup schema_outer_join_on_exists
test left-join-on-exists-correlated-with-rhs-filter {
    SELECT a.x, COALESCE(b.y, -1) FROM a
    LEFT JOIN b ON b.y > 15 AND EXISTS (SELECT 1 FROM c WHERE c.z = a.x)
    ORDER BY a.x, b.y;
}
expect {
    1|20
    2|-1
}

@setup schema_outer_join_on_exists
test left-join-on-not-exists-correlated-with-rhs-filter {
    SELECT a.x, COALESCE(b.y, -1) FROM a
    LEFT JOIN b ON b.y > 15 AND NOT EXISTS (SELECT 1 FROM c WHERE c.z = a.x)
    ORDER BY a.x, b.y;
}
expect {
    1|-1
    2|20
}

setup schema_left_join_on_rhs_correlated_exists {
    CREATE TABLE o(id INT, k INT);
    CREATE TABLE j(id INT, k INT);
    CREATE TABLE i1(k INT);
    INSERT INTO o VALUES(1, 1), (2, 2);
    INSERT INTO j VALUES(1, 1), (2, 2), (3, NULL), (4, 4);
    INSERT INTO i1 VALUES(1), (2);
}

@setup schema_left_join_on_rhs_correlated_exists
test left-join-on-exists-correlated-rhs {
    SELECT o.id, COALESCE(j.id, -1) FROM o
    LEFT JOIN j ON EXISTS (SELECT 1 FROM i1 WHERE i1.k = j.k)
    ORDER BY o.id, j.id;
}
expect {
    1|1
    1|2
    2|1
    2|2
}

setup schema_left_join_on_both_sides_correlated_not_exists {
    CREATE TABLE o(id INT, k INT);
    CREATE TABLE j(id INT, k INT);
    CREATE TABLE i1(k INT);
    INSERT INTO o VALUES(1, 1), (2, 2), (3, 3);
    INSERT INTO j VALUES(1, 1), (2, 2), (3, 3);
    INSERT INTO i1 VALUES(1), (2);
}

@setup schema_left_join_on_both_sides_correlated_not_exists
test left-join-on-not-exists-correlated-both-sides {
    SELECT o.id, COALESCE(j.id, -1) FROM o
    LEFT JOIN j ON NOT EXISTS (SELECT 1 FROM i1 WHERE i1.k = o.k AND i1.k = j.k)
    ORDER BY o.id, j.id;
}
expect {
    1|2
    1|3
    2|1
    2|3
    3|1
    3|2
    3|3
}

setup schema_three_not_exists {
    CREATE TABLE t1(a INT);
    CREATE TABLE t2(x INT);
    CREATE TABLE t3(y INT);
    CREATE TABLE t4(z INT);
    INSERT INTO t1 VALUES(1), (2), (3), (4), (5), (6);
    INSERT INTO t2 VALUES(1), (2);
    INSERT INTO t3 VALUES(3), (4);
    INSERT INTO t4 VALUES(5), (6);
}

@setup schema_three_not_exists
test three-not-exists {
    SELECT a FROM t1
    WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND NOT EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a)
    AND NOT EXISTS (SELECT 1 FROM t4 WHERE t4.z = t1.a)
    ORDER BY a;
}
expect {
}

@setup schema_three_not_exists
test three-not-exists-with-gaps {
    SELECT a FROM t1
    WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND NOT EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a)
    ORDER BY a;
}
expect {
    5
    6
}

@setup schema_three_not_exists
test three-exists-mix {
    SELECT a FROM t1
    WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    AND NOT EXISTS (SELECT 1 FROM t3 WHERE t3.y = t1.a)
    AND NOT EXISTS (SELECT 1 FROM t4 WHERE t4.z = t1.a)
    ORDER BY a;
}
expect {
    1
    2
}

@setup schema_join_exists
test exists-no-matching-outer-rows {
    SELECT c.name FROM customers c
    WHERE c.region = 99
    AND EXISTS (SELECT 1 FROM orders o WHERE o.cust_id = c.id)
    ORDER BY c.name;
}
expect {
}

@setup schema_join_exists
test not-exists-all-match {
    SELECT c.name FROM customers c
    WHERE NOT EXISTS (SELECT 1 FROM orders o WHERE o.cust_id = c.id AND o.amount > 9999)
    ORDER BY c.name;
}
expect {
    Alice
    Bob
    Carol
    Dave
    Eve
}

setup schema_left_join_not_exists {
    CREATE TABLE customers(id INT PRIMARY KEY, name TEXT);
    CREATE TABLE orders(id INT PRIMARY KEY, cust_id INT, product TEXT);
    CREATE TABLE returns(order_id INT);
    INSERT INTO customers VALUES(1, 'Alice'), (2, 'Bob'), (3, 'Carol');
    INSERT INTO orders VALUES(10, 1, 'Widget'), (11, 2, 'Gadget');
    INSERT INTO returns VALUES(10);
}

@setup schema
test not-exists-volatile-function-not-unnested {
    SELECT a, b FROM t1 WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a AND random() IS NOT NULL) ORDER BY a;
}
expect {
    4|40
}


@setup schema_left_join_not_exists
test left-join-not-exists-on-right-table {
    SELECT c.name, o.product FROM customers c
    LEFT JOIN orders o ON o.cust_id = c.id
    WHERE NOT EXISTS (SELECT 1 FROM returns r WHERE r.order_id = o.id)
    ORDER BY c.name;
}
expect {
    Bob|Gadget
    Carol|
}

setup schema_multi_inner {
    CREATE TABLE t1(a INT, b INT);
    CREATE TABLE t2(x INT, y INT);
    CREATE TABLE t3(p INT, q INT);
    INSERT INTO t1 VALUES(1, 10), (2, 20), (3, 30), (4, 40);
    INSERT INTO t2 VALUES(1, 100), (2, 200), (2, 201), (3, 300);
    INSERT INTO t3 VALUES(100, 1000), (200, 2000), (201, 2001), (300, 3000), (300, 3001);
}

@setup schema_multi_inner
test exists-multi-table-inner-join {
    SELECT a, b FROM t1
    WHERE EXISTS (
      SELECT 1 FROM t2 JOIN t3 ON t3.p = t2.y WHERE t2.x = t1.a
    )
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
}

@setup schema_multi_inner
test exists-multi-table-inner-join-count {
    SELECT COUNT(*) FROM t1
    WHERE EXISTS (
      SELECT 1 FROM t2 JOIN t3 ON t3.p = t2.y WHERE t2.x = t1.a
    );
}
expect {
    3
}

@setup schema_multi_inner
test not-exists-multi-table-inner-join {
    SELECT a, b FROM t1
    WHERE NOT EXISTS (
      SELECT 1 FROM t2 JOIN t3 ON t3.p = t2.y WHERE t2.x = t1.a
    )
    ORDER BY a;
}
expect {
    4|40
}

@setup schema_multi_inner
test not-exists-multi-table-cross-join {
    SELECT a, b FROM t1
    WHERE NOT EXISTS (
      SELECT 1 FROM t2, t3 WHERE t2.x = t1.a
    )
    ORDER BY a;
}
expect {
    4|40
}

setup schema_inner_left_join {
    CREATE TABLE t_outer(a INT);
    CREATE TABLE t_inner1(x INT, y INT);
    CREATE TABLE t_inner2(p INT);
    INSERT INTO t_outer VALUES(1), (2), (3);
    INSERT INTO t_inner1 VALUES(1, 10), (2, 20), (3, 30);
    INSERT INTO t_inner2 VALUES(10);
}

@setup schema_inner_left_join
test not-exists-with-inner-left-join {
    SELECT a FROM t_outer
    WHERE NOT EXISTS (
      SELECT 1 FROM t_inner1
      LEFT JOIN t_inner2 ON t_inner2.p = t_inner1.y
      WHERE t_inner1.x = t_outer.a AND t_inner2.p IS NOT NULL
    )
    ORDER BY a;
}
expect {
    2
    3
}

@setup schema_inner_left_join
test exists-with-inner-left-join {
    SELECT a FROM t_outer
    WHERE EXISTS (
      SELECT 1 FROM t_inner1
      LEFT JOIN t_inner2 ON t_inner2.p = t_inner1.y
      WHERE t_inner1.x = t_outer.a AND t_inner2.p IS NOT NULL
    )
    ORDER BY a;
}
expect {
    1
}

setup schema_hash_left_join {
    CREATE TABLE t1(a INT, b INT);
    CREATE TABLE t2(x INT, y INT);
    CREATE TABLE t3(p INT, q INT);
    CREATE TABLE t4(u INT);
    INSERT INTO t1 VALUES(1, 10), (2, 20), (3, 30), (4, 40);
    INSERT INTO t2 VALUES(1, 100), (2, 200), (3, 300);
    INSERT INTO t3 VALUES(10, 1), (20, 2), (30, 3);
    INSERT INTO t4 VALUES(2);
}

@setup schema_hash_left_join
test exists-with-outer-left-join-hash {
    SELECT t1.a, t3.q FROM t1
    LEFT JOIN t3 ON t3.p = t1.b
    WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    ORDER BY t1.a;
}
expect {
    1|1
    2|2
    3|3
}

@setup schema_hash_left_join
test not-exists-with-outer-left-join-hash {
    SELECT t1.a, t3.q FROM t1
    LEFT JOIN t3 ON t3.p = t1.b
    WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
    ORDER BY t1.a;
}
expect {
    4|
}

@setup schema_hash_left_join
test two-not-exists-with-outer-left-join-hash {
    SELECT t1.a, t3.q FROM t1
    LEFT JOIN t3 ON t3.p = t1.b
    WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
      AND NOT EXISTS (SELECT 1 FROM t4 WHERE t4.u = t1.a)
    ORDER BY t1.a;
}
expect {
    4|
}

@setup schema_hash_left_join
test exists-and-not-exists-with-outer-left-join-hash {
    SELECT t1.a, t3.q FROM t1
    LEFT JOIN t3 ON t3.p = t1.b
    WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)
      AND NOT EXISTS (SELECT 1 FROM t4 WHERE t4.u = t1.a)
    ORDER BY t1.a;
}
expect {
    1|1
    3|3
}

@setup schema
test exists-limit-0-always-false {
    SELECT a, b FROM t1
    WHERE EXISTS (
      SELECT 1 FROM t2 WHERE t2.x = t1.a LIMIT 0
    )
    ORDER BY a;
}
expect {
}

@setup schema
test not-exists-limit-0-always-true {
    SELECT a, b FROM t1
    WHERE NOT EXISTS (
      SELECT 1 FROM t2 WHERE t2.x = t1.a LIMIT 0
    )
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
    4|40
}

@setup schema
test not-exists-inner-constant-false {
    SELECT a, b FROM t1
    WHERE NOT EXISTS (
      SELECT 1 FROM t2 WHERE t2.x = t1.a AND 0
    )
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
    4|40
}

@setup schema
test not-exists-inner-constant-null {
    SELECT a, b FROM t1
    WHERE NOT EXISTS (
      SELECT 1 FROM t2 WHERE t2.x = t1.a AND NULL
    )
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
    4|40
}

@setup schema
test exists-under-or {
    SELECT a, b FROM t1
    WHERE EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) OR a = 4
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
    4|40
}

@setup schema
test not-exists-under-or {
    SELECT a, b FROM t1
    WHERE NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) OR a = 1
    ORDER BY a;
}
expect {
    1|10
    4|40
}

@setup schema
test exists-is-true-wrapper {
    SELECT a, b FROM t1
    WHERE (EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)) IS TRUE
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
}

@setup schema
test exists-is-false-wrapper {
    SELECT a, b FROM t1
    WHERE (EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)) IS FALSE
    ORDER BY a;
}
expect {
    4|40
}

@setup schema
test not-exists-is-true-wrapper {
    SELECT a, b FROM t1
    WHERE (NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)) IS TRUE
    ORDER BY a;
}
expect {
    4|40
}

@setup schema
test not-exists-is-false-wrapper {
    SELECT a, b FROM t1
    WHERE (NOT EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a)) IS FALSE
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
}

@setup schema
test exists-case-wrapper {
    SELECT a, b FROM t1
    WHERE CASE WHEN EXISTS (SELECT 1 FROM t2 WHERE t2.x = t1.a) THEN 1 ELSE 0 END = 1
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
}

@setup schema
test exists-inner-outer-only-false {
    SELECT a, b FROM t1
    WHERE EXISTS (
      SELECT 1 FROM t2 WHERE t2.x = t1.a AND t1.a < 0
    )
    ORDER BY a;
}
expect {
}

@setup schema
test not-exists-inner-outer-only-false {
    SELECT a, b FROM t1
    WHERE NOT EXISTS (
      SELECT 1 FROM t2 WHERE t2.x = t1.a AND t1.a < 0
    )
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
    4|40
}

@setup schema
test exists-non-equality-correlation {
    SELECT a, b FROM t1
    WHERE EXISTS (
      SELECT 1 FROM t2 WHERE t2.x > t1.a
    )
    ORDER BY a;
}
expect {
    1|10
    2|20
}

@setup schema
test not-exists-non-equality-correlation {
    SELECT a, b FROM t1
    WHERE NOT EXISTS (
      SELECT 1 FROM t2 WHERE t2.x > t1.a
    )
    ORDER BY a;
}
expect {
    3|30
    4|40
}

@setup schema
test exists-inner-nested-exists {
    SELECT a, b FROM t1
    WHERE EXISTS (
      SELECT 1 FROM t2
      WHERE t2.x = t1.a
      AND EXISTS (SELECT 1 FROM t2 t22 WHERE t22.x = t2.x)
    )
    ORDER BY a;
}
expect {
    1|10
    2|20
    3|30
}
