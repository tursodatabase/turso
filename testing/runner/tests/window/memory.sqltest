@database :memory:

@cross-check-integrity
test window-partition-by-duplicate-columns {
    CREATE TABLE t1 (a INTEGER, b INTEGER, c INTEGER);
    INSERT INTO t1 VALUES (1, 2, 3);
    SELECT avg(a) OVER (PARTITION BY b, b, c, c, a ORDER BY c) FROM t1;
}
expect {
    1.0
}
expect @js {
    1
}

@cross-check-integrity
test window-partition-by-duplicate-columns-multi-row {
    CREATE TABLE t2 (a INTEGER, b INTEGER, c INTEGER);
    INSERT INTO t2 VALUES (1, 10, 100), (2, 10, 100), (3, 20, 200), (4, 20, 200);
    SELECT sum(a) OVER (PARTITION BY b, b, c, c ORDER BY a) FROM t2;
}
expect {
    1
    3
    3
    7
}

@cross-check-integrity
test window-partition-by-duplicate-columns-collation {
    CREATE TABLE t3 (val INTEGER, name TEXT COLLATE NOCASE);
    INSERT INTO t3 VALUES (1, 'Apple'), (2, 'apple'), (3, 'Banana'), (4, 'banana');
    SELECT sum(val) OVER (PARTITION BY name, name ORDER BY val) FROM t3;
}
expect {
    1
    3
    3
    7
}

@cross-check-integrity
test window-collate-partition-by {
    CREATE TABLE fruits(name collate nocase);
    INSERT INTO fruits(name) VALUES ('Apple'), ('banana'), ('apple');
    SELECT
    name,
    count(*) OVER (PARTITION BY name)
    FROM fruits;
}
expect {
    Apple|2
    apple|2
    banana|1
}

@cross-check-integrity
test window-collate-order-by {
    CREATE TABLE fruits(name collate nocase);
    INSERT INTO fruits(name) VALUES ('Apple'),('banana'), ('apple');
    SELECT
    name,
    count(*) OVER (ORDER BY name)
    FROM fruits;
}
expect {
    Apple|2
    apple|2
    banana|3
}

@cross-check-integrity
test window-in-exists-subquery-referencing-outer-column {
    CREATE TABLE t1 (a);
    INSERT INTO t1 VALUES (1), (2), (3);
    SELECT * FROM (SELECT a FROM t1) as subq
    WHERE EXISTS (
      SELECT count(1) OVER (ORDER BY subq.a) FROM t1
    );
}
expect {
    1
    2
    3
}

test window-row-number-partition-order {
    CREATE TABLE t4 (a INTEGER, b TEXT);
    INSERT INTO t4 VALUES (1, 'x'), (2, 'x'), (3, 'y'), (4, 'y');
    SELECT
    a,
    b,
    ROW_NUMBER() OVER (PARTITION BY b ORDER BY a DESC) AS rn
    FROM t4
    ORDER BY b, a DESC;
}
expect {
    2|x|1
    1|x|2
    4|y|1
    3|y|2
}

test window-row-number-no-order {
    CREATE TABLE t5 (val INTEGER);
    INSERT INTO t5 VALUES (10), (20), (30);
    SELECT row_number() OVER () AS rn FROM t5 ORDER BY rn;
}
expect {
    1
    2
    3
}
