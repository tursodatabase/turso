@database :memory:

@cross-check-integrity
test alter-table-rename-table {
    CREATE TABLE t1 (x INTEGER PRIMARY KEY, u);
    ALTER TABLE t1 RENAME TO t2;
    SELECT name FROM sqlite_schema WHERE type = 'table';
}
expect {
    t2
}

@cross-check-integrity
test alter-table-rename-column {
    CREATE TABLE t (a INTEGER);
    CREATE INDEX i ON t (a);
    ALTER TABLE t RENAME a TO b;
    SELECT sql FROM sqlite_schema;
}
expect {
    CREATE TABLE t (b INTEGER)
    CREATE INDEX i ON t (b)
}

# https://github.com/tursodatabase/turso/issues/5246
@cross-check-integrity
test alter-table-rename-column-case-insensitive {
    CREATE TABLE t (a INT);
    ALTER TABLE t RENAME COLUMN A TO b;
    SELECT sql FROM sqlite_schema;
}
expect {
    CREATE TABLE t (b INT)
}

@cross-check-integrity
test alter-table-rename-quoted-column {
    CREATE TABLE t (a INTEGER);
    ALTER TABLE t RENAME a TO "ab cd";
    SELECT sql FROM sqlite_schema;
}
expect {
    CREATE TABLE t ("ab cd" INTEGER)
}

@cross-check-integrity
test alter-table-add-column {
    CREATE TABLE t (a);
    INSERT INTO t VALUES (1);
    SELECT * FROM t;

    ALTER TABLE t ADD b;
    SELECT sql FROM sqlite_schema;
    SELECT * FROM t;
}
expect {
    1
    CREATE TABLE t (a, b)
    1|
}

@cross-check-integrity
test alter-table-add-column-typed {
    CREATE TABLE t (a);
    ALTER TABLE t ADD b DEFAULT 0;
    SELECT sql FROM sqlite_schema;
    INSERT INTO t (a) VALUES (1);
    SELECT * FROM t;
}
expect {
    CREATE TABLE t (a, b DEFAULT 0)
    1|0
}

@cross-check-integrity
test alter-table-add-column-invalid-multi-column-fk {
    CREATE TABLE t(a, c);
    CREATE TABLE s(a);
    ALTER TABLE s ADD COLUMN b REFERENCES t(a, c);
}
expect error {
}

@cross-check-integrity
test alter-table-add-column-default {
    CREATE TABLE test (a);
    INSERT INTO test VALUES (1), (2), (3);

    ALTER TABLE test ADD b DEFAULT 0.1;
    ALTER TABLE test ADD c DEFAULT 'hello';
    SELECT * FROM test;

    CREATE INDEX idx ON test (b);
    SELECT b, c FROM test WHERE b = 0.1;

    ALTER TABLE test DROP a;
    SELECT * FROM test;
}
expect {
    1|0.1|hello
    2|0.1|hello
    3|0.1|hello
    0.1|hello
    0.1|hello
    0.1|hello
    0.1|hello
    0.1|hello
    0.1|hello
}

@cross-check-integrity
test alter-table-add-quoted-column {
    CREATE TABLE test (a);
    ALTER TABLE test ADD COLUMN [b c];
    SELECT sql FROM sqlite_schema;
}
expect {
    CREATE TABLE test (a, [b c])
}

@cross-check-integrity
test alter-table-add-column-default-affinity-text {
    CREATE TABLE t(a INTEGER PRIMARY KEY);
    INSERT INTO t VALUES(1);
    INSERT INTO t VALUES(2);
    ALTER TABLE t ADD COLUMN c TEXT DEFAULT 0;
    SELECT a, typeof(c), c FROM t;
}
expect {
    1|text|0
    2|text|0
}

@cross-check-integrity
test alter-table-add-column-default-affinity-integer {
    CREATE TABLE t(a INTEGER PRIMARY KEY);
    INSERT INTO t VALUES(1);
    ALTER TABLE t ADD COLUMN c INTEGER DEFAULT '5';
    SELECT a, typeof(c), c FROM t;
}
expect {
    1|integer|5
}

@cross-check-integrity
test alter-table-add-column-default-affinity-real {
    CREATE TABLE t(a INTEGER PRIMARY KEY);
    INSERT INTO t VALUES(1);
    ALTER TABLE t ADD COLUMN c REAL DEFAULT '3';
    SELECT a, typeof(c), c FROM t;
}
expect {
    1|real|3.0
}
expect @js {
    1|real|3
}

@cross-check-integrity
test alter-table-add-column-default-affinity-numeric {
    CREATE TABLE t(a INTEGER PRIMARY KEY);
    INSERT INTO t VALUES(1);
    ALTER TABLE t ADD COLUMN c NUMERIC DEFAULT '7';
    SELECT a, typeof(c), c FROM t;
}
expect {
    1|integer|7
}

@cross-check-integrity
test alter-table-drop-column {
    CREATE TABLE t (a, b);
    INSERT INTO t VALUES (1, 1), (2, 2), (3, 3);
    SELECT * FROM t;

    ALTER TABLE t DROP b;
    SELECT sql FROM sqlite_schema;

    SELECT * FROM t;
}
expect {
    1|1
    2|2
    3|3
    CREATE TABLE t (a)
    1
    2
    3
}

@cross-check-integrity
test alter-table-drop-column-special-name {
    CREATE TABLE t (a, b, [c c]);
    INSERT INTO t VALUES (1, 2, 3);
    ALTER TABLE t DROP COLUMN b;

    SELECT "c c" FROM t;
    SELECT sql FROM sqlite_schema;
}
expect {
    3
    CREATE TABLE t (a, [c c])
}

@cross-check-integrity
test fail-alter-table-drop-unique-column {
    CREATE TABLE t (a, b UNIQUE);
    ALTER TABLE t DROP b;
}
expect error {
}

@cross-check-integrity
test fail-alter-table-drop-unique-column-constraint {
    CREATE TABLE t (a, b, UNIQUE (b));
    ALTER TABLE t DROP b;
}
expect error {
}

# refer https://github.com/tursodatabase/turso/issues/3231
@cross-check-integrity
test fail-alter-table-add-duplicate-column {
    CREATE TABLE t1 (a);
    ALTER TABLE t1 ADD COLUMN a;
}
expect error {
}

@cross-check-integrity
test fail-alter-table-add-duplicate-column-case-insensitive {
    CREATE TABLE t1 (a);
    ALTER TABLE t1 ADD COLUMN A;
}
expect error {
}

@cross-check-integrity
test fail-alter-table-drop-primary-key-column {
    CREATE TABLE t (a PRIMARY KEY, b);
    ALTER TABLE t DROP a;
}
expect error {
}

@cross-check-integrity
test fail-alter-table-drop-primary-key-column-constrait {
    CREATE TABLE t (a, b, PRIMARY KEY (a));
    ALTER TABLE t DROP a;
}
expect error {
}

@cross-check-integrity
test fail-alter-table-rename-to-existing-index {
    CREATE TABLE x (a);
    CREATE INDEX y ON x (a);
    ALTER TABLE x RENAME TO y;
}
expect error {
}

@cross-check-integrity
test fail-alter-table-rename-to-existing-table {
    CREATE TABLE x (a);
    CREATE TABLE y (a);
    ALTER TABLE x RENAME TO y;
}
expect error {
}

@cross-check-integrity
test alter-table-rename-to-quoted-identifier {
    CREATE TABLE t (a);
    CREATE INDEX idx ON t (a);
    INSERT INTO t VALUES (1);

    ALTER TABLE t RENAME TO "t t";
    SELECT sql FROM sqlite_schema;

    INSERT INTO "t t" VALUES (2);
    SELECT a FROM "t t";

    DELETE FROM "t t" WHERE a = 1;
    SELECT a FROM "t t";

    ALTER TABLE "t t" RENAME COLUMN a TO "a a";
    SELECT sql FROM sqlite_schema;
    SELECT "a a" FROM "t t";
    
    ALTER TABLE "t t" RENAME COLUMN "a a" TO "b b";
    SELECT sql FROM sqlite_schema;
    SELECT "b b" FROM "t t";
}
expect {
    CREATE TABLE "t t" (a)
    CREATE INDEX idx ON "t t" (a)
    1
    2
    2
    CREATE TABLE "t t" ("a a")
    CREATE INDEX idx ON "t t" ("a a")
    2
    CREATE TABLE "t t" ("b b")
    CREATE INDEX idx ON "t t" ("b b")
    2
}

# https://github.com/tursodatabase/turso/issues/3391
@cross-check-integrity
test alter-table-add-notnull-col {
    CREATE TABLE t (a);
    ALTER TABLE t ADD b NOT NULL;
    SELECT sql FROM sqlite_schema WHERE type = 'table' AND name = 't';
}
expect {
    CREATE TABLE t (a, b NOT NULL)
}

# https://github.com/tursodatabase/turso/issues/3448
@cross-check-integrity
test drop-column-regression {
    CREATE TABLE t (id, col1 BLOB, col2 UNIQUE);
    INSERT INTO t VALUES ('id', 'col1', 'col2');
    ALTER TABLE t ADD COLUMN col3 BLOB;
    ALTER TABLE t DROP COLUMN col1;
    SELECT col3 FROM t;
}
expect {
}

# https://github.com/tursodatabase/turso/issues/3886
@cross-check-integrity
test alter-tbl-regression {
    PRAGMA foreign_keys = ON;
    CREATE TABLE p_ren1(id INTEGER PRIMARY KEY);
    CREATE TABLE c_ren1(id INTEGER PRIMARY KEY, pid INTEGER,
    FOREIGN KEY(pid) REFERENCES p_ren1(id)
    );
    INSERT INTO p_ren1 VALUES (1);
    INSERT INTO c_ren1 VALUES (10,1);
    ALTER TABLE p_ren1 RENAME TO p_ren1_new;
    INSERT INTO p_ren1_new VALUES (2);
    INSERT INTO c_ren1 VALUES (20,2);
    SELECT c_ren1.id, c_ren1.pid
    FROM c_ren1 JOIN p_ren1_new ON p_ren1_new.id = c_ren1.pid
    ORDER BY c_ren1.id;
}
expect {
    10|1
    20|2
}

@cross-check-integrity
test drop-column-removes-check-constraint {
    CREATE TABLE t_check (a INTEGER PRIMARY KEY, b REAL CHECK (b BETWEEN 0.0 AND 1000.0), c INTEGER NOT NULL);
    INSERT INTO t_check VALUES (1, 500.0, 42);
    ALTER TABLE t_check DROP COLUMN b;
    INSERT INTO t_check VALUES (2, 99);
    SELECT * FROM t_check;
}
expect {
    1|42
    2|99
}

@cross-check-integrity
test fail-drop-column-table-level-check-constraint {
    CREATE TABLE t_check2 (a INTEGER PRIMARY KEY, b INTEGER, c TEXT, CHECK (b > 0));
    ALTER TABLE t_check2 DROP COLUMN b;
}
expect error {
    error in table t_check2 after drop column: no such column: b
}

@cross-check-integrity
test strict-alter-add-column-invalid-varchar {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b FAKETYPE;
}
expect error {
}

@cross-check-integrity
test strict-alter-add-column-invalid-datetime {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b DATETIME;
}
expect error {
}

@cross-check-integrity
test strict-alter-add-column-no-type {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b;
}
expect error {
}

@cross-check-integrity
test strict-alter-add-column-integer {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b INTEGER;
    INSERT INTO t VALUES(1, 42);
    SELECT a, b FROM t;
}
expect {
    1|42
}

@cross-check-integrity
test strict-alter-add-column-text {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b TEXT;
    INSERT INTO t VALUES(1, 'hello');
    SELECT a, b FROM t;
}
expect {
    1|hello
}

@cross-check-integrity
test strict-alter-add-column-any {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b ANY;
    INSERT INTO t VALUES(1, 3.14);
    SELECT a, b FROM t;
}
expect {
    1|3.14
}

@cross-check-integrity
test strict-alter-add-column-default-type-mismatch {
    CREATE TABLE t1(name TEXT) STRICT;
    INSERT INTO t1 VALUES ('alice'), ('bob');
    ALTER TABLE t1 ADD COLUMN id INTEGER DEFAULT 'corrupted';
}
expect error {
    type mismatch on DEFAULT
}

@cross-check-integrity
test strict-alter-add-column-default-integer-from-text {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b INTEGER DEFAULT '10';
    INSERT INTO t(a) VALUES (1);
    SELECT typeof(b), b FROM t;
}
expect {
    integer|10
}

@cross-check-integrity
test strict-alter-add-column-default-real-from-text {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b REAL DEFAULT '1.25';
    INSERT INTO t(a) VALUES (1);
    SELECT typeof(b), b FROM t;
}
expect {
    real|1.25
}

@cross-check-integrity
test strict-alter-add-column-default-text-from-integer {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b TEXT DEFAULT 123;
    INSERT INTO t(a) VALUES (1);
    SELECT typeof(b), b FROM t;
}
expect {
    text|123
}

@cross-check-integrity
test strict-alter-add-column-default-integer-fractional {
    CREATE TABLE t(a INTEGER) STRICT;
    INSERT INTO t(a) VALUES (1);
    ALTER TABLE t ADD COLUMN b INTEGER DEFAULT 3.14;
}
expect error {
    type mismatch on DEFAULT
}

@cross-check-integrity
test strict-alter-add-column-default-real-nonnumeric {
    CREATE TABLE t(a INTEGER) STRICT;
    INSERT INTO t(a) VALUES (1);
    ALTER TABLE t ADD COLUMN b REAL DEFAULT 'abc';
}
expect error {
    type mismatch on DEFAULT
}

@cross-check-integrity
test strict-alter-add-column-default-text-blob {
    CREATE TABLE t(a INTEGER) STRICT;
    INSERT INTO t(a) VALUES (1);
    ALTER TABLE t ADD COLUMN b TEXT DEFAULT X'CAFE';
}
expect error {
    type mismatch on DEFAULT
}

@cross-check-integrity
test strict-alter-add-column-default-blob-text {
    CREATE TABLE t(a INTEGER) STRICT;
    INSERT INTO t(a) VALUES (1);
    ALTER TABLE t ADD COLUMN b BLOB DEFAULT 'abc';
}
expect error {
    type mismatch on DEFAULT
}

@cross-check-integrity
test strict-alter-add-column-default-mismatch-empty-table {
    CREATE TABLE t(a INTEGER) STRICT;
    ALTER TABLE t ADD COLUMN b INTEGER DEFAULT 3.14;
    INSERT INTO t(a) VALUES (1);
}
expect error {
    cannot store REAL value in INTEGER column t.b
}

@cross-check-integrity
test alter-add-column-invalid-collation {
    CREATE TABLE t(c1 INTEGER);
    ALTER TABLE t ADD COLUMN c2 INTEGER COLLATE compile_options;
}
expect error {
    no such collation sequence: compile_options
}

# https://github.com/tursodatabase/turso/issues/5481
@cross-check-integrity
test fail-alter-table-drop-column-expr-index-substr {
    CREATE TABLE t(a, b, c);
    CREATE INDEX i_expr ON t(substr(b, 1, 1));
    INSERT INTO t VALUES(1, 'bee', 2);
    ALTER TABLE t DROP COLUMN b;
}
expect error {
}

@cross-check-integrity
test fail-alter-table-drop-column-expr-index-arithmetic {
    CREATE TABLE t(a, b, c);
    CREATE INDEX i_expr ON t(a + b);
    ALTER TABLE t DROP COLUMN b;
}
expect error {
}

@cross-check-integrity
test fail-alter-table-drop-column-expr-index-arithmetic-first-col {
    CREATE TABLE t(a, b, c);
    CREATE INDEX i_expr ON t(a + b);
    ALTER TABLE t DROP COLUMN a;
}
expect error {
}

@cross-check-integrity
test alter-table-drop-column-expr-index-unreferenced {
    CREATE TABLE t(a, b, c);
    CREATE INDEX i_expr ON t(substr(b, 1, 1));
    INSERT INTO t VALUES(1, 'bee', 2);
    ALTER TABLE t DROP COLUMN c;
    SELECT * FROM t;
}
expect {
    1|bee
}

@cross-check-integrity
test fail-alter-table-drop-column-expr-index-multi-col {
    CREATE TABLE t(a, b, c);
    CREATE INDEX i_expr ON t(a + c, substr(b, 1, 1));
    ALTER TABLE t DROP COLUMN b;
}
expect error {
}

