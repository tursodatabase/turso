@database :memory:

# https://github.com/tursodatabase/turso/issues/3966
@cross-check-integrity
test not-null-just-cuz-unique {
    create table t (a int, x int unique);
    insert into t(a) values(1);
    select * from t;
}
expect {
    1|
}

# Regression tests for NULL comparison with index scans
# Any comparison with NULL should return 0 rows because NULL comparisons
# always return NULL (unknown), which is falsy.

# Ascending index: x > NULL should return 0 rows
@cross-check-integrity
test null-comparison-asc-gt {
    CREATE TABLE t1(x);
    CREATE INDEX t1_idx ON t1(x ASC);
    INSERT INTO t1 VALUES (1), (2), (3);
    SELECT * FROM t1 WHERE x > NULL;
}
expect {
}

# Descending index: x > NULL should return 0 rows
@cross-check-integrity
test null-comparison-desc-gt {
    CREATE TABLE t2(x);
    CREATE INDEX t2_idx ON t2(x DESC);
    INSERT INTO t2 VALUES (1), (2), (3);
    SELECT * FROM t2 WHERE x > NULL;
}
expect {
}

# Ascending index: x < NULL should return 0 rows
@cross-check-integrity
test null-comparison-asc-lt {
    CREATE TABLE t3(x);
    CREATE INDEX t3_idx ON t3(x ASC);
    INSERT INTO t3 VALUES (1), (2), (3);
    SELECT * FROM t3 WHERE x < NULL;
}
expect {
}

# Descending index: x < NULL should return 0 rows
@cross-check-integrity
test null-comparison-desc-lt {
    CREATE TABLE t4(x);
    CREATE INDEX t4_idx ON t4(x DESC);
    INSERT INTO t4 VALUES (1), (2), (3);
    SELECT * FROM t4 WHERE x < NULL;
}
expect {
}

# Ascending index: x >= NULL should return 0 rows
@cross-check-integrity
test null-comparison-asc-ge {
    CREATE TABLE t5(x);
    CREATE INDEX t5_idx ON t5(x ASC);
    INSERT INTO t5 VALUES (1), (2), (3);
    SELECT * FROM t5 WHERE x >= NULL;
}
expect {
}

# Descending index: x >= NULL should return 0 rows
@cross-check-integrity
test null-comparison-desc-ge {
    CREATE TABLE t6(x);
    CREATE INDEX t6_idx ON t6(x DESC);
    INSERT INTO t6 VALUES (1), (2), (3);
    SELECT * FROM t6 WHERE x >= NULL;
}
expect {
}

# Ascending index: x <= NULL should return 0 rows
@cross-check-integrity
test null-comparison-asc-le {
    CREATE TABLE t7(x);
    CREATE INDEX t7_idx ON t7(x ASC);
    INSERT INTO t7 VALUES (1), (2), (3);
    SELECT * FROM t7 WHERE x <= NULL;
}
expect {
}

# Descending index: x <= NULL should return 0 rows
@cross-check-integrity
test null-comparison-desc-le {
    CREATE TABLE t8(x);
    CREATE INDEX t8_idx ON t8(x DESC);
    INSERT INTO t8 VALUES (1), (2), (3);
    SELECT * FROM t8 WHERE x <= NULL;
}
expect {
}

# Descending index with ORDER BY: x > NULL should return 0 rows
@cross-check-integrity
test null-comparison-desc-order-by {
    CREATE TABLE t9(x);
    CREATE INDEX t9_idx ON t9(x DESC);
    INSERT INTO t9 VALUES (1), (2), (3);
    SELECT * FROM t9 WHERE x > NULL ORDER BY x DESC;
}
expect {
}

# Composite index: NULL in second column should not match range comparisons
# https://github.com/tursodatabase/turso/issues/5358
@cross-check-integrity
test composite-index-null-second-col-le {
    CREATE TABLE t10(c1 TEXT, c2 TEXT);
    CREATE INDEX t10_idx ON t10(c2, c1);
    INSERT INTO t10(c2) VALUES ('a'), ('a');
    SELECT * FROM t10 WHERE c2 = 'a' AND c1 <= 999;
}
expect {
}

@cross-check-integrity
test composite-index-null-second-col-lt {
    CREATE TABLE t11(c1 TEXT, c2 TEXT);
    CREATE INDEX t11_idx ON t11(c2, c1);
    INSERT INTO t11(c2) VALUES ('a'), ('a');
    SELECT * FROM t11 WHERE c2 = 'a' AND c1 < 999;
}
expect {
}

@cross-check-integrity
test composite-index-null-second-col-ge {
    CREATE TABLE t12(c1 TEXT, c2 TEXT);
    CREATE INDEX t12_idx ON t12(c2, c1);
    INSERT INTO t12(c2) VALUES ('a'), ('a');
    SELECT * FROM t12 WHERE c2 = 'a' AND c1 >= 0;
}
expect {
}

@cross-check-integrity
test composite-index-null-second-col-le-desc {
    CREATE TABLE t12d(c1 TEXT, c2 TEXT);
    CREATE INDEX t12d_idx ON t12d(c2, c1 DESC);
    INSERT INTO t12d(c2) VALUES ('a'), ('a');
    SELECT * FROM t12d WHERE c2 = 'a' AND c1 <= 999;
}
expect {
}

@cross-check-integrity
test composite-index-null-second-col-lt-desc {
    CREATE TABLE t12e(c1 TEXT, c2 TEXT);
    CREATE INDEX t12e_idx ON t12e(c2, c1 DESC);
    INSERT INTO t12e(c2) VALUES ('a'), ('a');
    SELECT * FROM t12e WHERE c2 = 'a' AND c1 < 999;
}
expect {
}

@cross-check-integrity
test composite-index-null-second-col-gt {
    CREATE TABLE t13(c1 TEXT, c2 TEXT);
    CREATE INDEX t13_idx ON t13(c2, c1);
    INSERT INTO t13(c2) VALUES ('a'), ('a');
    SELECT * FROM t13 WHERE c2 = 'a' AND c1 > 0;
}
expect {
}

# Composite index with mixed NULL and non-NULL values
@cross-check-integrity
test composite-index-mixed-null-nonnull {
    CREATE TABLE t14(c1 TEXT, c2 TEXT);
    CREATE INDEX t14_idx ON t14(c2, c1);
    INSERT INTO t14(c2) VALUES ('a'), ('a');
    INSERT INTO t14 VALUES ('abc', 'a'), ('def', 'a');
    SELECT c1, c2 FROM t14 WHERE c2 = 'a' AND c1 <= 'zzz';
}
expect {
    abc|a
    def|a
}

# Regression for simulator seed 16218053103538286000:
# a prefix-only equality probe on the first column of a composite index must not
# synthesize an extra NULL key component (that previously caused an OOB panic).
@cross-check-integrity
test composite-index-prefix-eq-no-range-no-crash {
    CREATE TABLE t15(a INT, b INT);
    CREATE INDEX t15_idx ON t15(a DESC, b ASC);
    INSERT INTO t15 VALUES (1, NULL), (1, 20), (2, 30);
    SELECT a, b FROM t15 WHERE a = 1 LIMIT 4;
}
expect {
    1|
    1|20
}

