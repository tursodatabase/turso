@database :memory:

@cross-check-integrity
test min-null-regression-test {
    CREATE TABLE t (a);
    INSERT INTO t VALUES ('abc'), (NULL);
    SELECT min(a) FROM t;
}
expect {
    abc
}

@cross-check-integrity
test max-null-regression-test {
    CREATE TABLE t (a);
    INSERT INTO t VALUES ('abc'), (NULL);
    SELECT max(a) FROM t;
}
expect {
    abc
}

@cross-check-integrity
test group-concat-null-values-test {
    CREATE TABLE t (a);
    INSERT INTO t VALUES ('a'), (''), ('b'), (NULL), ('c');
    SELECT group_concat(a) FROM t;
}
expect {
    a,,b,c
}

@cross-check-integrity
test select-distinct-aggregate-ungrouped {
    CREATE TABLE t0 (c0 REAL);
  CREATE TABLE t1 (c0 INT);
  INSERT INTO t0 VALUES (1.0), (2.0);
  INSERT INTO t1 VALUES (1), (2);
  SELECT DISTINCT COUNT(t0.c0) FROM t0, t1;
}
expect {
    4
}

# Tests for ungrouped aggregates with non-aggregate columns on empty tables.
# When no rows match, literals should return their values, columns should return NULL,
# and expressions like "col IS NOT NULL" should evaluate correctly.

@cross-check-integrity
test ungrouped-agg-empty-table-literal {
    CREATE TABLE t (a INT, b TEXT);
    SELECT 42, COUNT(*), 'hello' FROM t;
}
expect {
    42|0|hello
}

@cross-check-integrity
test ungrouped-agg-empty-table-column-is-null {
    CREATE TABLE t (a INT);
    SELECT a IS NULL, COUNT(*) FROM t;
}
expect {
    1|0
}

@cross-check-integrity
test ungrouped-agg-empty-table-column-is-not-null {
    CREATE TABLE t (a INT);
    SELECT a IS NOT NULL, COUNT(*) FROM t;
}
expect {
    0|0
}

@cross-check-integrity
test ungrouped-agg-filtered-rows-literal {
    CREATE TABLE t (a INT);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT 99, COUNT(*) FROM t WHERE a > 100;
}
expect {
    99|0
}

@cross-check-integrity
test ungrouped-agg-filtered-rows-column {
    CREATE TABLE t (a INT);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT a, COUNT(*) FROM t WHERE a > 100;
}
expect {
    |0
}

@cross-check-integrity
test ungrouped-agg-multiple-literals {
    CREATE TABLE t (a INT);
    SELECT NULL, 5267713247558720570, NULL, AVG(-1), 28513758867889096 FROM t;
}
expect {
    |5267713247558720570|||28513758867889096
}

# Regression test: columns with DEFAULT values should return NULL (not the default)
# when the table is empty and we're in an aggregate query context.
@cross-check-integrity
test ungrouped-agg-empty-table-column-with-default {
    CREATE TABLE t (x BLOB NOT NULL DEFAULT X'00');
    SELECT x IS NULL, typeof(x), hex(x), AVG(1) FROM t;
}
expect {
    1|null||
}

@cross-check-integrity
test case-when-aggregate-returns-column-value {
    CREATE TABLE t1(a INTEGER, b TEXT);
    INSERT INTO t1 VALUES (42, 'hello');
    SELECT CASE WHEN SUM(1) THEN a ELSE b END FROM t1;
}
expect {
    42
}

