@database :memory:

# ============================================================================
# RETURNING should NOT emit rows when FK constraint violation causes rollback
# See: https://github.com/tursodatabase/turso/issues/5491
# ============================================================================

# --- INSERT FK violation with RETURNING ---

@cross-check-integrity
test insert-fk-violation-returning-star {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY, name TEXT);
    CREATE TABLE child(id INTEGER PRIMARY KEY, parent_id INTEGER REFERENCES parent(id), val TEXT);
    INSERT INTO parent VALUES(1, 'p1');
    INSERT INTO child VALUES(2, 999, 'c2') RETURNING *;
}
expect error {
}

@cross-check-integrity
test insert-fk-violation-returning-specific-cols {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY);
    CREATE TABLE child(id INTEGER PRIMARY KEY, pid INTEGER REFERENCES parent(id));
    INSERT INTO child VALUES(1, 42) RETURNING id, pid;
}
expect error {
}

# --- DELETE FK violation with RETURNING ---

@cross-check-integrity
test delete-fk-violation-returning-star {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY, name TEXT);
    CREATE TABLE child(id INTEGER PRIMARY KEY, parent_id INTEGER REFERENCES parent(id), val TEXT);
    INSERT INTO parent VALUES(1, 'p1');
    INSERT INTO child VALUES(1, 1, 'c1');
    DELETE FROM parent WHERE id = 1 RETURNING *;
}
expect error {
}

@cross-check-integrity
test delete-fk-violation-returning-specific-cols {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY, name TEXT);
    CREATE TABLE child(id INTEGER PRIMARY KEY, parent_id INTEGER REFERENCES parent(id));
    INSERT INTO parent VALUES(1, 'p1');
    INSERT INTO child VALUES(1, 1);
    DELETE FROM parent WHERE id = 1 RETURNING id;
}
expect error {
}

# --- UPDATE FK violation with RETURNING ---

@cross-check-integrity
test update-fk-violation-returning-star {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY);
    CREATE TABLE child(id INTEGER PRIMARY KEY, pid INTEGER REFERENCES parent(id));
    INSERT INTO parent VALUES(1);
    INSERT INTO child VALUES(1, 1);
    UPDATE child SET pid = 999 WHERE id = 1 RETURNING *;
}
expect error {
}

@cross-check-integrity
test update-fk-violation-returning-specific-cols {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY);
    CREATE TABLE child(id INTEGER PRIMARY KEY, pid INTEGER REFERENCES parent(id));
    INSERT INTO parent VALUES(1);
    INSERT INTO child VALUES(1, 1);
    UPDATE child SET pid = 999 WHERE id = 1 RETURNING id;
}
expect error {
}

# --- Valid operations still produce RETURNING output ---

@cross-check-integrity
test insert-fk-ok-returning {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY, name TEXT);
    CREATE TABLE child(id INTEGER PRIMARY KEY, parent_id INTEGER REFERENCES parent(id), val TEXT);
    INSERT INTO parent VALUES(1, 'p1');
    INSERT INTO child VALUES(1, 1, 'c1') RETURNING *;
}
expect {
    1|1|c1
}

@cross-check-integrity
test delete-fk-ok-returning {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY, name TEXT);
    INSERT INTO parent VALUES(1, 'p1');
    INSERT INTO parent VALUES(2, 'p2');
    DELETE FROM parent WHERE id = 2 RETURNING *;
}
expect {
    2|p2
}

@cross-check-integrity
test update-fk-ok-returning {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY);
    CREATE TABLE child(id INTEGER PRIMARY KEY, pid INTEGER REFERENCES parent(id));
    INSERT INTO parent VALUES(1);
    INSERT INTO child VALUES(1, 1);
    UPDATE child SET pid = 1 WHERE id = 1 RETURNING *;
}
expect {
    1|1
}

# --- Multi-row INSERT with FK violation: no rows should be returned ---

@cross-check-integrity
test insert-multi-row-fk-violation-returning {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY);
    CREATE TABLE child(id INTEGER PRIMARY KEY, pid INTEGER REFERENCES parent(id));
    INSERT INTO parent VALUES(1);
    INSERT INTO child VALUES(1, 1), (2, 999) RETURNING *;
}
expect error {
}

# --- FK violation with NULL child value (allowed, should return rows) ---

@cross-check-integrity
test insert-fk-null-child-returning {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY);
    CREATE TABLE child(id INTEGER PRIMARY KEY, pid INTEGER REFERENCES parent(id));
    INSERT INTO child VALUES(1, NULL) RETURNING *;
}
expect {
    1|
}

# --- Data integrity: rolled back rows should not persist ---

@cross-check-integrity
test insert-fk-violation-no-persist {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY);
    CREATE TABLE child(id INTEGER PRIMARY KEY, pid INTEGER REFERENCES parent(id));
    INSERT INTO parent VALUES(1);
    INSERT INTO child VALUES(1, 1);
    INSERT OR ABORT INTO child VALUES(2, 999);
    SELECT * FROM child;
}
expect error {
}

@cross-check-integrity
test delete-fk-violation-no-persist {
    PRAGMA foreign_keys = ON;
    CREATE TABLE parent(id INTEGER PRIMARY KEY, name TEXT);
    CREATE TABLE child(id INTEGER PRIMARY KEY, parent_id INTEGER REFERENCES parent(id));
    INSERT INTO parent VALUES(1, 'p1');
    INSERT INTO child VALUES(1, 1);
    DELETE FROM parent WHERE id = 1;
    SELECT * FROM parent;
}
expect error {
}
