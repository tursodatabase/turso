---
source: aggregation.sqltest
expression: |-
  SELECT
          category,
          region,
          SUM(amount) as total_sales,
          COUNT(*) as num_transactions
      FROM
          sales
      GROUP BY
          category,
          region
      ORDER BY
          category,
          region;
info:
  statement_type: SELECT
  tables:
  - sales
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
`--SCAN sales USING INDEX idx_sales_category

BYTECODE
addr  opcode                  p1  p2  p3  p4                    p5  comment
   0          Init             0  53   0                         0  Start at 53
   1          Null             0  12  13                         0  r[12..13]=NULL
   2          SorterOpen       0   3   0  k(2,B,B)               0  cursor=0
   3          Integer          0   7   0                         0  r[7]=0; clear group by abort flag
   4          Null             0   8   9                         0  r[8..9]=NULL; initialize group by comparison registers to NULL
   5          Gosub           18  49   0                         0  ; go to clear accumulator subroutine
   6          OpenRead         2   2   0  k(7,B,B,B,B,B,B,B)     0  table=sales, root=2, iDb=0
   7          OpenRead         3   4   0  k(2,B)                 0  index=idx_sales_category, root=4, iDb=0
   8          Rewind           3  16   0                         0  Rewind index idx_sales_category
   9            DeferredSeek   3   2   0                         0
  10            Column         2   1  15                         0  r[15]=sales.category
  11            Column         2   2  16                         0  r[16]=sales.region
  12            Column         2   4  17                         0  r[17]=sales.amount
  13            MakeRecord    15   3  14                         0  r[14]=mkrec(r[15..17])
  14            SorterInsert   0  14   0  0                      0  key=r[14]
  15          Next             3   9   0                         0
  16          OpenPseudo       1  14   3                         0  3 columns in r[14]
  17          SorterSort       0  35   0                         0
  18            SorterData     0  14   1                         0  r[14]=data
  19            Column         1   0  19                         0  r[19]=pseudo.column 0
  20            Column         1   1  20                         0  r[20]=pseudo.column 1
  21            Compare        8  19   2  k(2, Binary, Binary)   0  r[8..9]==r[19..20]
  22            Jump          23  27  23                         0  ; start new group if comparison is not equal
  23            Gosub          5  39   0                         0  ; check if ended group had data, and output if so
  24            Move          19   8   2                         0  r[8..9]=r[19..20]
  25            IfPos          7  52   0                         0  r[7]>0 -> r[7]-=0, goto 52; check abort flag
  26            Gosub         18  49   0                         0  ; goto clear accumulator subroutine
  27            Column         1   2  21                         0  r[21]=pseudo.column 2
  28            AggStep        0  21  12  sum                    0  accum=r[12] step(r[21])
  29            AggStep        0  22  13  count                  0  accum=r[13] step(r[22])
  30            If             6  33   0                         0  if r[6] goto 33; don't emit group columns if continuing existing group
  31            Column         1   0  10                         0  r[10]=pseudo.column 0
  32            Column         1   1  11                         0  r[11]=pseudo.column 1
  33            Integer        1   6   0                         0  r[6]=1; indicate data in accumulator
  34          SorterNext       0  18   0                         0
  35          Gosub            5  39   0                         0  ; emit row for final group
  36          Goto             0  52   0                         0  ; group by finished
  37          Integer          1   7   0                         0  r[7]=1
  38        Return             5   0   0                         0
  39        IfPos              6  41   0                         0  r[6]>0 -> r[6]-=0, goto 41; output group by row subroutine start
  40      Return               5   0   0                         0
  41      AggFinal             0  12   0  sum                    0  accum=r[12]
  42      AggFinal             0  13   0  count                  0  accum=r[13]
  43      Copy                10   1   0                         0  r[1]=r[10]
  44      Copy                11   2   0                         0  r[2]=r[11]
  45      Copy                12   3   0                         0  r[3]=r[12]
  46      Copy                13   4   0                         0  r[4]=r[13]
  47      ResultRow            1   4   0                         0  output=r[1..4]
  48    Return                 5   0   0                         0
  49    Null                   0  10  13                         0  r[10..13]=NULL; clear accumulator subroutine start
  50    Integer                0   6   0                         0  r[6]=0
  51  Return                  18   0   0                         0
  52  Halt                     0   0   0                         0
  53  Transaction              0   1   8                         0  iDb=0 tx_mode=Read
  54  Integer                  1  22   0                         0  r[22]=1
  55  Goto                     0   1   0                         0
