---
source: aggregation.sqltest
expression: "SELECT\n        p.category,\n        COUNT(DISTINCT o.customer_id) as unique_customers,\n        COUNT(DISTINCT o.order_id) as total_orders\n    FROM\n        products p\n        INNER JOIN orders o ON p.product_id = o.product_id\n    GROUP BY\n        p.category\n    ORDER BY\n        unique_customers DESC;"
info:
  statement_type: SELECT
  tables:
    - orders
    - p.product_id
    - products
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
|--SEARCH p USING INTEGER PRIMARY KEY (rowid=?)
|--SCAN orders AS o
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                          p1  p2  p3  p4                p5  comment
   0          Init                     0  66   0                     0  Start at 66
   1          SorterOpen               0   1   0  k(1,-B)            0  cursor=0
   2          Null                     0  10  11                     0  r[10..11]=NULL
   3          SorterOpen               1   3   0  k(1,-B)            0  cursor=1
   4          Integer                  0   7   0                     0  r[7]=0; clear group by abort flag
   5          Null                     0   8   0                     0  r[8]=NULL; initialize group by comparison registers to NULL
   6          Gosub                   16  52   0                     0  ; go to clear accumulator subroutine
   7          OpenRead                 3   6   0  k(4,B,B,B,B)       0  table=products, root=6, iDb=0
   8          OpenRead                 4   7   0  k(6,B,B,B,B,B,B)   0  table=orders, root=7, iDb=0
   9          Rewind                   4  18   0                     0  Rewind table orders
  10            Column                 4   2  17                     0  r[17]=orders.product_id
  11            SeekRowid              3  17  17                     0  if (r[17]!=cursor 3 for table products.rowid) goto 17
  12            Column                 3   2  13                     0  r[13]=products.category
  13            Column                 4   1  14                     0  r[14]=orders.customer_id
  14            RowId                  4  15   0                     0  r[15]=orders.rowid
  15            MakeRecord            13   3  12                     0  r[12]=mkrec(r[13..15])
  16            SorterInsert           1  12   0  0                  0  key=r[12]
  17          Next                     4  10   0                     0
  18          OpenPseudo               2  12   3                     0  3 columns in r[12]
  19          SorterSort               1  38   0                     0
  20            SorterData             1  12   2                     0  r[12]=data
  21            Column                 2   0  18                     0  r[18]=pseudo.column 0
  22            Compare                8  18   1  k(1, Binary)       0  r[8..8]==r[18..18]
  23            Jump                  24  28  24                     0  ; start new group if comparison is not equal
  24            Gosub                  5  42   0                     0  ; check if ended group had data, and output if so
  25            Move                  18   8   1                     0  r[8..8]=r[18..18]
  26            IfPos                  7  57   0                     0  r[7]>0 -> r[7]-=0, goto 57; check abort flag
  27            Gosub                 16  52   0                     0  ; goto clear accumulator subroutine
  28            Column                 2   1  19                     0  r[19]=pseudo.column 1
  29            HashDistinct  1073741824  19   1  jmp=31             0
  30            AggStep                0  19  10  count              0  accum=r[10] step(r[19])
  31            Column                 2   2  20                     0  r[20]=pseudo.column 2
  32            HashDistinct  1073741825  20   1  jmp=34             0
  33            AggStep                0  20  11  count              0  accum=r[11] step(r[20])
  34            If                     6  36   0                     0  if r[6] goto 36; don't emit group columns if continuing existing group
  35            Column                 2   0   9                     0  r[9]=pseudo.column 0
  36            Integer                1   6   0                     0  r[6]=1; indicate data in accumulator
  37          SorterNext               1  20   0                     0
  38          Gosub                    5  42   0                     0  ; emit row for final group
  39          Goto                     0  57   0                     0  ; group by finished
  40          Integer                  1   7   0                     0  r[7]=1
  41        Return                     5   0   0                     0
  42        IfPos                      6  44   0                     0  r[6]>0 -> r[6]-=0, goto 44; output group by row subroutine start
  43      Return                       5   0   0                     0
  44      AggFinal                     0  10   0  count              0  accum=r[10]
  45      AggFinal                     0  11   0  count              0  accum=r[11]
  46      Copy                        10  21   0                     0  r[21]=r[10]
  47      Copy                         9  22   0                     0  r[22]=r[9]
  48      Copy                        11  23   0                     0  r[23]=r[11]
  49      MakeRecord                  21   3   4                     0  r[4]=mkrec(r[21..23])
  50      SorterInsert                 0   4   0  0                  0  key=r[4]
  51    Return                         5   0   0                     0
  52    Null                           0   9  11                     0  r[9..11]=NULL; clear accumulator subroutine start
  53    HashClear             1073741824   0   0                     0
  54    HashClear             1073741825   0   0                     0
  55    Integer                        0   6   0                     0  r[6]=0
  56  Return                          16   0   0                     0
  57  OpenPseudo                       5   4   3                     0  3 columns in r[4]
  58  SorterSort                       0  65   0                     0
  59    SorterData                     0   4   5                     0  r[4]=data
  60    Column                         5   1   1                     0  r[1]=pseudo.column 1
  61    Column                         5   0   2                     0  r[2]=pseudo.column 0
  62    Column                         5   2   3                     0  r[3]=pseudo.column 2
  63    ResultRow                      1   3   0                     0  output=r[1..3]
  64  SorterNext                       0  59   0                     0
  65  Halt                             0   0   0                     0
  66  Transaction                      0   1   8                     0  iDb=0 tx_mode=Read
  67  Goto                             0   1   0                     0
