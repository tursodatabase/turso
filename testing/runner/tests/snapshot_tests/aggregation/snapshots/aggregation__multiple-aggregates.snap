---
source: aggregation.sqltest
expression: "SELECT\n        category,\n        COUNT(*) as transaction_count,\n        SUM(amount) as total_amount,\n        AVG(amount) as avg_amount,\n        SUM(quantity) as total_quantity,\n        AVG(quantity) as avg_quantity\n    FROM\n        sales\n    GROUP BY\n        category\n    ORDER BY\n        total_amount DESC;"
info:
  statement_type: SELECT
  tables:
    - sales
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
|--SCAN sales USING INDEX idx_sales_category
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                  p1  p2  p3  p4                  p5  comment
   0          Init             0  65   0                       0  Start at 65
   1          SorterOpen       0   1   0  k(1,-B)              0  cursor=0
   2          Null             0  13  17                       0  r[13..17]=NULL
   3          Integer          0  10   0                       0  r[10]=0; clear group by abort flag
   4          Null             0  11   0                       0  r[11]=NULL; initialize group by comparison registers to NULL
   5          Gosub           24  50   0                       0  ; go to clear accumulator subroutine
   6          OpenRead         1   2   0  k(7,B,B,B,B,B,B,B)   0  table=sales, root=2, iDb=0
   7          OpenRead         2   4   0  k(2,B)               0  index=idx_sales_category, root=4, iDb=0
   8          Rewind           2  30   0                       0  Rewind index idx_sales_category
   9            DeferredSeek   2   1   0                       0
  10            Column         1   1  19                       0  r[19]=sales.category
  11            Column         1   4  20                       0  r[20]=sales.amount
  12            Column         1   4  21                       0  r[21]=sales.amount
  13            Column         1   5  22                       0  r[22]=sales.quantity
  14            Column         1   5  23                       0  r[23]=sales.quantity
  15            Compare       11  19   1  k(1, Binary)         0  r[11..11]==r[19..19]
  16            Jump          17  21  17                       0  ; start new group if comparison is not equal
  17            Gosub          8  34   0                       0  ; check if ended group had data, and output if so
  18            Move          19  11   1                       0  r[11..11]=r[19..19]
  19            IfPos         10  53   0                       0  r[10]>0 -> r[10]-=0, goto 53; check abort flag
  20            Gosub         24  50   0                       0  ; goto clear accumulator subroutine
  21            AggStep        0  25  13  count                0  accum=r[13] step(r[25])
  22            AggStep        0  20  14  sum                  0  accum=r[14] step(r[20])
  23            AggStep        0  21  15  avg                  0  accum=r[15] step(r[21])
  24            AggStep        0  22  16  sum                  0  accum=r[16] step(r[22])
  25            AggStep        0  23  17  avg                  0  accum=r[17] step(r[23])
  26            If             9  28   0                       0  if r[9] goto 28; don't emit group columns if continuing existing group
  27            Column         1   1  12                       0  r[12]=sales.category
  28            Integer        1   9   0                       0  r[9]=1; indicate data in accumulator
  29          Next             2   9   0                       0
  30          Gosub            8  34   0                       0  ; emit row for final group
  31          Goto             0  53   0                       0  ; group by finished
  32          Integer          1  10   0                       0  r[10]=1
  33        Return             8   0   0                       0
  34        IfPos              9  36   0                       0  r[9]>0 -> r[9]-=0, goto 36; output group by row subroutine start
  35      Return               8   0   0                       0
  36      AggFinal             0  13   0  count                0  accum=r[13]
  37      AggFinal             0  14   0  sum                  0  accum=r[14]
  38      AggFinal             0  15   0  avg                  0  accum=r[15]
  39      AggFinal             0  16   0  sum                  0  accum=r[16]
  40      AggFinal             0  17   0  avg                  0  accum=r[17]
  41      Copy                14  26   0                       0  r[26]=r[14]
  42      Copy                12  27   0                       0  r[27]=r[12]
  43      Copy                13  28   0                       0  r[28]=r[13]
  44      Copy                15  29   0                       0  r[29]=r[15]
  45      Copy                16  30   0                       0  r[30]=r[16]
  46      Copy                17  31   0                       0  r[31]=r[17]
  47      MakeRecord          26   6   7                       0  r[7]=mkrec(r[26..31])
  48      SorterInsert         0   7   0  0                    0  key=r[7]
  49    Return                 8   0   0                       0
  50    Null                   0  12  17                       0  r[12..17]=NULL; clear accumulator subroutine start
  51    Integer                0   9   0                       0  r[9]=0
  52  Return                  24   0   0                       0
  53  OpenPseudo               3   7   6                       0  6 columns in r[7]
  54  SorterSort               0  64   0                       0
  55    SorterData             0   7   3                       0  r[7]=data
  56    Column                 3   1   1                       0  r[1]=pseudo.column 1
  57    Column                 3   2   2                       0  r[2]=pseudo.column 2
  58    Column                 3   0   3                       0  r[3]=pseudo.column 0
  59    Column                 3   3   4                       0  r[4]=pseudo.column 3
  60    Column                 3   4   5                       0  r[5]=pseudo.column 4
  61    Column                 3   5   6                       0  r[6]=pseudo.column 5
  62    ResultRow              1   6   0                       0  output=r[1..6]
  63  SorterNext               0  55   0                       0
  64  Halt                     0   0   0                       0
  65  Transaction              0   1   8                       0  iDb=0 tx_mode=Read
  66  Integer                  1  25   0                       0  r[25]=1
  67  Goto                     0   1   0                       0
