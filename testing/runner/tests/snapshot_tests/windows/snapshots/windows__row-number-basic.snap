---
source: windows.sqltest
expression: |-
  SELECT
          emp_id,
          name,
          department,
          salary,
          ROW_NUMBER() OVER (ORDER BY salary DESC) AS salary_rank
      FROM employees;
info:
  statement_type: SELECT
  tables:
  - employees
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
`--SCAN window_subquery_0
   `--SCAN employees USING INDEX idx_employees_salary

BYTECODE
addr  opcode            p1  p2  p3  p4                     p5  comment
   0    Init             0  49   0                          0  Start at 49
   1    InitCoroutine    1  13   2                          0
   2    OpenRead         0   2   0  k(5,B,B,B,B,B)          0  table=employees, root=2, iDb=0
   3    OpenRead         1   5   0  k(2,B)                  0  index=idx_employees_salary, root=5, iDb=0
   4    Last             1  12   0                          0
   5      DeferredSeek   1   0   0                          0
   6      Column         0   3   2                          0  r[2]=employees.salary
   7      IdxRowId       1   3   0                          0  r[3]=cursor 1 for index idx_employees_salary.rowid
   8      Column         0   1   4                          0  r[4]=employees.name
   9      Column         0   2   5                          0  r[5]=employees.department
  10      Yield          1   0   0                          0
  11    Prev             1   5   0                          0
  12    EndCoroutine     1   0   0                          0
  13    OpenEphemeral    2   1   0                          0  cursor=2 is_table=true
  14    OpenDup          3   2   0                          0  new_cursor=3, original_cursor=2
  15    Null             0  17   0                          0  r[17]=NULL
  16    InitCoroutine    1   0   2                          0
  17      Yield          1  31   0                          0
  18      Copy           2  20   0                          0  r[20]=r[2]
  19      NotNull       17  23   0                          0  r[17]!=NULL -> goto 23
  20      Copy          20  19   0                          0  r[19]=r[20]; initialize previous peer register for new partition
  21      Null           0  11  11                          0  r[11..11]=NULL; reset accumulator registers
  22      Integer        0  11   0                          0  r[11]=0
  23      Compare       19  20   1  k(1, Binary)            0  r[19..19]==r[20..20]; compare ORDER BY columns to detect peer
  24      Jump          25  27  25                          0
  25      Gosub         18  32   0                          0  ; detected non-peer row
  26      Copy          20  19   0                          0  r[19]=r[20]
  27      MakeRecord     2   4  21                          0  r[21]=mkrec(r[2..5])
  28      NewRowid       3  17   0                          0  r[17]=rowid
  29      Insert         3  21  17  buffer_table_window_0   0  intkey=r[17] data=r[21]
  30    Goto             0  17   0                          0
  31    Null             0  18   0                          0  r[18]=NULL; return remaining buffered rows
  32    Rewind           2  46   0                          0  Rewind  ephemeral(buffer_table_window_0)
  33      Column         2   1  13                          0  r[13]=ephemeral(buffer_table_window_0).emp_id
  34      Column         2   2  14                          0  r[14]=ephemeral(buffer_table_window_0).name
  35      Column         2   3  15                          0  r[15]=ephemeral(buffer_table_window_0).department
  36      Column         2   0  16                          0  r[16]=ephemeral(buffer_table_window_0).salary
  37      AddImm        11   1   0                          0  r[11]=r[11]+1
  38      Copy          11  12   0                          0  r[12]=r[11]
  39      Copy          13   6   0                          0  r[6]=r[13]
  40      Copy          14   7   0                          0  r[7]=r[14]
  41      Copy          15   8   0                          0  r[8]=r[15]
  42      Copy          16   9   0                          0  r[9]=r[16]
  43      Copy          12  10   0                          0  r[10]=r[12]
  44      ResultRow      6   5   0                          0  output=r[6..10]
  45    Next             2  33   0                          0
  46    ResetSorter      2   0   0                          0  cursor=2
  47  Return            18   0   1                          0
  48  Halt               0   0   0                          0
  49  Transaction        0   1   7                          0  iDb=0 tx_mode=Read
  50  Goto               0   1   0                          0
