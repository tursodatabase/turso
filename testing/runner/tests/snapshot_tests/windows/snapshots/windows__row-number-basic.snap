---
source: windows.sqltest
expression: |-
  SELECT
          emp_id,
          name,
          department,
          salary,
          ROW_NUMBER() OVER (ORDER BY salary DESC) AS salary_rank
      FROM employees;
info:
  statement_type: SELECT
  tables:
  - employees
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
`--SCAN window_subquery_0
   `--SCAN employees USING INDEX idx_employees_salary

BYTECODE
addr  opcode            p1  p2  p3  p4                     p5  comment
   0    Init             0  50   0                          0  Start at 50
   1    InitCoroutine    1  13   2                          0
   2    OpenRead         0   2   0  k(5,B,B,B,B,B)          0  table=employees, root=2, iDb=0
   3    OpenRead         1   5   0  k(2,B)                  0  index=idx_employees_salary, root=5, iDb=0
   4    Last             1  12   0                          0
   5      DeferredSeek   1   0   0                          0
   6      Column         0   3   2                          0  r[2]=employees.salary
   7      IdxRowId       1   3   0                          0  r[3]=cursor 1 for index idx_employees_salary.rowid
   8      Column         0   1   4                          0  r[4]=employees.name
   9      Column         0   2   5                          0  r[5]=employees.department
  10      Yield          1   0   0                          0
  11    Prev             1   5   0                          0
  12    EndCoroutine     1   0   0                          0
  13    OpenEphemeral    2   1   0                          0  cursor=2 is_table=true
  14    OpenDup          3   2   0                          0  new_cursor=3, original_cursor=2
  15    Null             0  17   0                          0  r[17]=NULL
  16    Null             0  18   0                          0  r[18]=NULL
  17    InitCoroutine    1   0   2                          0
  18      Yield          1  32   0                          0
  19      Copy           2  21   0                          0  r[21]=r[2]
  20      NotNull       17  24   0                          0  r[17]!=NULL -> goto 24
  21      Copy          21  20   0                          0  r[20]=r[21]; initialize previous peer register for new partition
  22      Null           0  11  11                          0  r[11..11]=NULL; reset accumulator registers
  23      Integer        0  18   0                          0  r[18]=0
  24      Compare       20  21   1  k(1, Binary)            0  r[20..20]==r[21..21]; compare ORDER BY columns to detect peer
  25      Jump          26  28  26                          0
  26      Gosub         19  33   0                          0  ; detected non-peer row
  27      Copy          21  20   0                          0  r[20]=r[21]
  28      MakeRecord     2   4  22                          0  r[22]=mkrec(r[2..5])
  29      NewRowid       3  17   0                          0  r[17]=rowid
  30      Insert         3  22  17  buffer_table_window_0   0  intkey=r[17] data=r[22]
  31    Goto             0  18   0                          0
  32    Null             0  19   0                          0  r[19]=NULL; return remaining buffered rows
  33    Rewind           2  47   0                          0  Rewind  buffer_table_window_0
  34      Column         2   1  13                          0  r[13]=buffer_table_window_0.emp_id
  35      Column         2   2  14                          0  r[14]=buffer_table_window_0.name
  36      Column         2   3  15                          0  r[15]=buffer_table_window_0.department
  37      Column         2   0  16                          0  r[16]=buffer_table_window_0.salary
  38      AddImm        18   1   0                          0  r[18]=r[18]+1
  39      Copy          18  12   0                          0  r[12]=r[18]
  40      Copy          13   6   0                          0  r[6]=r[13]
  41      Copy          14   7   0                          0  r[7]=r[14]
  42      Copy          15   8   0                          0  r[8]=r[15]
  43      Copy          16   9   0                          0  r[9]=r[16]
  44      Copy          12  10   0                          0  r[10]=r[12]
  45      ResultRow      6   5   0                          0  output=r[6..10]
  46    Next             2  34   0                          0
  47    ResetSorter      2   0   0                          0  cursor=2
  48  Return            19   0   1                          0
  49  Halt               0   0   0                          0
  50  Transaction        0   1   7                          0  iDb=0 tx_mode=Read
  51  Goto               0   1   0                          0
