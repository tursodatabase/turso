---
source: windows.sqltest
expression: |-
  SELECT
          sale_id,
          emp_id,
          sale_date,
          amount,
          region,
          ROW_NUMBER() OVER (ORDER BY sale_date ASC, amount DESC) AS sale_order
      FROM sales;
info:
  statement_type: SELECT
  tables:
  - sales
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
`--SCAN window_subquery_0
   |--SCAN sales USING INDEX idx_sales_date
   `--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode            p1  p2  p3  p4                     p5  comment
   0    Init             0  66   0                          0  Start at 66
   1    InitCoroutine    1  26   2                          0
   2    SorterOpen       0   2   0  k(2,B,-B)               0  cursor=0
   3    OpenRead         1   3   0  k(5,B,B,B,B,B)          0  table=sales, root=3, iDb=0
   4    OpenRead         2   7   0  k(2,B)                  0  index=idx_sales_date, root=7, iDb=0
   5    Rewind           2  15   0                          0  Rewind index idx_sales_date
   6      DeferredSeek   2   1   0                          0
   7      Column         1   2   8                          0  r[8]=sales.sale_date
   8      Column         1   3   9                          0  r[9]=sales.amount
   9      IdxRowId       2  10   0                          0  r[10]=cursor 2 for index idx_sales_date.rowid
  10      Column         1   1  11                          0  r[11]=sales.emp_id
  11      Column         1   4  12                          0  r[12]=sales.region
  12      MakeRecord     8   5   7                          0  r[7]=mkrec(r[8..12])
  13      SorterInsert   0   7   0  0                       0  key=r[7]
  14    Next             2   6   0                          0
  15    OpenPseudo       3   7   5                          0  5 columns in r[7]
  16    SorterSort       0  25   0                          0
  17      SorterData     0   7   3                          0  r[7]=data
  18      Column         3   0   2                          0  r[2]=pseudo.column 0
  19      Column         3   1   3                          0  r[3]=pseudo.column 1
  20      Column         3   2   4                          0  r[4]=pseudo.column 2
  21      Column         3   3   5                          0  r[5]=pseudo.column 3
  22      Column         3   4   6                          0  r[6]=pseudo.column 4
  23      Yield          1   0   0                          0
  24    SorterNext       0  17   0                          0
  25    EndCoroutine     1   0   0                          0
  26    OpenEphemeral    4   1   0                          0  cursor=4 is_table=true
  27    OpenDup          5   4   0                          0  new_cursor=5, original_cursor=4
  28    Null             0  26   0                          0  r[26]=NULL
  29    Null             0  27   0                          0  r[27]=NULL
  30    InitCoroutine    1   0   2                          0
  31      Yield          1  46   0                          0
  32      Copy           2  31   0                          0  r[31]=r[2]
  33      Copy           3  32   0                          0  r[32]=r[3]
  34      NotNull       26  38   0                          0  r[26]!=NULL -> goto 38
  35      Copy          31  29   1                          0  r[29]=r[31]; initialize previous peer register for new partition
  36      Null           0  19  19                          0  r[19..19]=NULL; reset accumulator registers
  37      Integer        0  27   0                          0  r[27]=0
  38      Compare       29  31   2  k(2, Binary, Binary)    0  r[29..30]==r[31..32]; compare ORDER BY columns to detect peer
  39      Jump          40  42  40                          0
  40      Gosub         28  47   0                          0  ; detected non-peer row
  41      Copy          31  29   1                          0  r[29]=r[31]
  42      MakeRecord     2   5  33                          0  r[33]=mkrec(r[2..6])
  43      NewRowid       5  26   0                          0  r[26]=rowid
  44      Insert         5  33  26  buffer_table_window_0   0  intkey=r[26] data=r[33]
  45    Goto             0  31   0                          0
  46    Null             0  28   0                          0  r[28]=NULL; return remaining buffered rows
  47    Rewind           4  63   0                          0  Rewind  buffer_table_window_0
  48      Column         4   2  21                          0  r[21]=buffer_table_window_0.sale_id
  49      Column         4   3  22                          0  r[22]=buffer_table_window_0.emp_id
  50      Column         4   0  23                          0  r[23]=buffer_table_window_0.sale_date
  51      Column         4   1  24                          0  r[24]=buffer_table_window_0.amount
  52      Column         4   4  25                          0  r[25]=buffer_table_window_0.region
  53      AddImm        27   1   0                          0  r[27]=r[27]+1
  54      Copy          27  20   0                          0  r[20]=r[27]
  55      Copy          21  13   0                          0  r[13]=r[21]
  56      Copy          22  14   0                          0  r[14]=r[22]
  57      Copy          23  15   0                          0  r[15]=r[23]
  58      Copy          24  16   0                          0  r[16]=r[24]
  59      Copy          25  17   0                          0  r[17]=r[25]
  60      Copy          20  18   0                          0  r[18]=r[20]
  61      ResultRow     13   6   0                          0  output=r[13..18]
  62    Next             4  48   0                          0
  63    ResetSorter      4   0   0                          0  cursor=4
  64  Return            28   0   1                          0
  65  Halt               0   0   0                          0
  66  Transaction        0   1   7                          0  iDb=0 tx_mode=Read
  67  Goto               0   1   0                          0
