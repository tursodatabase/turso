---
source: tpch.sqltest
expression: |-
  select
          l_shipmode,
          sum(case
              when o_orderpriority = '1-URGENT'
                  or o_orderpriority = '2-HIGH'
                  then 1
              else 0
          end) as high_line_count,
          sum(case
              when o_orderpriority <> '1-URGENT'
                  and o_orderpriority <> '2-HIGH'
                  then 1
              else 0
          end) as low_line_count
      from
          orders,
          lineitem
      where
          o_orderkey = l_orderkey
          and l_shipmode in ('FOB', 'SHIP')
          and l_commitdate < l_receiptdate
          and l_shipdate < l_commitdate
          and l_receiptdate >= '1994-01-01'
          and l_receiptdate < '1995-01-01'
      group by
          l_shipmode
      order by
          l_shipmode;
info:
  statement_type: SELECT
  tables:
  - orders
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SCAN lineitem
|--SEARCH orders USING INTEGER PRIMARY KEY (rowid=?)
`--USE SORTER FOR GROUP BY

BYTECODE
addr  opcode                  p1  p2  p3  p4                                     p5  comment
   0          Init             0  93   0                                          0  Start at 93
   1          Null             0   9  10                                          0  r[9..10]=NULL
   2          SorterOpen       0   3   0  k(1,B)                                  0  cursor=0
   3          Integer          0   6   0                                          0  r[6]=0; clear group by abort flag
   4          Null             0   7   0                                          0  r[7]=NULL; initialize group by comparison registers to NULL
   5          Gosub           15  89   0                                          0  ; go to clear accumulator subroutine
   6          OpenRead         2   9   0  k(9,B,B,B,B,B,B,B,B,B)                  0  table=orders, root=9, iDb=0
   7          OpenRead         3  10   0  k(17,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B)   0  table=lineitem, root=10, iDb=0
   8          Rewind           3  58   0                                          0  Rewind table lineitem
   9            Column         3  14  16                                          0  r[16]=lineitem.l_shipmode
  10            Eq            16  17  12  Binary                                  0  if r[16]==r[17] goto 12
  11            Ne            16  18  57  Binary                                  0  if r[16]!=r[18] goto 57
  12            Column         3  11  20                                          0  r[20]=lineitem.l_commitdate
  13            Column         3  12  21                                          0  r[21]=lineitem.l_receiptdate
  14            Ge            20  21  57  Binary                                  0  if r[20]>=r[21] goto 57
  15            Column         3  10  23                                          0  r[23]=lineitem.l_shipdate
  16            Column         3  11  24                                          0  r[24]=lineitem.l_commitdate
  17            Ge            23  24  57  Binary                                  0  if r[23]>=r[24] goto 57
  18            Column         3  12  26                                          0  r[26]=lineitem.l_receiptdate
  19            Lt            26  27  57  Binary                                  0  if r[26]<r[27] goto 57
  20            Column         3  12  29                                          0  r[29]=lineitem.l_receiptdate
  21            Ge            29  30  57  Binary                                  0  if r[29]>=r[30] goto 57
  22            Column         3   0  31                                          0  r[31]=lineitem.l_orderkey
  23            SeekRowid      2  31  57                                          0  if (r[31]!=cursor 2 for table orders.rowid) goto 57
  24            Column         3  14  12                                          0  r[12]=lineitem.l_shipmode
  25            Column         2   5  35                                          0  r[35]=orders.o_orderpriority
  26            String8        0  36   0  1-URGENT                                0  r[36]='1-URGENT'
  27            Integer        1  33   0                                          0  r[33]=1
  28            Eq            35  36  30  Binary                                  0  if r[35]==r[36] goto 30
  29            ZeroOrNull    35  33  36                                          0  ((r[35]=NULL)|(r[36]=NULL)) ? r[33]=NULL : r[33]=0
  30            Column         2   5  37                                          0  r[37]=orders.o_orderpriority
  31            String8        0  38   0  2-HIGH                                  0  r[38]='2-HIGH'
  32            Integer        1  34   0                                          0  r[34]=1
  33            Eq            37  38  35  Binary                                  0  if r[37]==r[38] goto 35
  34            ZeroOrNull    37  34  38                                          0  ((r[37]=NULL)|(r[38]=NULL)) ? r[34]=NULL : r[34]=0
  35            Or            34  33  32                                          0  r[32]=(r[33] || r[34])
  36            IfNot         32  39   1                                          0  if !r[32] goto 39
  37            Integer        1  13   0                                          0  r[13]=1
  38            Goto           0  40   0                                          0
  39            Integer        0  13   0                                          0  r[13]=0
  40            Column         2   5  42                                          0  r[42]=orders.o_orderpriority
  41            String8        0  43   0  1-URGENT                                0  r[43]='1-URGENT'
  42            Integer        1  40   0                                          0  r[40]=1
  43            Ne            42  43  45  Binary                                  0  if r[42]!=r[43] goto 45
  44            ZeroOrNull    42  40  43                                          0  ((r[42]=NULL)|(r[43]=NULL)) ? r[40]=NULL : r[40]=0
  45            Column         2   5  44                                          0  r[44]=orders.o_orderpriority
  46            String8        0  45   0  2-HIGH                                  0  r[45]='2-HIGH'
  47            Integer        1  41   0                                          0  r[41]=1
  48            Ne            44  45  50  Binary                                  0  if r[44]!=r[45] goto 50
  49            ZeroOrNull    44  41  45                                          0  ((r[44]=NULL)|(r[45]=NULL)) ? r[41]=NULL : r[41]=0
  50            And           41  40  39                                          0  r[39]=(r[40] && r[41])
  51            IfNot         39  54   1                                          0  if !r[39] goto 54
  52            Integer        1  14   0                                          0  r[14]=1
  53            Goto           0  55   0                                          0
  54            Integer        0  14   0                                          0  r[14]=0
  55            MakeRecord    12   3  11                                          0  r[11]=mkrec(r[12..14])
  56            SorterInsert   0  11   0  0                                       0  key=r[11]
  57          Next             3   9   0                                          0
  58          OpenPseudo       1  11   3                                          0  3 columns in r[11]
  59          SorterSort       0  76   0                                          0
  60            SorterData     0  11   1                                          0  r[11]=data
  61            Column         1   0  46                                          0  r[46]=pseudo.column 0
  62            Compare        7  46   1  k(1, Binary)                            0  r[7..7]==r[46..46]
  63            Jump          64  68  64                                          0  ; start new group if comparison is not equal
  64            Gosub          4  80   0                                          0  ; check if ended group had data, and output if so
  65            Move          46   7   1                                          0  r[7..7]=r[46..46]
  66            IfPos          6  92   0                                          0  r[6]>0 -> r[6]-=0, goto 92; check abort flag
  67            Gosub         15  89   0                                          0  ; goto clear accumulator subroutine
  68            Column         1   1  47                                          0  r[47]=pseudo.column 1
  69            AggStep        0  47   9  sum                                     0  accum=r[9] step(r[47])
  70            Column         1   2  48                                          0  r[48]=pseudo.column 2
  71            AggStep        0  48  10  sum                                     0  accum=r[10] step(r[48])
  72            If             5  74   0                                          0  if r[5] goto 74; don't emit group columns if continuing existing group
  73            Column         1   0   8                                          0  r[8]=pseudo.column 0
  74            Integer        1   5   0                                          0  r[5]=1; indicate data in accumulator
  75          SorterNext       0  60   0                                          0
  76          Gosub            4  80   0                                          0  ; emit row for final group
  77          Goto             0  92   0                                          0  ; group by finished
  78          Integer          1   6   0                                          0  r[6]=1
  79        Return             4   0   0                                          0
  80        IfPos              5  82   0                                          0  r[5]>0 -> r[5]-=0, goto 82; output group by row subroutine start
  81      Return               4   0   0                                          0
  82      AggFinal             0   9   0  sum                                     0  accum=r[9]
  83      AggFinal             0  10   0  sum                                     0  accum=r[10]
  84      Copy                 8   1   0                                          0  r[1]=r[8]
  85      Copy                 9   2   0                                          0  r[2]=r[9]
  86      Copy                10   3   0                                          0  r[3]=r[10]
  87      ResultRow            1   3   0                                          0  output=r[1..3]
  88    Return                 4   0   0                                          0
  89    Null                   0   8  10                                          0  r[8..10]=NULL; clear accumulator subroutine start
  90    Integer                0   5   0                                          0  r[5]=0
  91  Return                  15   0   0                                          0
  92  Halt                     0   0   0                                          0
  93  Transaction              0   1   8                                          0  iDb=0 tx_mode=Read
  94  String8                  0  17   0  FOB                                     0  r[17]='FOB'
  95  String8                  0  18   0  SHIP                                    0  r[18]='SHIP'
  96  String8                  0  27   0  1994-01-01                              0  r[27]='1994-01-01'
  97  String8                  0  30   0  1995-01-01                              0  r[30]='1995-01-01'
  98  Goto                     0   1   0                                          0
