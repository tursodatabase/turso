---
source: tpch.sqltest
expression: |-
  select
          sum(l_extendedprice) / 7.0 as avg_yearly
      from
          lineitem,
          part
      where
          p_partkey = l_partkey
          and p_brand = 'Brand#52'
          and p_container = 'LG CAN'
          and l_quantity < (
              select
                  0.2 * avg(l_quantity)
              from
                  lineitem
              where
                  l_partkey = p_partkey
          );
info:
  statement_type: SELECT
  tables:
  - lineitem
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SCAN lineitem
|--SEARCH part USING INTEGER PRIMARY KEY (rowid=?)
`--SCAN lineitem

BYTECODE
addr  opcode           p1  p2  p3  p4                                     p5  comment
   0    Init            0  40   0                                          0  Start at 40
   1    Null            0   3   0                                          0  r[3]=NULL
   2    OpenRead        0  10   0  k(17,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B)   0  table=lineitem, root=10, iDb=0
   3    OpenRead        1   4   0  k(9,B,B,B,B,B,B,B,B,B)                  0  table=part, root=4, iDb=0
   4    Rewind          0  35   0                                          0  Rewind table lineitem
   5      Column        0   1   4                                          0  r[4]=lineitem.l_partkey
   6      SeekRowid     1   4  34                                          0  if (r[4]!=cursor 1 for table part.rowid) goto 34
   7      Column        1   3   6                                          0  r[6]=part.p_brand
   8      Ne            6   7  34  Binary                                  0  if r[6]!=r[7] goto 34
   9      Column        1   6   9                                          0  r[9]=part.p_container
  10      Ne            9  10  34  Binary                                  0  if r[9]!=r[10] goto 34
  11      BeginSubrtn  11   0   0                                          0  r[11]=NULL
  12      Null          0   1   0                                          0  r[1]=NULL
  13      Null          0  13   0                                          0  r[13]=NULL
  14      Integer       1  14   0                                          0  r[14]=1; LIMIT counter
  15      IfNot        14  24   0                                          0  if !r[14] goto 24
  16      OpenRead      2  10   0  k(17,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B)   0  table=lineitem, root=10, iDb=0
  17      Rewind        2  24   0                                          0  Rewind table lineitem
  18        Column      2   1  16                                          0  r[16]=lineitem.l_partkey
  19        RowId       1  17   0                                          0  r[17]=part.rowid
  20        Ne         16  17  23  Binary                                  0  if r[16]!=r[17] goto 23
  21        Column      2   4  18                                          0  r[18]=lineitem.l_quantity
  22        AggStep     0  18  13  avg                                     0  accum=r[13] step(r[18])
  23      Next          2  18   0                                          0
  24      AggFinal      0  13   0  avg                                     0  accum=r[13]
  25      Copy         13  20   0                                          0  r[20]=r[13]
  26      Multiply     19  20  12                                          0  r[12]=r[19]*r[20]
  27      Copy         12   1   0                                          0  r[1]=r[12]
  28    Return         11   0   1                                          0
  29    Column          0   4  22                                          0  r[22]=lineitem.l_quantity
  30    Copy            1  23   0                                          0  r[23]=r[1]
  31    Ge             22  23  34  Binary                                  0  if r[22]>=r[23] goto 34
  32    Column          0   5  24                                          0  r[24]=lineitem.l_extendedprice
  33    AggStep         0  24   3  sum                                     0  accum=r[3] step(r[24])
  34  Next              0   5   0                                          0
  35  AggFinal          0   3   0  sum                                     0  accum=r[3]
  36  Copy              3  25   0                                          0  r[25]=r[3]
  37  Divide           25  26   2                                          0  r[2]=r[25]/r[26]
  38  ResultRow         2   1   0                                          0  output=r[2]
  39  Halt              0   0   0                                          0
  40  Transaction       0   1   8                                          0  iDb=0 tx_mode=Read
  41  String8           0   7   0  Brand#52                                0  r[7]='Brand#52'
  42  String8           0  10   0  LG CAN                                  0  r[10]='LG CAN'
  43  Real              0  19   0  0.2                                     0  r[19]=0.2
  44  Real              0  26   0  7.0                                     0  r[26]=7
  45  Goto              0   1   0                                          0
