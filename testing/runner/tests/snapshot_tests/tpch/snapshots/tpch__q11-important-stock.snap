---
source: tpch.sqltest
expression: |-
  select
          ps_partkey,
          sum(ps_supplycost * ps_availqty) as value
      from
          partsupp,
          supplier,
          nation
      where
          ps_suppkey = s_suppkey
          and s_nationkey = n_nationkey
          and n_name = 'ARGENTINA'
      group by
          ps_partkey having
              sum(ps_supplycost * ps_availqty) > (
                  select
                      sum(ps_supplycost * ps_availqty) * 0.0001000000
                  from
                      partsupp,
                      supplier,
                      nation
                  where
                      ps_suppkey = s_suppkey
                      and s_nationkey = n_nationkey
                      and n_name = 'ARGENTINA'
              )
      order by
          value desc;
info:
  statement_type: SELECT
  tables:
  - partsupp
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SCALAR SUBQUERY 1
|  |--SCAN partsupp
|  |--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
|  `--SEARCH nation USING INTEGER PRIMARY KEY (rowid=?)
|--SCAN partsupp USING INDEX sqlite_autoindex_partsupp_1
|--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH nation USING INTEGER PRIMARY KEY (rowid=?)
`--USE SORTER FOR ORDER BY

BYTECODE
addr  opcode                  p1  p2  p3  p4                  p5  comment
   0            Init           0  87   0                       0  Start at 87
   1            Once          27   0   0                       0  goto 27
   2            BeginSubrtn    2   0   0                       0  r[2]=NULL
   3            Null           0   1   0                       0  r[1]=NULL
   4            Null           0   4   0                       0  r[4]=NULL
   5            Integer        1   5   0                       0  r[5]=1; LIMIT counter
   6            IfNot          5  22   0                       0  if !r[5] goto 22
   7            OpenRead       0   6   0  k(6,B,B,B,B,B)       0  table=partsupp, root=6, iDb=0
   8            OpenRead       1   5   0  k(7,B,B,B,B,B,B,B)   0  table=supplier, root=5, iDb=0
   9            OpenRead       2   2   0  k(4,B,B,B,B)         0  table=nation, root=2, iDb=0
  10            Rewind         0  22   0                       0  Rewind table partsupp
  11              Column       0   1   6                       0  r[6]=partsupp.ps_suppkey
  12              SeekRowid    1   6  21                       0  if (r[6]!=cursor 1 for table supplier.rowid) goto 21
  13              Column       1   3   7                       0  r[7]=supplier.s_nationkey
  14              SeekRowid    2   7  21                       0  if (r[7]!=cursor 2 for table nation.rowid) goto 21
  15              Column       2   1   9                       0  r[9]=nation.n_name
  16              Ne           9  10  21  Binary               0  if r[9]!=r[10] goto 21
  17              Column       0   3  12                       0  r[12]=partsupp.ps_supplycost
  18              Column       0   2  13                       0  r[13]=partsupp.ps_availqty
  19              Multiply    12  13  11                       0  r[11]=r[12]*r[13]
  20              AggStep      0  11   4  sum                  0  accum=r[4] step(r[11])
  21            Next           0  11   0                       0
  22            AggFinal       0   4   0  sum                  0  accum=r[4]
  23            Copy           4  14   0                       0  r[14]=r[4]
  24            Multiply      14  15   3                       0  r[3]=r[14]*r[15]
  25            Copy           3   1   0                       0  r[1]=r[3]
  26          Return           2   0   1                       0
  27          SorterOpen       3   1   0  k(1,-B)              0  cursor=3
  28          Null             0  25   0                       0  r[25]=NULL
  29          Integer          0  21   0                       0  r[21]=0; clear group by abort flag
  30          Null             0  22   0                       0  r[22]=NULL; initialize group by comparison registers to NULL
  31          Gosub           30  76   0                       0  ; go to clear accumulator subroutine
  32          OpenRead         4   6   0  k(6,B,B,B,B,B)       0  table=partsupp, root=6, iDb=0
  33          OpenRead         5   7   0  k(3,B,B)             0  index=sqlite_autoindex_partsupp_1, root=7, iDb=0
  34          OpenRead         6   5   0  k(7,B,B,B,B,B,B,B)   0  table=supplier, root=5, iDb=0
  35          OpenRead         7   2   0  k(4,B,B,B,B)         0  table=nation, root=2, iDb=0
  36          Rewind           5  61   0                       0  Rewind index sqlite_autoindex_partsupp_1
  37            DeferredSeek   5   4   0                       0
  38            Column         4   1  31                       0  r[31]=partsupp.ps_suppkey
  39            SeekRowid      6  31  60                       0  if (r[31]!=cursor 6 for table supplier.rowid) goto 60
  40            Column         6   3  32                       0  r[32]=supplier.s_nationkey
  41            SeekRowid      7  32  60                       0  if (r[32]!=cursor 7 for table nation.rowid) goto 60
  42            Column         7   1  34                       0  r[34]=nation.n_name
  43            Ne            34  35  60  Binary               0  if r[34]!=r[35] goto 60
  44            Column         4   0  27                       0  r[27]=partsupp.ps_partkey
  45            Copy           1  28   0                       0  r[28]=r[1]
  46            Column         4   3  36                       0  r[36]=partsupp.ps_supplycost
  47            Column         4   2  37                       0  r[37]=partsupp.ps_availqty
  48            Multiply      36  37  29                       0  r[29]=r[36]*r[37]
  49            Compare       22  27   1  k(1, Binary)         0  r[22..22]==r[27..27]
  50            Jump          51  55  51                       0  ; start new group if comparison is not equal
  51            Gosub         19  65   0                       0  ; check if ended group had data, and output if so
  52            Move          27  22   1                       0  r[22..22]=r[27..27]
  53            IfPos         21  79   0                       0  r[21]>0 -> r[21]-=0, goto 79; check abort flag
  54            Gosub         30  76   0                       0  ; goto clear accumulator subroutine
  55            AggStep        0  29  25  sum                  0  accum=r[25] step(r[29])
  56            If            20  59   0                       0  if r[20] goto 59; don't emit group columns if continuing existing group
  57            Column         4   0  23                       0  r[23]=partsupp.ps_partkey
  58            Copy           1  24   0                       0  r[24]=r[1]
  59            Integer        1  20   0                       0  r[20]=1; indicate data in accumulator
  60          Next             5  37   0                       0
  61          Gosub           19  65   0                       0  ; emit row for final group
  62          Goto             0  79   0                       0  ; group by finished
  63          Integer          1  21   0                       0  r[21]=1
  64        Return            19   0   0                       0
  65        IfPos             20  67   0                       0  r[20]>0 -> r[20]-=0, goto 67; output group by row subroutine start
  66      Return              19   0   0                       0
  67      AggFinal             0  25   0  sum                  0  accum=r[25]
  68      Copy                25  39   0                       0  r[39]=r[25]
  69      Copy                24  40   0                       0  r[40]=r[24]
  70      Le                  39  40  66  Binary               0  if r[39]<=r[40] goto 66
  71      Copy                25  41   0                       0  r[41]=r[25]
  72      Copy                23  42   0                       0  r[42]=r[23]
  73      MakeRecord          41   2  18                       0  r[18]=mkrec(r[41..42])
  74      SorterInsert         3  18   0  0                    0  key=r[18]
  75    Return                19   0   0                       0
  76    Null                   0  23  25                       0  r[23..25]=NULL; clear accumulator subroutine start
  77    Integer                0  20   0                       0  r[20]=0
  78  Return                  30   0   0                       0
  79  OpenPseudo               8  18   2                       0  2 columns in r[18]
  80  SorterSort               3  86   0                       0
  81    SorterData             3  18   8                       0  r[18]=data
  82    Column                 8   1  16                       0  r[16]=pseudo.column 1
  83    Column                 8   0  17                       0  r[17]=pseudo.column 0
  84    ResultRow             16   2   0                       0  output=r[16..17]
  85  SorterNext               3  81   0                       0
  86  Halt                     0   0   0                       0
  87  Transaction              0   1   8                       0  iDb=0 tx_mode=Read
  88  String8                  0  10   0  ARGENTINA            0  r[10]='ARGENTINA'
  89  Real                     0  15   0  0.0001               0  r[15]=0.0001
  90  String8                  0  35   0  ARGENTINA            0  r[35]='ARGENTINA'
  91  Goto                     0   1   0                       0
