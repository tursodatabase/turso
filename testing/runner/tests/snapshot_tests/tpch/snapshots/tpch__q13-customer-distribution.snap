---
source: tpch.sqltest
expression: |-
  select
          c_count,
          count(*) as custdist
      from
          (
              select
                  c_custkey,
                  count(o_orderkey) as c_count
              from
                  customer left outer join orders on
                      c_custkey = o_custkey
                      and o_comment not like '%express%packages%'
              group by
                  c_custkey
          ) as c_orders
      group by
          c_count
      order by
          custdist desc,
          c_count desc;
info:
  statement_type: SELECT
  tables:
  - c_custkey
  - customer
  - orders
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SCAN c_orders
|  |--SCAN customer
|  `--SEARCH orders USING INDEX ephemeral_orders_t2
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                            p1   p2  p3  p4                      p5  comment
   0                  Init               0  117   0                           0  Start at 117
   1                  InitCoroutine      1   66   2                           0
   2                  Null               0    9   0                           0  r[9]=NULL
   3                  Integer            0    6   0                           0  r[6]=0; clear group by abort flag
   4                  Null               0    7   0                           0  r[7]=NULL; initialize group by comparison registers to NULL
   5                  Gosub             13   62   0                           0  ; go to clear accumulator subroutine
   6                  OpenRead           0    8   0  k(8,B,B,B,B,B,B,B,B)     0  table=customer, root=8, iDb=0
   7                  OpenRead           1    9   0  k(9,B,B,B,B,B,B,B,B,B)   0  table=orders, root=9, iDb=0
   8                  Rewind             0   51   0                           0  Rewind table customer
   9                    Integer          0   14   0                           0  r[14]=0
  10                    Once            21    0   0                           0  goto 21
  11                    OpenAutoindex    2    0   0                           0  cursor=2
  12                    Rewind           1   13   0                           0  Rewind table orders
  13                      Column         1    1  15                           0  r[15]=orders.o_custkey
  14                      RowId          1   16   0                           0  r[16]=orders.rowid
  15                      Column         1    8  17                           0  r[17]=orders.o_comment
  16                      RowId          1   18   0                           0  r[18]=orders.rowid
  17                      MakeRecord    15    4  19                           0  r[19]=mkrec(r[15..18]); for ephemeral_orders_t2
  18                      FilterAdd      2   15   1                           0  bloom_filter_add(r[15..16])
  19                      IdxInsert      2   19  15                           0  key=r[19]
  20                    Next             1   13   0                           0
  21                    RowId            0   20   0                           0  r[20]=customer.rowid
  22                    Filter           2   46  20                           1  if !bloom_filter(r[20..21]) goto 46
  23                    SeekGE           2   46  20                           0  key=[20..20]
  24                      IdxGT          2   46  20                           0  key=[20..20]
  25                      DeferredSeek   2    1   0                           0
  26                      RowId          0   22   0                           0  r[22]=customer.rowid
  27                      Column         2    0  23                           0  r[23]=ephemeral_orders_t2.o_custkey
  28                      Ne            22   23  45  Binary                   0  if r[22]!=r[23] goto 45
  29                      Column         2    2  26                           0  r[26]=ephemeral_orders_t2.o_comment
  30                      Function       1   25  24  like(2)                  0  r[24]=func(r[25..26])
  31                      If            24   45   1                           0  if r[24] goto 45
  32                      Integer        1   14   0                           0  r[14]=1
  33                      RowId          0   11   0                           0  r[11]=customer.rowid
  34                      IdxRowId       2   12   0                           0  r[12]=cursor 2 for index ephemeral_orders_t2.rowid
  35                      Compare        7   11   1  k(1, Binary)             0  r[7..7]==r[11..11]
  36                      Jump          37   41  37                           0  ; start new group if comparison is not equal
  37                      Gosub          4   55   0                           0  ; check if ended group had data, and output if so
  38                      Move          11    7   1                           0  r[7..7]=r[11..11]
  39                      IfPos          6   65   0                           0  r[6]>0 -> r[6]-=0, goto 65; check abort flag
  40                      Gosub         13   62   0                           0  ; goto clear accumulator subroutine
  41                      AggStep        0   12   9  count                    0  accum=r[9] step(r[12])
  42                      If             5   44   0                           0  if r[5] goto 44; don't emit group columns if continuing existing group
  43                      RowId          0    8   0                           0  r[8]=customer.rowid
  44                      Integer        1    5   0                           0  r[5]=1; indicate data in accumulator
  45                    Next             2   24   0                           0
  46                    IfPos           14   50   0                           0  r[14]>0 -> r[14]-=0, goto 50
  47                    NullRow          1    0   0                           0  Set cursor 1 to a (pseudo) NULL row
  48                    NullRow          2    0   0                           0  Set cursor 2 to a (pseudo) NULL row
  49                    Goto             0   32   0                           0
  50                  Next               0    9   0                           0
  51                  Gosub              4   55   0                           0  ; emit row for final group
  52                  Goto               0   65   0                           0  ; group by finished
  53                  Integer            1    6   0                           0  r[6]=1
  54                Return               4    0   0                           0
  55                IfPos                5   57   0                           0  r[5]>0 -> r[5]-=0, goto 57; output group by row subroutine start
  56              Return                 4    0   0                           0
  57              AggFinal               0    9   0  count                    0  accum=r[9]
  58              Copy                   8    2   0                           0  r[2]=r[8]
  59              Copy                   9    3   0                           0  r[3]=r[9]
  60              Yield                  1    0   0                           0
  61            Return                   4    0   0                           0
  62            Null                     0    8   9                           0  r[8..9]=NULL; clear accumulator subroutine start
  63            Integer                  0    5   0                           0  r[5]=0
  64          Return                    13    0   0                           0
  65          EndCoroutine               1    0   0                           0
  66          SorterOpen                 3    3   0  k(3,-B,-B,Binary)        0  cursor=3
  67          Null                       0   35   0                           0  r[35]=NULL
  68          SorterOpen                 4    1   0  k(1,-B)                  0  cursor=4
  69          Integer                    0   32   0                           0  r[32]=0; clear group by abort flag
  70          Null                       0   33   0                           0  r[33]=NULL; initialize group by comparison registers to NULL
  71          Gosub                     38  106   0                           0  ; go to clear accumulator subroutine
  72          InitCoroutine              1    0   2                           0
  73            Yield                    1   78   0                           0
  74            Copy                     3   37   0                           0  r[37]=r[3]
  75            MakeRecord              37    1  36                           0  r[36]=mkrec(r[37..37])
  76            SorterInsert             4   36   0  0                        0  key=r[36]
  77          Goto                       0   73   0                           0
  78          OpenPseudo                 5   36   1                           0  1 columns in r[36]
  79          SorterSort                 4   93   0                           0
  80            SorterData               4   36   5                           0  r[36]=data
  81            Column                   5    0  39                           0  r[39]=pseudo.column 0
  82            Compare                 33   39   1  k(1, Binary)             0  r[33..33]==r[39..39]
  83            Jump                    84   88  84                           0  ; start new group if comparison is not equal
  84            Gosub                   30   97   0                           0  ; check if ended group had data, and output if so
  85            Move                    39   33   1                           0  r[33..33]=r[39..39]
  86            IfPos                   32  109   0                           0  r[32]>0 -> r[32]-=0, goto 109; check abort flag
  87            Gosub                   38  106   0                           0  ; goto clear accumulator subroutine
  88            AggStep                  0   40  35  count                    0  accum=r[35] step(r[40])
  89            If                      31   91   0                           0  if r[31] goto 91; don't emit group columns if continuing existing group
  90            Column                   5    0  34                           0  r[34]=pseudo.column 0
  91            Integer                  1   31   0                           0  r[31]=1; indicate data in accumulator
  92          SorterNext                 4   80   0                           0
  93          Gosub                     30   97   0                           0  ; emit row for final group
  94          Goto                       0  109   0                           0  ; group by finished
  95          Integer                    1   32   0                           0  r[32]=1
  96        Return                      30    0   0                           0
  97        IfPos                       31   99   0                           0  r[31]>0 -> r[31]-=0, goto 99; output group by row subroutine start
  98      Return                        30    0   0                           0
  99      AggFinal                       0   35   0  count                    0  accum=r[35]
 100      Copy                          35   41   0                           0  r[41]=r[35]
 101      Copy                          34   42   0                           0  r[42]=r[34]
 102      Sequence                       3   43   0                           0
 103      MakeRecord                    41    3  29                           0  r[29]=mkrec(r[41..43])
 104      SorterInsert                   3   29   0  0                        0  key=r[29]
 105    Return                          30    0   0                           0
 106    Null                             0   34  35                           0  r[34..35]=NULL; clear accumulator subroutine start
 107    Integer                          0   31   0                           0  r[31]=0
 108  Return                            38    0   0                           0
 109  OpenPseudo                         6   29   3                           0  3 columns in r[29]
 110  SorterSort                         3  116   0                           0
 111    SorterData                       3   29   6                           0  r[29]=data
 112    Column                           6    1  27                           0  r[27]=pseudo.column 1
 113    Column                           6    0  28                           0  r[28]=pseudo.column 0
 114    ResultRow                       27    2   0                           0  output=r[27..28]
 115  SorterNext                         3  111   0                           0
 116  Halt                               0    0   0                           0
 117  Transaction                        0    1   8                           0  iDb=0 tx_mode=Read
 118  String8                            0   25   0  %express%packages%       0  r[25]='%express%packages%'
 119  Integer                            1   40   0                           0  r[40]=1
 120  Goto                               0    1   0                           0
