---
source: tpch.sqltest
expression: |-
  select
          c_count,
          count(*) as custdist
      from
          (
              select
                  c_custkey,
                  count(o_orderkey) as c_count
              from
                  customer left outer join orders on
                      c_custkey = o_custkey
                      and o_comment not like '%express%packages%'
              group by
                  c_custkey
          ) as c_orders
      group by
          c_count
      order by
          custdist desc,
          c_count desc;
info:
  statement_type: SELECT
  tables:
  - c_custkey
  - customer
  - orders
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SCAN c_orders
|  |--SCAN customer
|  `--HASH JOIN orders
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                               p1   p2  p3  p4                                       p5  comment
   0                    Init                0  126   0                                            0  Start at 126
   1                    InitCoroutine       1   75   2                                            0
   2                    Null                0    9   0                                            0  r[9]=NULL
   3                    SorterOpen          0    2   0  k(1,B)                                    0  cursor=0
   4                    Integer             0    6   0                                            0  r[6]=0; clear group by abort flag
   5                    Null                0    7   0                                            0  r[7]=NULL; initialize group by comparison registers to NULL
   6                    Gosub              13   71   0                                            0  ; go to clear accumulator subroutine
   7                    OpenRead            2    8   0  k(8,B,B,B,B,B,B,B,B)                      0  table=customer, root=8, iDb=0
   8                    OpenRead            3    9   0  k(9,B,B,B,B,B,B,B,B,B)                    0  table=orders, root=9, iDb=0
   9                    Integer             0   14   0                                            0  r[14]=0
  10                    Once               19    0   0                                            0  goto 19
  11                    OpenRead            4    8   0  k(8,B,B,B,B,B,B,B,B)                      0  table=customer, root=8, iDb=0
  12                    Rewind              4   18   0                                            0  Rewind table customer
  13                      RowId             4   15   0                                            0  r[15]=customer.rowid
  14                      Affinity         15    1   0                                            0  r[15..16] = C
  15                      RowId             4   16   0                                            0  r[16]=customer.rowid
  16                      HashBuild         4   15   1  r=[1] budget=32768 payload=r[16]..r[16]   0
  17                    Next                4   13   0                                            0
  18                    HashBuildFinalize   1    0   0                                            0
  19                    Rewind              3   37   0                                            0  Rewind table orders
  20                      Column            3    1  17                                            0  r[17]=orders.o_custkey
  21                      Affinity         17    1   0                                            0  r[17..18] = C
  22                      HashProbe         1   17   1  r[19]=36 payload=r[18]..r[18]             0
  23                      Column            3    8  22                                            0  r[22]=orders.o_comment
  24                      Function          1   21  20  like(2)                                   0  r[20]=func(r[21..22])
  25                      If               20   34   1                                            0  if r[20] goto 34
  26                      HashMarkMatched   1    0   0                                            0
  27                      Gosub            23   29   0                                            0
  28                      Goto              0   34   0                                            0
  29                      Copy             18   11   0                                            0  r[11]=r[18]
  30                      RowId             3   12   0                                            0  r[12]=orders.rowid
  31                      MakeRecord       11    2  10                                            0  r[10]=mkrec(r[11..12])
  32                      SorterInsert      0   10   0  0                                         0  key=r[10]
  33                    Return             23    0   0                                            0
  34                    HashNext            1   19  36   payload=r[18]..r[18]                     0
  35                    Goto                0   23   0                                            0
  36                  Next                  3   20   0                                            0
  37                  NullRow               3    0   0                                            0  Set cursor 3 to a (pseudo) NULL row
  38                  HashScanUnmatched     1   19  43                                            0  hash_table_id=1 payload=r[18]..r[18]
  39                  SeekRowid             2   19  43                                            0  if (r[19]!=cursor 2 for table customer.rowid) goto 43
  40                  Gosub                23   29   0                                            0
  41                  HashNextUnmatched     1   19  43                                            0  hash_table_id=1 payload=r[18]..r[18]
  42                  Goto                  0   39   0                                            0
  43                  HashClose             1    0   0                                            0
  44                  OpenPseudo            1   10   2                                            0  2 columns in r[10]
  45                  SorterSort            0   60   0                                            0
  46                    SorterData          0   10   1                                            0  r[10]=data
  47                    Column              1    0  24                                            0  r[24]=pseudo.column 0
  48                    Compare             7   24   1  k(1, Binary)                              0  r[7..7]==r[24..24]
  49                    Jump               50   54  50                                            0  ; start new group if comparison is not equal
  50                    Gosub               4   64   0                                            0  ; check if ended group had data, and output if so
  51                    Move               24    7   1                                            0  r[7..7]=r[24..24]
  52                    IfPos               6   74   0                                            0  r[6]>0 -> r[6]-=0, goto 74; check abort flag
  53                    Gosub              13   71   0                                            0  ; goto clear accumulator subroutine
  54                    Column              1    1  25                                            0  r[25]=pseudo.column 1
  55                    AggStep             0   25   9  count                                     0  accum=r[9] step(r[25])
  56                    If                  5   58   0                                            0  if r[5] goto 58; don't emit group columns if continuing existing group
  57                    Column              1    0   8                                            0  r[8]=pseudo.column 0
  58                    Integer             1    5   0                                            0  r[5]=1; indicate data in accumulator
  59                  SorterNext            0   46   0                                            0
  60                  Gosub                 4   64   0                                            0  ; emit row for final group
  61                  Goto                  0   74   0                                            0  ; group by finished
  62                  Integer               1    6   0                                            0  r[6]=1
  63                Return                  4    0   0                                            0
  64                IfPos                   5   66   0                                            0  r[5]>0 -> r[5]-=0, goto 66; output group by row subroutine start
  65              Return                    4    0   0                                            0
  66              AggFinal                  0    9   0  count                                     0  accum=r[9]
  67              Copy                      8    2   0                                            0  r[2]=r[8]
  68              Copy                      9    3   0                                            0  r[3]=r[9]
  69              Yield                     1    0   0                                            0
  70            Return                      4    0   0                                            0
  71            Null                        0    8   9                                            0  r[8..9]=NULL; clear accumulator subroutine start
  72            Integer                     0    5   0                                            0  r[5]=0
  73          Return                       13    0   0                                            0
  74          EndCoroutine                  1    0   0                                            0
  75          SorterOpen                    5    3   0  k(3,-B,-B,Binary)                         0  cursor=5
  76          Null                          0   34   0                                            0  r[34]=NULL
  77          SorterOpen                    6    1   0  k(1,-B)                                   0  cursor=6
  78          Integer                       0   31   0                                            0  r[31]=0; clear group by abort flag
  79          Null                          0   32   0                                            0  r[32]=NULL; initialize group by comparison registers to NULL
  80          Gosub                        37  115   0                                            0  ; go to clear accumulator subroutine
  81          InitCoroutine                 1    0   2                                            0
  82            Yield                       1   87   0                                            0
  83            Copy                        3   36   0                                            0  r[36]=r[3]
  84            MakeRecord                 36    1  35                                            0  r[35]=mkrec(r[36..36])
  85            SorterInsert                6   35   0  0                                         0  key=r[35]
  86          Goto                          0   82   0                                            0
  87          OpenPseudo                    7   35   1                                            0  1 columns in r[35]
  88          SorterSort                    6  102   0                                            0
  89            SorterData                  6   35   7                                            0  r[35]=data
  90            Column                      7    0  38                                            0  r[38]=pseudo.column 0
  91            Compare                    32   38   1  k(1, Binary)                              0  r[32..32]==r[38..38]
  92            Jump                       93   97  93                                            0  ; start new group if comparison is not equal
  93            Gosub                      29  106   0                                            0  ; check if ended group had data, and output if so
  94            Move                       38   32   1                                            0  r[32..32]=r[38..38]
  95            IfPos                      31  118   0                                            0  r[31]>0 -> r[31]-=0, goto 118; check abort flag
  96            Gosub                      37  115   0                                            0  ; goto clear accumulator subroutine
  97            AggStep                     0   39  34  count                                     0  accum=r[34] step(r[39])
  98            If                         30  100   0                                            0  if r[30] goto 100; don't emit group columns if continuing existing group
  99            Column                      7    0  33                                            0  r[33]=pseudo.column 0
 100            Integer                     1   30   0                                            0  r[30]=1; indicate data in accumulator
 101          SorterNext                    6   89   0                                            0
 102          Gosub                        29  106   0                                            0  ; emit row for final group
 103          Goto                          0  118   0                                            0  ; group by finished
 104          Integer                       1   31   0                                            0  r[31]=1
 105        Return                         29    0   0                                            0
 106        IfPos                          30  108   0                                            0  r[30]>0 -> r[30]-=0, goto 108; output group by row subroutine start
 107      Return                           29    0   0                                            0
 108      AggFinal                          0   34   0  count                                     0  accum=r[34]
 109      Copy                             34   40   0                                            0  r[40]=r[34]
 110      Copy                             33   41   0                                            0  r[41]=r[33]
 111      Sequence                          5   42   0                                            0
 112      MakeRecord                       40    3  28                                            0  r[28]=mkrec(r[40..42])
 113      SorterInsert                      5   28   0  0                                         0  key=r[28]
 114    Return                             29    0   0                                            0
 115    Null                                0   33  34                                            0  r[33..34]=NULL; clear accumulator subroutine start
 116    Integer                             0   30   0                                            0  r[30]=0
 117  Return                               37    0   0                                            0
 118  OpenPseudo                            8   28   3                                            0  3 columns in r[28]
 119  SorterSort                            5  125   0                                            0
 120    SorterData                          5   28   8                                            0  r[28]=data
 121    Column                              8    1  26                                            0  r[26]=pseudo.column 1
 122    Column                              8    0  27                                            0  r[27]=pseudo.column 0
 123    ResultRow                          26    2   0                                            0  output=r[26..27]
 124  SorterNext                            5  120   0                                            0
 125  Halt                                  0    0   0                                            0
 126  Transaction                           0    1   8                                            0  iDb=0 tx_mode=Read
 127  String8                               0   21   0  %express%packages%                        0  r[21]='%express%packages%'
 128  Integer                               1   39   0                                            0  r[39]=1
 129  Goto                                  0    1   0                                            0
