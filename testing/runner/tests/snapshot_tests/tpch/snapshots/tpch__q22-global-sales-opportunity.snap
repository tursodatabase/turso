---
source: tpch.sqltest
expression: |-
  select
          cntrycode,
          count(*) as numcust,
          sum(c_acctbal) as totacctbal
      from
          (
              select
                  substr(c_phone, 1, 2) as cntrycode,
                  c_acctbal
              from
                  customer
              where
                  substr(c_phone, 1, 2) in
                      ('20', '14', '21', '28', '15', '24', '27')
                  and c_acctbal > (
                      select
                          avg(c_acctbal)
                      from
                          customer
                      where
                          c_acctbal > 0.00
                          and substr(c_phone, 1, 2) in
                              ('20', '14', '21', '28', '15', '24', '27')
                  )
                  and not exists (
                      select
                          *
                      from
                          orders
                      where
                          o_custkey = c_custkey
                  )
          ) as custsale
      group by
          cntrycode
      order by
          cntrycode;
info:
  statement_type: SELECT
  tables:
  - customer
  - orders
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
`--SCAN custsale
   |--SCAN customer
   |--SCAN customer
   `--SCAN orders

BYTECODE
addr  opcode                      p1   p2  p3  p4                      p5  comment
   0              Init             0  112   0                           0  Start at 112
   1              InitCoroutine    3   66   2                           0
   2              Once            28    0   0                           0  goto 28
   3              BeginSubrtn      4    0   0                           0  r[4]=NULL
   4              Null             0    1   0                           0  r[1]=NULL
   5              Null             0    6   0                           0  r[6]=NULL
   6              Integer          1    7   0                           0  r[7]=1; LIMIT counter
   7              IfNot            7   24   0                           0  if !r[7] goto 24
   8              OpenRead         0    8   0  k(8,B,B,B,B,B,B,B,B)     0  table=customer, root=8, iDb=0
   9              Rewind           0   24   0                           0  Rewind table customer
  10                Column         0    5   9                           0  r[9]=customer.c_acctbal
  11                Le             9   10  23  Binary                   0  if r[9]<=r[10] goto 23
  12                Column         0    4  12                           0  r[12]=customer.c_phone
  13                Function       0   12  11  substr                   0  r[11]=func(r[12..14])
  14                Eq            11   15  21  Binary                   0  if r[11]==r[15] goto 21
  15                Eq            11   16  21  Binary                   0  if r[11]==r[16] goto 21
  16                Eq            11   17  21  Binary                   0  if r[11]==r[17] goto 21
  17                Eq            11   18  21  Binary                   0  if r[11]==r[18] goto 21
  18                Eq            11   19  21  Binary                   0  if r[11]==r[19] goto 21
  19                Eq            11   20  21  Binary                   0  if r[11]==r[20] goto 21
  20                Ne            11   21  23  Binary                   0  if r[11]!=r[21] goto 23
  21                Column         0    5  22                           0  r[22]=customer.c_acctbal
  22                AggStep        0   22   6  avg                      0  accum=r[6] step(r[22])
  23              Next             0   10   0                           0
  24              AggFinal         0    6   0  avg                      0  accum=r[6]
  25              Copy             6    5   0                           0  r[5]=r[6]
  26              Copy             5    1   0                           0  r[1]=r[5]
  27            Return             4    0   1                           0
  28            OpenRead           1    8   0  k(8,B,B,B,B,B,B,B,B)     0  table=customer, root=8, iDb=0
  29            Rewind             1   65   0                           0  Rewind table customer
  30              Column           1    4  26                           0  r[26]=customer.c_phone
  31              Function         0   26  25  substr                   0  r[25]=func(r[26..28])
  32              Eq              25   29  39  Binary                   0  if r[25]==r[29] goto 39
  33              Eq              25   30  39  Binary                   0  if r[25]==r[30] goto 39
  34              Eq              25   31  39  Binary                   0  if r[25]==r[31] goto 39
  35              Eq              25   32  39  Binary                   0  if r[25]==r[32] goto 39
  36              Eq              25   33  39  Binary                   0  if r[25]==r[33] goto 39
  37              Eq              25   34  39  Binary                   0  if r[25]==r[34] goto 39
  38              Ne              25   35  64  Binary                   0  if r[25]!=r[35] goto 64
  39              BeginSubrtn     36    0   0                           0  r[36]=NULL
  40              Integer          0    2   0                           0  r[2]=0
  41              Integer          1   46   0                           0  r[46]=1; LIMIT counter
  42              IfNot           46   51   0                           0  if !r[46] goto 51
  43              OpenRead         2    9   0  k(9,B,B,B,B,B,B,B,B,B)   0  table=orders, root=9, iDb=0
  44              Rewind           2   51   0                           0  Rewind table orders
  45                Column         2    1  48                           0  r[48]=orders.o_custkey
  46                RowId          1   49   0                           0  r[49]=customer.rowid
  47                Ne            48   49  50  Binary                   0  if r[48]!=r[49] goto 50
  48                Integer        1    2   0                           0  r[2]=1
  49                DecrJumpZero  46   51   0                           0  if (--r[46]==0) goto 51
  50              Next             2   45   0                           0
  51            Return            36    0   1                           0
  52            Column             1    5  51                           0  r[51]=customer.c_acctbal
  53            Copy               1   52   0                           0  r[52]=r[1]
  54            Le                51   52  64  Binary                   0  if r[51]<=r[52] goto 64
  55            Copy               2   54   0                           0  r[54]=r[2]
  56            Not               54   53   0                           0  r[53]=!r[54]
  57            IfNot             53   64   1                           0  if !r[53] goto 64
  58            Column             1    4  55                           0  r[55]=customer.c_phone
  59            Integer            1   56   0                           0  r[56]=1
  60            Integer            2   57   0                           0  r[57]=2
  61            Function           0   55  23  substr                   0  r[23]=func(r[55..57])
  62            Column             1    5  24                           0  r[24]=customer.c_acctbal
  63            Yield              3    0   0                           0
  64          Next                 1   30   0                           0
  65          EndCoroutine         3    0   0                           0
  66          Null                 0   66  67                           0  r[66..67]=NULL
  67          SorterOpen           3    2   0  k(1,B)                   0  cursor=3
  68          Integer              0   63   0                           0  r[63]=0; clear group by abort flag
  69          Null                 0   64   0                           0  r[64]=NULL; initialize group by comparison registers to NULL
  70          Gosub               71  108   0                           0  ; go to clear accumulator subroutine
  71          InitCoroutine        3    0   2                           0
  72            Yield              3   78   0                           0
  73            Copy              23   69   0                           0  r[69]=r[23]
  74            Copy              24   70   0                           0  r[70]=r[24]
  75            MakeRecord        69    2  68                           0  r[68]=mkrec(r[69..70])
  76            SorterInsert       3   68   0  0                        0  key=r[68]
  77          Goto                 0   72   0                           0
  78          OpenPseudo           4   68   2                           0  2 columns in r[68]
  79          SorterSort           3   95   0                           0
  80            SorterData         3   68   4                           0  r[68]=data
  81            Column             4    0  72                           0  r[72]=pseudo.column 0
  82            Compare           64   72   1  k(1, Binary)             0  r[64..64]==r[72..72]
  83            Jump              84   88  84                           0  ; start new group if comparison is not equal
  84            Gosub             61   99   0                           0  ; check if ended group had data, and output if so
  85            Move              72   64   1                           0  r[64..64]=r[72..72]
  86            IfPos             63  111   0                           0  r[63]>0 -> r[63]-=0, goto 111; check abort flag
  87            Gosub             71  108   0                           0  ; goto clear accumulator subroutine
  88            AggStep            0   73  66  count                    0  accum=r[66] step(r[73])
  89            Column             4    1  74                           0  r[74]=pseudo.column 1
  90            AggStep            0   74  67  sum                      0  accum=r[67] step(r[74])
  91            If                62   93   0                           0  if r[62] goto 93; don't emit group columns if continuing existing group
  92            Column             4    0  65                           0  r[65]=pseudo.column 0
  93            Integer            1   62   0                           0  r[62]=1; indicate data in accumulator
  94          SorterNext           3   80   0                           0
  95          Gosub               61   99   0                           0  ; emit row for final group
  96          Goto                 0  111   0                           0  ; group by finished
  97          Integer              1   63   0                           0  r[63]=1
  98        Return                61    0   0                           0
  99        IfPos                 62  101   0                           0  r[62]>0 -> r[62]-=0, goto 101; output group by row subroutine start
 100      Return                  61    0   0                           0
 101      AggFinal                 0   66   0  count                    0  accum=r[66]
 102      AggFinal                 0   67   0  sum                      0  accum=r[67]
 103      Copy                    65   58   0                           0  r[58]=r[65]
 104      Copy                    66   59   0                           0  r[59]=r[66]
 105      Copy                    67   60   0                           0  r[60]=r[67]
 106      ResultRow               58    3   0                           0  output=r[58..60]
 107    Return                    61    0   0                           0
 108    Null                       0   65  67                           0  r[65..67]=NULL; clear accumulator subroutine start
 109    Integer                    0   62   0                           0  r[62]=0
 110  Return                      71    0   0                           0
 111  Halt                         0    0   0                           0
 112  Transaction                  0    1   8                           0  iDb=0 tx_mode=Read
 113  Real                         0   10   0  0.0                      0  r[10]=0
 114  Integer                      1   13   0                           0  r[13]=1
 115  Integer                      2   14   0                           0  r[14]=2
 116  String8                      0   15   0  20                       0  r[15]='20'
 117  String8                      0   16   0  14                       0  r[16]='14'
 118  String8                      0   17   0  21                       0  r[17]='21'
 119  String8                      0   18   0  28                       0  r[18]='28'
 120  String8                      0   19   0  15                       0  r[19]='15'
 121  String8                      0   20   0  24                       0  r[20]='24'
 122  String8                      0   21   0  27                       0  r[21]='27'
 123  Integer                      1   27   0                           0  r[27]=1
 124  Integer                      2   28   0                           0  r[28]=2
 125  String8                      0   29   0  20                       0  r[29]='20'
 126  String8                      0   30   0  14                       0  r[30]='14'
 127  String8                      0   31   0  21                       0  r[31]='21'
 128  String8                      0   32   0  28                       0  r[32]='28'
 129  String8                      0   33   0  15                       0  r[33]='15'
 130  String8                      0   34   0  24                       0  r[34]='24'
 131  String8                      0   35   0  27                       0  r[35]='27'
 132  Integer                      1   73   0                           0  r[73]=1
 133  Goto                         0    1   0                           0
