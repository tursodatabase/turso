---
source: tpch.sqltest
expression: |-
  select
          o_year,
          sum(cast(case
              when nation = 'INDIA' then volume
              else 0
          end as number)) / sum(volume) as mkt_share
      from
          (
              select
                  substr(o_orderdate, 1, 4) as o_year,
                  l_extendedprice * (1 - l_discount) as volume,
                  n2.n_name as nation
              from
                  part,
                  supplier,
                  lineitem,
                  orders,
                  customer,
                  nation n1,
                  nation n2,
                  region
              where
                  p_partkey = l_partkey
                  and s_suppkey = l_suppkey
                  and l_orderkey = o_orderkey
                  and o_custkey = c_custkey
                  and c_nationkey = n1.n_nationkey
                  and n1.n_regionkey = r_regionkey
                  and r_name = 'ASIA'
                  and s_nationkey = n2.n_nationkey
                  and o_orderdate between
                      '1995-01-01' and '1996-12-31'
                  and p_type = 'PROMO BRUSHED COPPER'
          ) as all_nations
      group by
          o_year
      order by
          o_year;
info:
  statement_type: SELECT
  tables:
  - part
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
`--SCAN all_nations
   |--SEARCH part USING INTEGER PRIMARY KEY (rowid=?)
   |--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
   |--SEARCH lineitem USING INDEX sqlite_autoindex_lineitem_1
   |--SCAN orders
   |--SEARCH customer USING INTEGER PRIMARY KEY (rowid=?)
   |--SEARCH n1 USING INTEGER PRIMARY KEY (rowid=?)
   |--SEARCH n2 USING INTEGER PRIMARY KEY (rowid=?)
   `--SEARCH region USING INTEGER PRIMARY KEY (rowid=?)

BYTECODE
addr  opcode                    p1   p2  p3  p4                                     p5  comment
   0          Init               0  107   0                                          0  Start at 107
   1          InitCoroutine      1   49   2                                          0
   2          OpenRead           0    4   0  k(9,B,B,B,B,B,B,B,B,B)                  0  table=part, root=4, iDb=0
   3          OpenRead           1    5   0  k(7,B,B,B,B,B,B,B)                      0  table=supplier, root=5, iDb=0
   4          OpenRead           2   10   0  k(17,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B)   0  table=lineitem, root=10, iDb=0
   5          OpenRead           3   11   0  k(3,B,B)                                0  index=sqlite_autoindex_lineitem_1, root=11, iDb=0
   6          OpenRead           4    9   0  k(9,B,B,B,B,B,B,B,B,B)                  0  table=orders, root=9, iDb=0
   7          OpenRead           5    8   0  k(8,B,B,B,B,B,B,B,B)                    0  table=customer, root=8, iDb=0
   8          OpenRead           6    2   0  k(4,B,B,B,B)                            0  table=nation, root=2, iDb=0
   9          OpenRead           7    2   0  k(4,B,B,B,B)                            0  table=nation, root=2, iDb=0
  10          OpenRead           8    3   0  k(3,B,B,B)                              0  table=region, root=3, iDb=0
  11          Rewind             4   48   0                                          0  Rewind table orders
  12            Column           4    4   5                                          0  r[5]=orders.o_orderdate
  13            Gt               6    5  47  Binary                                  0  if r[6]>r[5] goto 47
  14            Gt               5    7  47  Binary                                  0  if r[5]>r[7] goto 47
  15            Column           4    1   8                                          0  r[8]=orders.o_custkey
  16            SeekRowid        5    8  47                                          0  if (r[8]!=cursor 5 for table customer.rowid) goto 47
  17            Column           5    3   9                                          0  r[9]=customer.c_nationkey
  18            SeekRowid        6    9  47                                          0  if (r[9]!=cursor 6 for table nation.rowid) goto 47
  19            Column           6    2  10                                          0  r[10]=nation.n_regionkey
  20            SeekRowid        8   10  47                                          0  if (r[10]!=cursor 8 for table region.rowid) goto 47
  21            Column           8    1  12                                          0  r[12]=region.r_name
  22            Ne              12   13  47  Binary                                  0  if r[12]!=r[13] goto 47
  23            RowId            4   14   0                                          0  r[14]=orders.rowid
  24            SeekGE           3   47  14                                          0  key=[14..14]
  25              IdxGT          3   47  14                                          0  key=[14..14]
  26              DeferredSeek   3    2   0                                          0
  27              Column         2    1  15                                          0  r[15]=lineitem.l_partkey
  28              SeekRowid      0   15  46                                          0  if (r[15]!=cursor 0 for table part.rowid) goto 46
  29              Column         0    4  17                                          0  r[17]=part.p_type
  30              Ne            17   18  46  Binary                                  0  if r[17]!=r[18] goto 46
  31              Column         2    2  19                                          0  r[19]=lineitem.l_suppkey
  32              SeekRowid      1   19  46                                          0  if (r[19]!=cursor 1 for table supplier.rowid) goto 46
  33              Column         1    3  20                                          0  r[20]=supplier.s_nationkey
  34              SeekRowid      7   20  46                                          0  if (r[20]!=cursor 7 for table nation.rowid) goto 46
  35              Column         4    4  21                                          0  r[21]=orders.o_orderdate
  36              Integer        1   22   0                                          0  r[22]=1
  37              Integer        4   23   0                                          0  r[23]=4
  38              Function       0   21   2  substr                                  0  r[2]=func(r[21..23])
  39              Column         2    5  24                                          0  r[24]=lineitem.l_extendedprice
  40              Integer        1   26   0                                          0  r[26]=1
  41              Column         2    6  27                                          0  r[27]=lineitem.l_discount
  42              Subtract      26   27  25                                          0  r[25]=r[26]-r[27]
  43              Multiply      24   25   3                                          0  r[3]=r[24]*r[25]
  44              Column         7    1   4                                          0  r[4]=nation.n_name
  45              Yield          1    0   0                                          0
  46            Next             3   25   0                                          0
  47          Next               4   12   0                                          0
  48          EndCoroutine       1    0   0                                          0
  49          Null               0   35  36                                          0  r[35..36]=NULL
  50          SorterOpen         9    3   0  k(1,B)                                  0  cursor=9
  51          Integer            0   32   0                                          0  r[32]=0; clear group by abort flag
  52          Null               0   33   0                                          0  r[33]=NULL; initialize group by comparison registers to NULL
  53          Gosub             41  103   0                                          0  ; go to clear accumulator subroutine
  54          InitCoroutine      1    0   2                                          0
  55            Yield            1   71   0                                          0
  56            Copy             2   38   0                                          0  r[38]=r[2]
  57            Copy             4   43   0                                          0  r[43]=r[4]
  58            String8          0   44   0  INDIA                                   0  r[44]='INDIA'
  59            Integer          1   42   0                                          0  r[42]=1
  60            Eq              43   44  62  Binary                                  0  if r[43]==r[44] goto 62
  61            ZeroOrNull      43   42  44                                          0  ((r[43]=NULL)|(r[44]=NULL)) ? r[42]=NULL : r[42]=0
  62            IfNot           42   65   1                                          0  if !r[42] goto 65
  63            Copy             3   39   0                                          0  r[39]=r[3]
  64            Goto             0   66   0                                          0
  65            Integer          0   39   0                                          0  r[39]=0
  66            Cast            39    0   0                                          0  affinity(r[39]=Numeric)
  67            Copy             3   40   0                                          0  r[40]=r[3]
  68            MakeRecord      38    3  37                                          0  r[37]=mkrec(r[38..40])
  69            SorterInsert     9   37   0  0                                       0  key=r[37]
  70          Goto               0   55   0                                          0
  71          OpenPseudo        10   37   3                                          0  3 columns in r[37]
  72          SorterSort         9   89   0                                          0
  73            SorterData       9   37  10                                          0  r[37]=data
  74            Column          10    0  45                                          0  r[45]=pseudo.column 0
  75            Compare         33   45   1  k(1, Binary)                            0  r[33..33]==r[45..45]
  76            Jump            77   81  77                                          0  ; start new group if comparison is not equal
  77            Gosub           30   93   0                                          0  ; check if ended group had data, and output if so
  78            Move            45   33   1                                          0  r[33..33]=r[45..45]
  79            IfPos           32  106   0                                          0  r[32]>0 -> r[32]-=0, goto 106; check abort flag
  80            Gosub           41  103   0                                          0  ; goto clear accumulator subroutine
  81            Column          10    1  46                                          0  r[46]=pseudo.column 1
  82            AggStep          0   46  35  sum                                     0  accum=r[35] step(r[46])
  83            Column          10    2  47                                          0  r[47]=pseudo.column 2
  84            AggStep          0   47  36  sum                                     0  accum=r[36] step(r[47])
  85            If              31   87   0                                          0  if r[31] goto 87; don't emit group columns if continuing existing group
  86            Column          10    0  34                                          0  r[34]=pseudo.column 0
  87            Integer          1   31   0                                          0  r[31]=1; indicate data in accumulator
  88          SorterNext         9   73   0                                          0
  89          Gosub             30   93   0                                          0  ; emit row for final group
  90          Goto               0  106   0                                          0  ; group by finished
  91          Integer            1   32   0                                          0  r[32]=1
  92        Return              30    0   0                                          0
  93        IfPos               31   95   0                                          0  r[31]>0 -> r[31]-=0, goto 95; output group by row subroutine start
  94      Return                30    0   0                                          0
  95      AggFinal               0   35   0  sum                                     0  accum=r[35]
  96      AggFinal               0   36   0  sum                                     0  accum=r[36]
  97      Copy                  34   28   0                                          0  r[28]=r[34]
  98      Copy                  35   48   0                                          0  r[48]=r[35]
  99      Copy                  36   49   0                                          0  r[49]=r[36]
 100      Divide                48   49  29                                          0  r[29]=r[48]/r[49]
 101      ResultRow             28    2   0                                          0  output=r[28..29]
 102    Return                  30    0   0                                          0
 103    Null                     0   34  36                                          0  r[34..36]=NULL; clear accumulator subroutine start
 104    Integer                  0   31   0                                          0  r[31]=0
 105  Return                    41    0   0                                          0
 106  Halt                       0    0   0                                          0
 107  Transaction                0    1   8                                          0  iDb=0 tx_mode=Read
 108  String8                    0    6   0  1995-01-01                              0  r[6]='1995-01-01'
 109  String8                    0    7   0  1996-12-31                              0  r[7]='1996-12-31'
 110  String8                    0   13   0  ASIA                                    0  r[13]='ASIA'
 111  String8                    0   18   0  PROMO BRUSHED COPPER                    0  r[18]='PROMO BRUSHED COPPER'
 112  Goto                       0    1   0                                          0
