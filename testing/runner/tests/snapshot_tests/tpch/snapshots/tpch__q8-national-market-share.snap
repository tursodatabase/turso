---
source: tpch.sqltest
expression: |-
  select
          o_year,
          sum(cast(case
              when nation = 'INDIA' then volume
              else 0
          end as number)) / sum(volume) as mkt_share
      from
          (
              select
                  substr(o_orderdate, 1, 4) as o_year,
                  l_extendedprice * (1 - l_discount) as volume,
                  n2.n_name as nation
              from
                  part,
                  supplier,
                  lineitem,
                  orders,
                  customer,
                  nation n1,
                  nation n2,
                  region
              where
                  p_partkey = l_partkey
                  and s_suppkey = l_suppkey
                  and l_orderkey = o_orderkey
                  and o_custkey = c_custkey
                  and c_nationkey = n1.n_nationkey
                  and n1.n_regionkey = r_regionkey
                  and r_name = 'ASIA'
                  and s_nationkey = n2.n_nationkey
                  and o_orderdate between
                      '1995-01-01' and '1996-12-31'
                  and p_type = 'PROMO BRUSHED COPPER'
          ) as all_nations
      group by
          o_year
      order by
          o_year;
info:
  statement_type: SELECT
  tables:
  - part
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
`--SCAN all_nations
   |--SEARCH part USING INTEGER PRIMARY KEY (rowid=?)
   |--SEARCH supplier USING INTEGER PRIMARY KEY (rowid=?)
   |--SEARCH lineitem USING INDEX sqlite_autoindex_lineitem_1
   |--SCAN orders
   |--SEARCH customer USING INTEGER PRIMARY KEY (rowid=?)
   |--SEARCH n1 USING INTEGER PRIMARY KEY (rowid=?)
   |--SEARCH n2 USING INTEGER PRIMARY KEY (rowid=?)
   `--SEARCH region USING INTEGER PRIMARY KEY (rowid=?)

BYTECODE
addr  opcode                    p1   p2  p3  p4                                     p5  comment
   0          Init               0  108   0                                          0  Start at 108
   1          InitCoroutine      1   50   2                                          0
   2          OpenRead           0    4   0  k(9,B,B,B,B,B,B,B,B,B)                  0  table=part, root=4, iDb=0
   3          OpenRead           1    5   0  k(7,B,B,B,B,B,B,B)                      0  table=supplier, root=5, iDb=0
   4          OpenRead           2   10   0  k(17,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B)   0  table=lineitem, root=10, iDb=0
   5          OpenRead           3   11   0  k(3,B,B)                                0  index=sqlite_autoindex_lineitem_1, root=11, iDb=0
   6          OpenRead           4    9   0  k(9,B,B,B,B,B,B,B,B,B)                  0  table=orders, root=9, iDb=0
   7          OpenRead           5    8   0  k(8,B,B,B,B,B,B,B,B)                    0  table=customer, root=8, iDb=0
   8          OpenRead           6    2   0  k(4,B,B,B,B)                            0  table=nation, root=2, iDb=0
   9          OpenRead           7    2   0  k(4,B,B,B,B)                            0  table=nation, root=2, iDb=0
  10          OpenRead           8    3   0  k(3,B,B,B)                              0  table=region, root=3, iDb=0
  11          Rewind             4   49   0                                          0  Rewind table orders
  12            Column           4    4   7                                          0  r[7]=orders.o_orderdate
  13            Gt               6    7  48  Binary                                  0  if r[6]>r[7] goto 48
  14            Column           4    4   9                                          0  r[9]=orders.o_orderdate
  15            Gt               9   10  48  Binary                                  0  if r[9]>r[10] goto 48
  16            Column           4    1  11                                          0  r[11]=orders.o_custkey
  17            SeekRowid        5   11  48                                          0  if (r[11]!=cursor 5 for table customer.rowid) goto 48
  18            Column           5    3  12                                          0  r[12]=customer.c_nationkey
  19            SeekRowid        6   12  48                                          0  if (r[12]!=cursor 6 for table nation.rowid) goto 48
  20            Column           6    2  13                                          0  r[13]=nation.n_regionkey
  21            SeekRowid        8   13  48                                          0  if (r[13]!=cursor 8 for table region.rowid) goto 48
  22            Column           8    1  15                                          0  r[15]=region.r_name
  23            Ne              15   16  48  Binary                                  0  if r[15]!=r[16] goto 48
  24            RowId            4   17   0                                          0  r[17]=orders.rowid
  25            SeekGE           3   48  17                                          0  key=[17..17]
  26              IdxGT          3   48  17                                          0  key=[17..17]
  27              DeferredSeek   3    2   0                                          0
  28              Column         2    1  18                                          0  r[18]=lineitem.l_partkey
  29              SeekRowid      0   18  47                                          0  if (r[18]!=cursor 0 for table part.rowid) goto 47
  30              Column         0    4  20                                          0  r[20]=part.p_type
  31              Ne            20   21  47  Binary                                  0  if r[20]!=r[21] goto 47
  32              Column         2    2  22                                          0  r[22]=lineitem.l_suppkey
  33              SeekRowid      1   22  47                                          0  if (r[22]!=cursor 1 for table supplier.rowid) goto 47
  34              Column         1    3  23                                          0  r[23]=supplier.s_nationkey
  35              SeekRowid      7   23  47                                          0  if (r[23]!=cursor 7 for table nation.rowid) goto 47
  36              Column         4    4  24                                          0  r[24]=orders.o_orderdate
  37              Integer        1   25   0                                          0  r[25]=1
  38              Integer        4   26   0                                          0  r[26]=4
  39              Function       0   24   2  substr                                  0  r[2]=func(r[24..26])
  40              Column         2    5  27                                          0  r[27]=lineitem.l_extendedprice
  41              Integer        1   29   0                                          0  r[29]=1
  42              Column         2    6  30                                          0  r[30]=lineitem.l_discount
  43              Subtract      29   30  28                                          0  r[28]=r[29]-r[30]
  44              Multiply      27   28   3                                          0  r[3]=r[27]*r[28]
  45              Column         7    1   4                                          0  r[4]=nation.n_name
  46              Yield          1    0   0                                          0
  47            Next             3   26   0                                          0
  48          Next               4   12   0                                          0
  49          EndCoroutine       1    0   0                                          0
  50          Null               0   38  39                                          0  r[38..39]=NULL
  51          SorterOpen         9    3   0  k(1,B)                                  0  cursor=9
  52          Integer            0   35   0                                          0  r[35]=0; clear group by abort flag
  53          Null               0   36   0                                          0  r[36]=NULL; initialize group by comparison registers to NULL
  54          Gosub             44  104   0                                          0  ; go to clear accumulator subroutine
  55          InitCoroutine      1    0   2                                          0
  56            Yield            1   72   0                                          0
  57            Copy             2   41   0                                          0  r[41]=r[2]
  58            Copy             4   46   0                                          0  r[46]=r[4]
  59            String8          0   47   0  INDIA                                   0  r[47]='INDIA'
  60            Integer          1   45   0                                          0  r[45]=1
  61            Eq              46   47  63  Binary                                  0  if r[46]==r[47] goto 63
  62            ZeroOrNull      46   45  47                                          0  ((r[46]=NULL)|(r[47]=NULL)) ? r[45]=NULL : r[45]=0
  63            IfNot           45   66   1                                          0  if !r[45] goto 66
  64            Copy             3   42   0                                          0  r[42]=r[3]
  65            Goto             0   67   0                                          0
  66            Integer          0   42   0                                          0  r[42]=0
  67            Cast            42    0   0                                          0  affinity(r[42]=Numeric)
  68            Copy             3   43   0                                          0  r[43]=r[3]
  69            MakeRecord      41    3  40                                          0  r[40]=mkrec(r[41..43])
  70            SorterInsert     9   40   0  0                                       0  key=r[40]
  71          Goto               0   56   0                                          0
  72          OpenPseudo        10   40   3                                          0  3 columns in r[40]
  73          SorterSort         9   90   0                                          0
  74            SorterData       9   40  10                                          0  r[40]=data
  75            Column          10    0  48                                          0  r[48]=pseudo.column 0
  76            Compare         36   48   1  k(1, Binary)                            0  r[36..36]==r[48..48]
  77            Jump            78   82  78                                          0  ; start new group if comparison is not equal
  78            Gosub           33   94   0                                          0  ; check if ended group had data, and output if so
  79            Move            48   36   1                                          0  r[36..36]=r[48..48]
  80            IfPos           35  107   0                                          0  r[35]>0 -> r[35]-=0, goto 107; check abort flag
  81            Gosub           44  104   0                                          0  ; goto clear accumulator subroutine
  82            Column          10    1  49                                          0  r[49]=pseudo.column 1
  83            AggStep          0   49  38  sum                                     0  accum=r[38] step(r[49])
  84            Column          10    2  50                                          0  r[50]=pseudo.column 2
  85            AggStep          0   50  39  sum                                     0  accum=r[39] step(r[50])
  86            If              34   88   0                                          0  if r[34] goto 88; don't emit group columns if continuing existing group
  87            Column          10    0  37                                          0  r[37]=pseudo.column 0
  88            Integer          1   34   0                                          0  r[34]=1; indicate data in accumulator
  89          SorterNext         9   74   0                                          0
  90          Gosub             33   94   0                                          0  ; emit row for final group
  91          Goto               0  107   0                                          0  ; group by finished
  92          Integer            1   35   0                                          0  r[35]=1
  93        Return              33    0   0                                          0
  94        IfPos               34   96   0                                          0  r[34]>0 -> r[34]-=0, goto 96; output group by row subroutine start
  95      Return                33    0   0                                          0
  96      AggFinal               0   38   0  sum                                     0  accum=r[38]
  97      AggFinal               0   39   0  sum                                     0  accum=r[39]
  98      Copy                  37   31   0                                          0  r[31]=r[37]
  99      Copy                  38   51   0                                          0  r[51]=r[38]
 100      Copy                  39   52   0                                          0  r[52]=r[39]
 101      Divide                51   52  32                                          0  r[32]=r[51]/r[52]
 102      ResultRow             31    2   0                                          0  output=r[31..32]
 103    Return                  33    0   0                                          0
 104    Null                     0   37  39                                          0  r[37..39]=NULL; clear accumulator subroutine start
 105    Integer                  0   34   0                                          0  r[34]=0
 106  Return                    44    0   0                                          0
 107  Halt                       0    0   0                                          0
 108  Transaction                0    1   8                                          0  iDb=0 tx_mode=Read
 109  String8                    0    6   0  1995-01-01                              0  r[6]='1995-01-01'
 110  String8                    0   10   0  1996-12-31                              0  r[10]='1996-12-31'
 111  String8                    0   16   0  ASIA                                    0  r[16]='ASIA'
 112  String8                    0   21   0  PROMO BRUSHED COPPER                    0  r[21]='PROMO BRUSHED COPPER'
 113  Goto                       0    1   0                                          0
