---
source: tpch.sqltest
expression: |-
  select
          c_name,
          c_custkey,
          o_orderkey,
          o_orderdate,
          o_totalprice,
          sum(l_quantity)
      from
          customer,
          orders,
          lineitem
      where
          o_orderkey in (
              select
                  l_orderkey
              from
                  lineitem
              group by
                  l_orderkey having
                      sum(l_quantity) > 313
          )
          and c_custkey = o_custkey
          and o_orderkey = l_orderkey
      group by
          c_name,
          c_custkey,
          o_orderkey,
          o_orderdate,
          o_totalprice
      order by
          o_totalprice desc,
          o_orderdate
      limit 100;
info:
  statement_type: SELECT
  tables:
  - customer
  - lineitem
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SCAN lineitem USING INDEX sqlite_autoindex_lineitem_1
|--SEARCH customer USING INTEGER PRIMARY KEY (rowid=?)
|--SCAN orders
`--SEARCH lineitem USING INDEX sqlite_autoindex_lineitem_1

BYTECODE
addr  opcode                           p1   p2  p3  p4                                            p5  comment
   0                  Init              0  129   0                                                 0  Start at 129
   1                  Once             40    0   0                                                 0  goto 40
   2                  OpenEphemeral     0    0   0                                                 0  cursor=0 is_table=false
   3                  Null              0    7   0                                                 0  r[7]=NULL
   4                  Integer           0    4   0                                                 0  r[4]=0; clear group by abort flag
   5                  Null              0    5   0                                                 0  r[5]=NULL; initialize group by comparison registers to NULL
   6                  Gosub            11   37   0                                                 0  ; go to clear accumulator subroutine
   7                  OpenRead          1   10   0  k(17,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B)          0  table=lineitem, root=10, iDb=0
   8                  OpenRead          2   11   0  k(3,B,B)                                       0  index=sqlite_autoindex_lineitem_1, root=11, iDb=0
   9                  Rewind            2   24   0                                                 0  Rewind index sqlite_autoindex_lineitem_1
  10                    DeferredSeek    2    1   0                                                 0
  11                    Column          1    0   9                                                 0  r[9]=lineitem.l_orderkey
  12                    Column          1    4  10                                                 0  r[10]=lineitem.l_quantity
  13                    Compare         5    9   1  k(1, Binary)                                   0  r[5..5]==r[9..9]
  14                    Jump           15   19  15                                                 0  ; start new group if comparison is not equal
  15                    Gosub           2   28   0                                                 0  ; check if ended group had data, and output if so
  16                    Move            9    5   1                                                 0  r[5..5]=r[9..9]
  17                    IfPos           4   40   0                                                 0  r[4]>0 -> r[4]-=0, goto 40; check abort flag
  18                    Gosub          11   37   0                                                 0  ; goto clear accumulator subroutine
  19                    AggStep         0   10   7  sum                                            0  accum=r[7] step(r[10])
  20                    If              3   22   0                                                 0  if r[3] goto 22; don't emit group columns if continuing existing group
  21                    Column          1    0   6                                                 0  r[6]=lineitem.l_orderkey
  22                    Integer         1    3   0                                                 0  r[3]=1; indicate data in accumulator
  23                  Next              2   10   0                                                 0
  24                  Gosub             2   28   0                                                 0  ; emit row for final group
  25                  Goto              0   40   0                                                 0  ; group by finished
  26                  Integer           1    4   0                                                 0  r[4]=1
  27                Return              2    0   0                                                 0
  28                IfPos               3   30   0                                                 0  r[3]>0 -> r[3]-=0, goto 30; output group by row subroutine start
  29              Return                2    0   0                                                 0
  30              AggFinal              0    7   0  sum                                            0  accum=r[7]
  31              Copy                  7   13   0                                                 0  r[13]=r[7]
  32              Le                   13   14  29  Binary                                         0  if r[13]<=r[14] goto 29
  33              Copy                  6    1   0                                                 0  r[1]=r[6]
  34              MakeRecord            1    1  15                                                 0  r[15]=mkrec(r[1..1]); for ephemeral_index_where_sub_t4
  35              IdxInsert             0   15   0                                                 8  key=r[15]
  36            Return                  2    0   0                                                 0
  37            Null                    0    6   7                                                 0  r[6..7]=NULL; clear accumulator subroutine start
  38            Integer                 0    3   0                                                 0  r[3]=0
  39          Return                   11    0   0                                                 0
  40          Null                      0   35   0                                                 0  r[35]=NULL
  41          SorterOpen                3    6   0  k(5,-B,B,B,B,-B)                               0  cursor=3
  42          Integer                   0   24   0                                                 0  r[24]=0; clear group by abort flag
  43          Null                      0   25  29                                                 0  r[25..29]=NULL; initialize group by comparison registers to NULL
  44          Gosub                    43  125   0                                                 0  ; go to clear accumulator subroutine
  45          Integer                 100   44   0                                                 0  r[44]=100; LIMIT counter
  46          IfNot                    44   85   0                                                 0  if !r[44] goto 85
  47          OpenRead                  5    8   0  k(8,B,B,B,B,B,B,B,B)                           0  table=customer, root=8, iDb=0
  48          OpenRead                  6    9   0  k(9,B,B,B,B,B,B,B,B,B)                         0  table=orders, root=9, iDb=0
  49          OpenRead                  7   10   0  k(17,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B)          0  table=lineitem, root=10, iDb=0
  50          OpenRead                  8   11   0  k(3,B,B)                                       0  index=sqlite_autoindex_lineitem_1, root=11, iDb=0
  51          Rewind                    6   85   0                                                 0  Rewind table orders
  52            Integer                 0   45   0                                                 0  r[45]=0
  53            RowId                   6   46   0                                                 0  r[46]=orders.rowid
  54            Affinity               46    1   0                                                 0  r[46..47] = D
  55            NotFound                0   57  46                                                 0  if not found goto 57
  56            Goto                    0   63   0                                                 0
  57            Rewind                  0   65   0                                                 0  Rewind  ephemeral_index_where_sub_t4
  58              Column                0    0  47                                                 0  r[47]=ephemeral_index_where_sub_t4.l_orderkey
  59              Ne                   46   47  61  Binary                                         0  if r[46]!=r[47] goto 61
  60              Goto                  0   67   0                                                 0
  61            Next                    0   58   0                                                 0
  62            Goto                    0   65   0                                                 0
  63            Integer                 1   45   0                                                 0  r[45]=1
  64            Goto                    0   68   0                                                 0
  65            Integer                 0   45   0                                                 0  r[45]=0
  66            Goto                    0   68   0                                                 0
  67            Null                    0   45   0                                                 0  r[45]=NULL
  68            IfNot                  45   84   1                                                 0  if !r[45] goto 84
  69            Column                  6    1  48                                                 0  r[48]=orders.o_custkey
  70            SeekRowid               5   48  84                                                 0  if (r[48]!=cursor 5 for table customer.rowid) goto 84
  71            RowId                   6   49   0                                                 0  r[49]=orders.rowid
  72            SeekGE                  8   84  49                                                 0  key=[49..49]
  73              IdxGT                 8   84  49                                                 0  key=[49..49]
  74              DeferredSeek          8    7   0                                                 0
  75              Column                6    3  37                                                 0  r[37]=orders.o_totalprice
  76              Column                6    4  38                                                 0  r[38]=orders.o_orderdate
  77              Column                5    1  39                                                 0  r[39]=customer.c_name
  78              RowId                 5   40   0                                                 0  r[40]=customer.rowid
  79              RowId                 6   41   0                                                 0  r[41]=orders.rowid
  80              Column                7    4  42                                                 0  r[42]=lineitem.l_quantity
  81              MakeRecord           37    6  36                                                 0  r[36]=mkrec(r[37..42])
  82              SorterInsert          3   36   0  0                                              0  key=r[36]
  83            Next                    8   73   0                                                 0
  84          Next                      6   52   0                                                 0
  85          OpenPseudo                4   36   6                                                 0  6 columns in r[36]
  86          SorterSort                3  109   0                                                 0
  87            SorterData              3   36   4                                                 0  r[36]=data
  88            Column                  4    0  50                                                 0  r[50]=pseudo.column 0
  89            Column                  4    1  51                                                 0  r[51]=pseudo.column 1
  90            Column                  4    2  52                                                 0  r[52]=pseudo.column 2
  91            Column                  4    3  53                                                 0  r[53]=pseudo.column 3
  92            Column                  4    4  54                                                 0  r[54]=pseudo.column 4
  93            Compare                25   50   5  k(5, Binary, Binary, Binary, Binary, Binary)   0  r[25..29]==r[50..54]
  94            Jump                   95   99  95                                                 0  ; start new group if comparison is not equal
  95            Gosub                  22  113   0                                                 0  ; check if ended group had data, and output if so
  96            Move                   50   25   5                                                 0  r[25..29]=r[50..54]
  97            IfPos                  24  128   0                                                 0  r[24]>0 -> r[24]-=0, goto 128; check abort flag
  98            Gosub                  43  125   0                                                 0  ; goto clear accumulator subroutine
  99            Column                  4    5  55                                                 0  r[55]=pseudo.column 5
 100            AggStep                 0   55  35  sum                                            0  accum=r[35] step(r[55])
 101            If                     23  107   0                                                 0  if r[23] goto 107; don't emit group columns if continuing existing group
 102            Column                  4    0  30                                                 0  r[30]=pseudo.column 0
 103            Column                  4    1  31                                                 0  r[31]=pseudo.column 1
 104            Column                  4    2  32                                                 0  r[32]=pseudo.column 2
 105            Column                  4    3  33                                                 0  r[33]=pseudo.column 3
 106            Column                  4    4  34                                                 0  r[34]=pseudo.column 4
 107            Integer                 1   23   0                                                 0  r[23]=1; indicate data in accumulator
 108          SorterNext                3   87   0                                                 0
 109          Gosub                    22  113   0                                                 0  ; emit row for final group
 110          Goto                      0  128   0                                                 0  ; group by finished
 111          Integer                   1   24   0                                                 0  r[24]=1
 112        Return                     22    0   0                                                 0
 113        IfPos                      23  115   0                                                 0  r[23]>0 -> r[23]-=0, goto 115; output group by row subroutine start
 114      Return                       22    0   0                                                 0
 115      AggFinal                      0   35   0  sum                                            0  accum=r[35]
 116      Copy                         32   16   0                                                 0  r[16]=r[32]
 117      Copy                         33   17   0                                                 0  r[17]=r[33]
 118      Copy                         34   18   0                                                 0  r[18]=r[34]
 119      Copy                         31   19   0                                                 0  r[19]=r[31]
 120      Copy                         30   20   0                                                 0  r[20]=r[30]
 121      Copy                         35   21   0                                                 0  r[21]=r[35]
 122      ResultRow                    16    6   0                                                 0  output=r[16..21]
 123      DecrJumpZero                 44  128   0                                                 0  if (--r[44]==0) goto 128
 124    Return                         22    0   0                                                 0
 125    Null                            0   30  35                                                 0  r[30..35]=NULL; clear accumulator subroutine start
 126    Integer                         0   23   0                                                 0  r[23]=0
 127  Return                           43    0   0                                                 0
 128  Halt                              0    0   0                                                 0
 129  Transaction                       0    1   8                                                 0  iDb=0 tx_mode=Read
 130  Integer                         313   14   0                                                 0  r[14]=313
 131  Goto                              0    1   0                                                 0
