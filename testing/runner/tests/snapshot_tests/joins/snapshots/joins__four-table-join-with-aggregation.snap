---
source: joins.sqltest
expression: "SELECT\n        c.name AS customer_name,\n        c.city,\n        COUNT(DISTINCT o.order_id) AS order_count,\n        SUM(oi.quantity * oi.unit_price) AS total_spent\n    FROM\n        customers c\n    INNER JOIN orders o ON c.customer_id = o.customer_id\n    INNER JOIN order_items oi ON o.order_id = oi.order_id\n    INNER JOIN products p ON oi.product_id = p.product_id\n    WHERE\n        p.category = 'Electronics'\n    GROUP BY\n        c.customer_id, c.name, c.city\n    ORDER BY\n        total_spent DESC;"
info:
  statement_type: SELECT
  tables:
    - c.customer_id
    - customers
    - o.order_id
    - oi.product_id
    - order_items
    - orders
    - products
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
|--SEARCH c USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH o USING INTEGER PRIMARY KEY (rowid=?)
|--SEARCH oi USING INDEX idx_order_items_product_id
|--SCAN products AS p
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                            p1  p2  p3  p4                            p5  comment
   0          Init                       0  85   0                                 0  Start at 85
   1          SorterOpen                 0   1   0  k(1,-B)                        0  cursor=0
   2          Null                       0  15  16                                 0  r[15..16]=NULL
   3          SorterOpen                 1   5   0  k(3,-B,-B,-B)                  0  cursor=1
   4          Integer                    0   8   0                                 0  r[8]=0; clear group by abort flag
   5          Null                       0   9  11                                 0  r[9..11]=NULL; initialize group by comparison registers to NULL
   6          Gosub                     23  71   0                                 0  ; go to clear accumulator subroutine
   7          OpenRead                   3   2   0  k(5,B,B,B,B,B)                 0  table=customers, root=2, iDb=0
   8          OpenRead                   4   4   0  k(5,B,B,B,B,B)                 0  table=orders, root=4, iDb=0
   9          OpenRead                   5   5   0  k(5,B,B,B,B,B)                 0  table=order_items, root=5, iDb=0
  10          OpenRead                   6  10   0  k(2,B)                         0  index=idx_order_items_product_id, root=10, iDb=0
  11          OpenRead                   7   3   0  k(5,B,B,B,B,B)                 0  table=products, root=3, iDb=0
  12          Rewind                     7  34   0                                 0  Rewind table products
  13            Column                   7   2  25                                 0  r[25]=products.category
  14            Ne                      25  26  33  Binary                         0  if r[25]!=r[26] goto 33
  15            RowId                    7  27   0                                 0  r[27]=products.rowid
  16            SeekGE                   6  33  27                                 0  key=[27..27]
  17              IdxGT                  6  33  27                                 0  key=[27..27]
  18              DeferredSeek           6   5   0                                 0
  19              Column                 5   1  28                                 0  r[28]=order_items.order_id
  20              SeekRowid              4  28  32                                 0  if (r[28]!=cursor 4 for table orders.rowid) goto 32
  21              Column                 4   1  29                                 0  r[29]=orders.customer_id
  22              SeekRowid              3  29  32                                 0  if (r[29]!=cursor 3 for table customers.rowid) goto 32
  23              RowId                  3  18   0                                 0  r[18]=customers.rowid
  24              Column                 3   1  19                                 0  r[19]=customers.name
  25              Column                 3   3  20                                 0  r[20]=customers.city
  26              RowId                  4  21   0                                 0  r[21]=orders.rowid
  27              Column                 5   3  30                                 0  r[30]=order_items.quantity
  28              Column                 5   4  31                                 0  r[31]=order_items.unit_price
  29              Multiply              30  31  22                                 0  r[22]=r[30]*r[31]
  30              MakeRecord            18   5  17                                 0  r[17]=mkrec(r[18..22])
  31              SorterInsert           1  17   0  0                              0  key=r[17]
  32            Next                     6  17   0                                 0
  33          Next                       7  13   0                                 0
  34          OpenPseudo                 2  17   5                                 0  5 columns in r[17]
  35          SorterSort                 1  56   0                                 0
  36            SorterData               1  17   2                                 0  r[17]=data
  37            Column                   2   0  32                                 0  r[32]=pseudo.column 0
  38            Column                   2   1  33                                 0  r[33]=pseudo.column 1
  39            Column                   2   2  34                                 0  r[34]=pseudo.column 2
  40            Compare                  9  32   3  k(3, Binary, Binary, Binary)   0  r[9..11]==r[32..34]
  41            Jump                    42  46  42                                 0  ; start new group if comparison is not equal
  42            Gosub                    6  60   0                                 0  ; check if ended group had data, and output if so
  43            Move                    32   9   3                                 0  r[9..11]=r[32..34]
  44            IfPos                    8  75   0                                 0  r[8]>0 -> r[8]-=0, goto 75; check abort flag
  45            Gosub                   23  71   0                                 0  ; goto clear accumulator subroutine
  46            Column                   2   3  35                                 0  r[35]=pseudo.column 3
  47            HashDistinct    1073741824  35   1  jmp=49                         0
  48            AggStep                  0  35  15  count                          0  accum=r[15] step(r[35])
  49            Column                   2   4  36                                 0  r[36]=pseudo.column 4
  50            AggStep                  0  36  16  sum                            0  accum=r[16] step(r[36])
  51            If                       7  54   0                                 0  if r[7] goto 54; don't emit group columns if continuing existing group
  52            Column                   2   1  12                                 0  r[12]=pseudo.column 1
  53            Column                   2   2  13                                 0  r[13]=pseudo.column 2
  54            Integer                  1   7   0                                 0  r[7]=1; indicate data in accumulator
  55          SorterNext                 1  36   0                                 0
  56          Gosub                      6  60   0                                 0  ; emit row for final group
  57          Goto                       0  75   0                                 0  ; group by finished
  58          Integer                    1   8   0                                 0  r[8]=1
  59        Return                       6   0   0                                 0
  60        IfPos                        7  62   0                                 0  r[7]>0 -> r[7]-=0, goto 62; output group by row subroutine start
  61      Return                         6   0   0                                 0
  62      AggFinal                       0  15   0  count                          0  accum=r[15]
  63      AggFinal                       0  16   0  sum                            0  accum=r[16]
  64      Copy                          16  37   0                                 0  r[37]=r[16]
  65      Copy                          12  38   0                                 0  r[38]=r[12]
  66      Copy                          13  39   0                                 0  r[39]=r[13]
  67      Copy                          15  40   0                                 0  r[40]=r[15]
  68      MakeRecord                    37   4   5                                 0  r[5]=mkrec(r[37..40])
  69      SorterInsert                   0   5   0  0                              0  key=r[5]
  70    Return                           6   0   0                                 0
  71    Null                             0  12  16                                 0  r[12..16]=NULL; clear accumulator subroutine start
  72    HashClear               1073741824   0   0                                 0
  73    Integer                          0   7   0                                 0  r[7]=0
  74  Return                            23   0   0                                 0
  75  OpenPseudo                         8   5   4                                 0  4 columns in r[5]
  76  SorterSort                         0  84   0                                 0
  77    SorterData                       0   5   8                                 0  r[5]=data
  78    Column                           8   1   1                                 0  r[1]=pseudo.column 1
  79    Column                           8   2   2                                 0  r[2]=pseudo.column 2
  80    Column                           8   3   3                                 0  r[3]=pseudo.column 3
  81    Column                           8   0   4                                 0  r[4]=pseudo.column 0
  82    ResultRow                        1   4   0                                 0  output=r[1..4]
  83  SorterNext                         0  77   0                                 0
  84  Halt                               0   0   0                                 0
  85  Transaction                        0   1  10                                 0  iDb=0 tx_mode=Read
  86  String8                            0  26   0  Electronics                    0  r[26]='Electronics'
  87  Goto                               0   1   0                                 0
