---
source: joins.sqltest
expression: "SELECT\n        c.name,\n        c.city,\n        recent_orders.order_count,\n        recent_orders.total_spent\n    FROM\n        customers c\n    INNER JOIN (\n        SELECT\n            customer_id,\n            COUNT(*) AS order_count,\n            SUM(total_amount) AS total_spent\n        FROM\n            orders\n        WHERE\n            order_date >= '2024-01-01'\n        GROUP BY\n            customer_id\n    ) AS recent_orders ON c.customer_id = recent_orders.customer_id\n    ORDER BY\n        recent_orders.total_spent DESC;"
info:
  statement_type: SELECT
  tables:
    - c.customer_id
    - customers
    - orders
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
|--SEARCH c USING INTEGER PRIMARY KEY (rowid=?)
|--SCAN recent_orders
|  `--SCAN orders USING INDEX idx_orders_customer_id
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                  p1  p2  p3  p4              p5  comment
   0          Init             0  66   0                   0  Start at 66
   1          InitCoroutine    1  43   2                   0
   2          Null             0  10  11                   0  r[10..11]=NULL
   3          Integer          0   7   0                   0  r[7]=0; clear group by abort flag
   4          Null             0   8   0                   0  r[8]=NULL; initialize group by comparison registers to NULL
   5          Gosub           15  39   0                   0  ; go to clear accumulator subroutine
   6          OpenRead         0   4   0  k(5,B,B,B,B,B)   0  table=orders, root=4, iDb=0
   7          OpenRead         1   8   0  k(2,B)           0  index=idx_orders_customer_id, root=8, iDb=0
   8          Rewind           1  26   0                   0  Rewind index idx_orders_customer_id
   9            DeferredSeek   1   0   0                   0
  10            Column         0   2  17                   0  r[17]=orders.order_date
  11            Lt            17  18  25  Binary           0  if r[17]<r[18] goto 25
  12            Column         0   1  13                   0  r[13]=orders.customer_id
  13            Column         0   4  14                   0  r[14]=orders.total_amount
  14            Compare        8  13   1  k(1, Binary)     0  r[8..8]==r[13..13]
  15            Jump          16  20  16                   0  ; start new group if comparison is not equal
  16            Gosub          5  30   0                   0  ; check if ended group had data, and output if so
  17            Move          13   8   1                   0  r[8..8]=r[13..13]
  18            IfPos          7  42   0                   0  r[7]>0 -> r[7]-=0, goto 42; check abort flag
  19            Gosub         15  39   0                   0  ; goto clear accumulator subroutine
  20            AggStep        0  19  10  count            0  accum=r[10] step(r[19])
  21            AggStep        0  14  11  sum              0  accum=r[11] step(r[14])
  22            If             6  24   0                   0  if r[6] goto 24; don't emit group columns if continuing existing group
  23            Column         0   1   9                   0  r[9]=orders.customer_id
  24            Integer        1   6   0                   0  r[6]=1; indicate data in accumulator
  25          Next             1   9   0                   0
  26          Gosub            5  30   0                   0  ; emit row for final group
  27          Goto             0  42   0                   0  ; group by finished
  28          Integer          1   7   0                   0  r[7]=1
  29        Return             5   0   0                   0
  30        IfPos              6  32   0                   0  r[6]>0 -> r[6]-=0, goto 32; output group by row subroutine start
  31      Return               5   0   0                   0
  32      AggFinal             0  10   0  count            0  accum=r[10]
  33      AggFinal             0  11   0  sum              0  accum=r[11]
  34      Copy                 9   2   0                   0  r[2]=r[9]
  35      Copy                10   3   0                   0  r[3]=r[10]
  36      Copy                11   4   0                   0  r[4]=r[11]
  37      Yield                1   0   0                   0
  38    Return                 5   0   0                   0
  39    Null                   0   9  11                   0  r[9..11]=NULL; clear accumulator subroutine start
  40    Integer                0   6   0                   0  r[6]=0
  41  Return                  15   0   0                   0
  42  EndCoroutine             1   0   0                   0
  43  SorterOpen               2   1   0  k(1,-B)          0  cursor=2
  44  OpenRead                 3   2   0  k(5,B,B,B,B,B)   0  table=customers, root=2, iDb=0
  45  InitCoroutine            1   0   2                   0
  46    Yield                  1  56   0                   0
  47    Copy                   2  25   0                   0  r[25]=r[2]
  48    SeekRowid              3  25  55                   0  if (r[25]!=cursor 3 for table customers.rowid) goto 55
  49    Copy                   4  26   0                   0  r[26]=r[4]
  50    Column                 3   1  27                   0  r[27]=customers.name
  51    Column                 3   3  28                   0  r[28]=customers.city
  52    Copy                   3  29   0                   0  r[29]=r[3]
  53    MakeRecord            26   4  24                   0  r[24]=mkrec(r[26..29])
  54    SorterInsert           2  24   0  0                0  key=r[24]
  55  Goto                     0  46   0                   0
  56  OpenPseudo               4  24   4                   0  4 columns in r[24]
  57  SorterSort               2  65   0                   0
  58    SorterData             2  24   4                   0  r[24]=data
  59    Column                 4   1  20                   0  r[20]=pseudo.column 1
  60    Column                 4   2  21                   0  r[21]=pseudo.column 2
  61    Column                 4   3  22                   0  r[22]=pseudo.column 3
  62    Column                 4   0  23                   0  r[23]=pseudo.column 0
  63    ResultRow             20   4   0                   0  output=r[20..23]
  64  SorterNext               2  58   0                   0
  65  Halt                     0   0   0                   0
  66  Transaction              0   1  10                   0  iDb=0 tx_mode=Read
  67  String8                  0  18   0  2024-01-01       0  r[18]='2024-01-01'
  68  Integer                  1  19   0                   0  r[19]=1
  69  Goto                     0   1   0                   0
