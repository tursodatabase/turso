---
source: subqueries.sqltest
expression: "WITH category_stats AS (\n        SELECT\n            category_id,\n            count(*) AS product_count,\n            avg(price) AS avg_price,\n            sum(stock) AS total_stock\n        FROM products\n        GROUP BY category_id\n    )\n    SELECT c.name, cs.product_count, cs.avg_price\n    FROM category_stats cs\n    JOIN categories c ON c.id = cs.category_id\n    WHERE cs.product_count > 5;"
info:
  statement_type: WITH (CTE)
  tables:
    - c.id
    - categories
    - category_stats
    - products
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
|--SCAN category_stats AS cs
|  `--SCAN products USING INDEX idx_products_category
`--SEARCH c USING INTEGER PRIMARY KEY (rowid=?)

BYTECODE
addr  opcode                  p1  p2  p3  p4              p5  comment
   0          Init             0  59   0                   0  Start at 59
   1          InitCoroutine    1  46   2                   0
   2          Null             0  11  13                   0  r[11..13]=NULL
   3          Integer          0   8   0                   0  r[8]=0; clear group by abort flag
   4          Null             0   9   0                   0  r[9]=NULL; initialize group by comparison registers to NULL
   5          Gosub           18  42   0                   0  ; go to clear accumulator subroutine
   6          OpenRead         0   2   0  k(5,B,B,B,B,B)   0  table=products, root=2, iDb=0
   7          OpenRead         1   8   0  k(2,B)           0  index=idx_products_category, root=8, iDb=0
   8          Rewind           1  27   0                   0  Rewind index idx_products_category
   9            DeferredSeek   1   0   0                   0
  10            Column         0   2  15                   0  r[15]=products.category_id
  11            Column         0   3  16                   0  r[16]=products.price
  12            RealAffinity  16   0   0                   0
  13            Column         0   4  17  0                0  r[17]=products.stock
  14            Compare        9  15   1  k(1, Binary)     0  r[9..9]==r[15..15]
  15            Jump          16  20  16                   0  ; start new group if comparison is not equal
  16            Gosub          6  31   0                   0  ; check if ended group had data, and output if so
  17            Move          15   9   1                   0  r[9..9]=r[15..15]
  18            IfPos          8  45   0                   0  r[8]>0 -> r[8]-=0, goto 45; check abort flag
  19            Gosub         18  42   0                   0  ; goto clear accumulator subroutine
  20            AggStep        0  19  11  count            0  accum=r[11] step(r[19])
  21            AggStep        0  16  12  avg              0  accum=r[12] step(r[16])
  22            AggStep        0  17  13  sum              0  accum=r[13] step(r[17])
  23            If             7  25   0                   0  if r[7] goto 25; don't emit group columns if continuing existing group
  24            Column         0   2  10                   0  r[10]=products.category_id
  25            Integer        1   7   0                   0  r[7]=1; indicate data in accumulator
  26          Next             1   9   0                   0
  27          Gosub            6  31   0                   0  ; emit row for final group
  28          Goto             0  45   0                   0  ; group by finished
  29          Integer          1   8   0                   0  r[8]=1
  30        Return             6   0   0                   0
  31        IfPos              7  33   0                   0  r[7]>0 -> r[7]-=0, goto 33; output group by row subroutine start
  32      Return               6   0   0                   0
  33      AggFinal             0  11   0  count            0  accum=r[11]
  34      AggFinal             0  12   0  avg              0  accum=r[12]
  35      AggFinal             0  13   0  sum              0  accum=r[13]
  36      Copy                10   2   0                   0  r[2]=r[10]
  37      Copy                11   3   0                   0  r[3]=r[11]
  38      Copy                12   4   0                   0  r[4]=r[12]
  39      Copy                13   5   0                   0  r[5]=r[13]
  40      Yield                1   0   0                   0
  41    Return                 6   0   0                   0
  42    Null                   0  10  13                   0  r[10..13]=NULL; clear accumulator subroutine start
  43    Integer                0   7   0                   0  r[7]=0
  44  Return                  18   0   0                   0
  45  EndCoroutine             1   0   0                   0
  46  OpenRead                 2   3   0  k(3,B,B,B)       0  table=categories, root=3, iDb=0
  47  InitCoroutine            1   0   2                   0
  48    Yield                  1  58   0                   0
  49    Copy                   3  24   0                   0  r[24]=r[3]
  50    Le                    24  25  57  Binary           0  if r[24]<=r[25] goto 57
  51    Copy                   2  26   0                   0  r[26]=r[2]
  52    SeekRowid              2  26  57                   0  if (r[26]!=cursor 2 for table categories.rowid) goto 57
  53    Column                 2   1  20                   0  r[20]=categories.name
  54    Copy                   3  21   0                   0  r[21]=r[3]
  55    Copy                   4  22   0                   0  r[22]=r[4]
  56    ResultRow             20   3   0                   0  output=r[20..22]
  57  Goto                     0  48   0                   0
  58  Halt                     0   0   0                   0
  59  Transaction              0   1  11                   0  iDb=0 tx_mode=Read
  60  Integer                  1  19   0                   0  r[19]=1
  61  Integer                  5  25   0                   0  r[25]=5
  62  Goto                     0   1   0                   0
