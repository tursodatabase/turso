---
source: subqueries.sqltest
expression: |-
  WITH category_stats AS (
          SELECT
              category_id,
              count(*) AS product_count,
              avg(price) AS avg_price,
              sum(stock) AS total_stock
          FROM products
          GROUP BY category_id
      )
      SELECT c.name, cs.product_count, cs.avg_price
      FROM category_stats cs
      JOIN categories c ON c.id = cs.category_id
      WHERE cs.product_count > 5;
info:
  statement_type: WITH (CTE)
  tables:
  - c.id
  - categories
  - category_stats
  - products
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SEARCH cs USING INDEX ephemeral_subquery_t2
|  `--SCAN products USING INDEX idx_products_category
`--SCAN categories AS c

BYTECODE
addr  opcode                  p1  p2  p3  p4              p5  comment
   0          Init             0  66   0                   0  Start at 66
   1          OpenEphemeral    0   0   0                   0  cursor=0 is_table=false
   2          Null             0  14  16                   0  r[14..16]=NULL
   3          Integer          0  11   0                   0  r[11]=0; clear group by abort flag
   4          Null             0  12   0                   0  r[12]=NULL; initialize group by comparison registers to NULL
   5          Gosub           21  45   0                   0  ; go to clear accumulator subroutine
   6          OpenRead         1   2   0  k(5,B,B,B,B,B)   0  table=products, root=2, iDb=0
   7          OpenRead         2   8   0  k(2,B)           0  index=idx_products_category, root=8, iDb=0
   8          Rewind           2  27   0                   0  Rewind index idx_products_category
   9            DeferredSeek   2   1   0                   0
  10            Column         1   2  18                   0  r[18]=products.category_id
  11            Column         1   3  19                   0  r[19]=products.price
  12            RealAffinity  19   0   0                   0
  13            Column         1   4  20  0                0  r[20]=products.stock
  14            Compare       12  18   1  k(1, Binary)     0  r[12..12]==r[18..18]
  15            Jump          16  20  16                   0  ; start new group if comparison is not equal
  16            Gosub          9  31   0                   0  ; check if ended group had data, and output if so
  17            Move          18  12   1                   0  r[12..12]=r[18..18]
  18            IfPos         11  48   0                   0  r[11]>0 -> r[11]-=0, goto 48; check abort flag
  19            Gosub         21  45   0                   0  ; goto clear accumulator subroutine
  20            AggStep        0  22  14  count            0  accum=r[14] step(r[22])
  21            AggStep        0  19  15  avg              0  accum=r[15] step(r[19])
  22            AggStep        0  20  16  sum              0  accum=r[16] step(r[20])
  23            If            10  25   0                   0  if r[10] goto 25; don't emit group columns if continuing existing group
  24            Column         1   2  13                   0  r[13]=products.category_id
  25            Integer        1  10   0                   0  r[10]=1; indicate data in accumulator
  26          Next             2   9   0                   0
  27          Gosub            9  31   0                   0  ; emit row for final group
  28          Goto             0  48   0                   0  ; group by finished
  29          Integer          1  11   0                   0  r[11]=1
  30        Return             9   0   0                   0
  31        IfPos             10  33   0                   0  r[10]>0 -> r[10]-=0, goto 33; output group by row subroutine start
  32      Return               9   0   0                   0
  33      AggFinal             0  14   0  count            0  accum=r[14]
  34      AggFinal             0  15   0  avg              0  accum=r[15]
  35      AggFinal             0  16   0  sum              0  accum=r[16]
  36      Copy                13   5   0                   0  r[5]=r[13]
  37      Copy                14   6   0                   0  r[6]=r[14]
  38      Copy                15   7   0                   0  r[7]=r[15]
  39      Copy                16   8   0                   0  r[8]=r[16]
  40      Copy                 5  24   3                   0  r[24]=r[5]
  41      Sequence             0  28   0                   0
  42      MakeRecord          24   5  23                   0  r[23]=mkrec(r[24..28]); for ephemeral_subquery_t2
  43      IdxInsert            0  23   0                   8  key=r[23]
  44    Return                 9   0   0                   0
  45    Null                   0  13  16                   0  r[13..16]=NULL; clear accumulator subroutine start
  46    Integer                0  10   0                   0  r[10]=0
  47  Return                  21   0   0                   0
  48  OpenRead                 3   3   0  k(3,B,B,B)       0  table=categories, root=3, iDb=0
  49  Rewind                   3  65   0                   0  Rewind table categories
  50    RowId                  3  32   0                   0  r[32]=categories.rowid
  51    SeekGE                 0  64  32                   0  key=[32..32]
  52      IdxGT                0  64  32                   0  key=[32..32]
  53      Column               0   0   1                   0  r[1]=ephemeral_subquery_t2.category_id
  54      Column               0   1   2                   0  r[2]=ephemeral_subquery_t2.product_count
  55      Column               0   2   3                   0  r[3]=ephemeral_subquery_t2.avg_price
  56      Column               0   3   4                   0  r[4]=ephemeral_subquery_t2.total_stock
  57      Column               0   1  34                   0  r[34]=ephemeral_subquery_t2.product_count
  58      Le                  34  35  63  Binary           0  if r[34]<=r[35] goto 63
  59      Column               3   1  29                   0  r[29]=categories.name
  60      Column               0   1  30                   0  r[30]=ephemeral_subquery_t2.product_count
  61      Column               0   2  31                   0  r[31]=ephemeral_subquery_t2.avg_price
  62      ResultRow           29   3   0                   0  output=r[29..31]
  63    Next                   0  52   0                   0
  64  Next                     3  50   0                   0
  65  Halt                     0   0   0                   0
  66  Transaction              0   1  11                   0  iDb=0 tx_mode=Read
  67  Integer                  1  22   0                   0  r[22]=1
  68  Integer                  5  35   0                   0  r[35]=5
  69  Goto                     0   1   0                   0
