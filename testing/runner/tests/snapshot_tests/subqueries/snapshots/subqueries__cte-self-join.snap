---
source: subqueries.sqltest
expression: "WITH employee_salaries AS (\n        SELECT id, name, department, salary\n        FROM employees\n        WHERE salary IS NOT NULL\n    )\n    SELECT\n        e1.name AS employee,\n        e1.salary AS emp_salary,\n        e2.name AS colleague,\n        e2.salary AS col_salary\n    FROM employee_salaries e1\n    JOIN employee_salaries e2 ON e1.department = e2.department\n        AND e1.id < e2.id\n    WHERE e1.salary > e2.salary * 1.5;"
info:
  statement_type: WITH (CTE)
  tables:
    - e1.department
    - employee_salaries
    - employees
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
|--SCAN employee_salaries AS e1
|  `--SCAN employees
`--SCAN employee_salaries AS e2
   `--SCAN employees

BYTECODE
addr  opcode           p1  p2  p3  p4              p5  comment
   0  Init              0  51   0                   0  Start at 51
   1  InitCoroutine     1  15   2                   0
   2  OpenRead          0   7   0  k(5,B,B,B,B,B)   0  table=employees, root=7, iDb=0
   3  Rewind            0  14   0                   0  Rewind table employees
   4    Column          0   4   6                   0  r[6]=employees.salary
   5    RealAffinity    6   0   0                   0
   6    IsNull          6  13   0                   0  if (r[6]==NULL) goto 13
   7    RowId           0   2   0                   0  r[2]=employees.rowid
   8    Column          0   1   3                   0  r[3]=employees.name
   9    Column          0   3   4                   0  r[4]=employees.department
  10    Column          0   4   5                   0  r[5]=employees.salary
  11    RealAffinity    5   0   0                   0
  12    Yield           1   0   0                   0
  13  Next              0   4   0                   0
  14  EndCoroutine      1   0   0                   0
  15  InitCoroutine     7  29  16                   0
  16  OpenRead          1   7   0  k(5,B,B,B,B,B)   0  table=employees, root=7, iDb=0
  17  Rewind            1  28   0                   0  Rewind table employees
  18    Column          1   4  12                   0  r[12]=employees.salary
  19    RealAffinity   12   0   0                   0
  20    IsNull         12  27   0                   0  if (r[12]==NULL) goto 27
  21    RowId           1   8   0                   0  r[8]=employees.rowid
  22    Column          1   1   9                   0  r[9]=employees.name
  23    Column          1   3  10                   0  r[10]=employees.department
  24    Column          1   4  11                   0  r[11]=employees.salary
  25    RealAffinity   11   0   0                   0
  26    Yield           7   0   0                   0
  27  Next              1  18   0                   0
  28  EndCoroutine      7   0   0                   0
  29  InitCoroutine     1   0   2                   0
  30    Yield           1  50   0                   0
  31    InitCoroutine   7   0  16                   0
  32      Yield         7  49   0                   0
  33      Copy          4  18   0                   0  r[18]=r[4]
  34      Copy         10  19   0                   0  r[19]=r[10]
  35      Ne           18  19  48  Binary           0  if r[18]!=r[19] goto 48
  36      Copy          2  21   0                   0  r[21]=r[2]
  37      Copy          8  22   0                   0  r[22]=r[8]
  38      Ge           21  22  48  Binary           0  if r[21]>=r[22] goto 48
  39      Copy          5  24   0                   0  r[24]=r[5]
  40      Copy         11  26   0                   0  r[26]=r[11]
  41      Multiply     26  27  25                   0  r[25]=r[26]*r[27]
  42      Le           24  25  48  Binary           0  if r[24]<=r[25] goto 48
  43      Copy          3  13   0                   0  r[13]=r[3]
  44      Copy          5  14   0                   0  r[14]=r[5]
  45      Copy          9  15   0                   0  r[15]=r[9]
  46      Copy         11  16   0                   0  r[16]=r[11]
  47      ResultRow    13   4   0                   0  output=r[13..16]
  48    Goto            0  32   0                   0
  49  Goto              0  30   0                   0
  50  Halt              0   0   0                   0
  51  Transaction       0   1  11                   0  iDb=0 tx_mode=Read
  52  Real              0  27   0  1.5              0  r[27]=1.5
  53  Goto              0   1   0                   0
