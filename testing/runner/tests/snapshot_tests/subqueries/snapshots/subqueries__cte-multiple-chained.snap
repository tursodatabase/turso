---
source: subqueries.sqltest
expression: "WITH\n    active_customers AS (\n        SELECT id, name\n        FROM customers\n        WHERE created_at >= '2023-01-01'\n    ),\n    customer_orders AS (\n        SELECT customer_id, count(*) AS order_count, sum(total_amount) AS total_spent\n        FROM orders\n        GROUP BY customer_id\n    )\n    SELECT ac.name, co.order_count, co.total_spent\n    FROM active_customers ac\n    JOIN customer_orders co ON co.customer_id = ac.id\n    WHERE co.order_count > 2;"
info:
  statement_type: WITH (CTE)
  tables:
    - active_customers
    - co.customer_id
    - customer_orders
    - customers
    - orders
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
|--SCAN active_customers AS ac
|  `--SCAN customers
`--SCAN customer_orders AS co
   `--SCAN orders USING INDEX idx_orders_customer

BYTECODE
addr  opcode                  p1  p2  p3  p4            p5  comment
   0          Init             0  68   0                 0  Start at 68
   1          InitCoroutine    1  11   2                 0
   2          OpenRead         0   6   0  k(4,B,B,B,B)   0  table=customers, root=6, iDb=0
   3          Rewind           0  10   0                 0  Rewind table customers
   4            Column         0   3   5                 0  r[5]=customers.created_at
   5            Lt             5   6   9  Binary         0  if r[5]<r[6] goto 9
   6            RowId          0   2   0                 0  r[2]=customers.rowid
   7            Column         0   1   3                 0  r[3]=customers.name
   8            Yield          1   0   0                 0
   9          Next             0   4   0                 0
  10          EndCoroutine     1   0   0                 0
  11          InitCoroutine    7  52  12                 0
  12          Null             0  16  17                 0  r[16..17]=NULL
  13          Integer          0  13   0                 0  r[13]=0; clear group by abort flag
  14          Null             0  14   0                 0  r[14]=NULL; initialize group by comparison registers to NULL
  15          Gosub           21  48   0                 0  ; go to clear accumulator subroutine
  16          OpenRead         1   4   0  k(4,B,B,B,B)   0  table=orders, root=4, iDb=0
  17          OpenRead         2   9   0  k(2,B)         0  index=idx_orders_customer, root=9, iDb=0
  18          Rewind           2  35   0                 0  Rewind index idx_orders_customer
  19            DeferredSeek   2   1   0                 0
  20            Column         1   1  19                 0  r[19]=orders.customer_id
  21            Column         1   3  20                 0  r[20]=orders.total_amount
  22            RealAffinity  20   0   0                 0
  23            Compare       14  19   1  k(1, Binary)   0  r[14..14]==r[19..19]
  24            Jump          25  29  25                 0  ; start new group if comparison is not equal
  25            Gosub         11  39   0                 0  ; check if ended group had data, and output if so
  26            Move          19  14   1                 0  r[14..14]=r[19..19]
  27            IfPos         13  51   0                 0  r[13]>0 -> r[13]-=0, goto 51; check abort flag
  28            Gosub         21  48   0                 0  ; goto clear accumulator subroutine
  29            AggStep        0  22  16  count          0  accum=r[16] step(r[22])
  30            AggStep        0  20  17  sum            0  accum=r[17] step(r[20])
  31            If            12  33   0                 0  if r[12] goto 33; don't emit group columns if continuing existing group
  32            Column         1   1  15                 0  r[15]=orders.customer_id
  33            Integer        1  12   0                 0  r[12]=1; indicate data in accumulator
  34          Next             2  19   0                 0
  35          Gosub           11  39   0                 0  ; emit row for final group
  36          Goto             0  51   0                 0  ; group by finished
  37          Integer          1  13   0                 0  r[13]=1
  38        Return            11   0   0                 0
  39        IfPos             12  41   0                 0  r[12]>0 -> r[12]-=0, goto 41; output group by row subroutine start
  40      Return              11   0   0                 0
  41      AggFinal             0  16   0  count          0  accum=r[16]
  42      AggFinal             0  17   0  sum            0  accum=r[17]
  43      Copy                15   8   0                 0  r[8]=r[15]
  44      Copy                16   9   0                 0  r[9]=r[16]
  45      Copy                17  10   0                 0  r[10]=r[17]
  46      Yield                7   0   0                 0
  47    Return                11   0   0                 0
  48    Null                   0  15  17                 0  r[15..17]=NULL; clear accumulator subroutine start
  49    Integer                0  12   0                 0  r[12]=0
  50  Return                  21   0   0                 0
  51  EndCoroutine             7   0   0                 0
  52  InitCoroutine            7   0  12                 0
  53    Yield                  7  67   0                 0
  54    Copy                   9  27   0                 0  r[27]=r[9]
  55    Le                    27  28  66  Binary         0  if r[27]<=r[28] goto 66
  56    InitCoroutine          1   0   2                 0
  57      Yield                1  66   0                 0
  58      Copy                 8  30   0                 0  r[30]=r[8]
  59      Copy                 2  31   0                 0  r[31]=r[2]
  60      Ne                  30  31  65  Binary         0  if r[30]!=r[31] goto 65
  61      Copy                 3  23   0                 0  r[23]=r[3]
  62      Copy                 9  24   0                 0  r[24]=r[9]
  63      Copy                10  25   0                 0  r[25]=r[10]
  64      ResultRow           23   3   0                 0  output=r[23..25]
  65    Goto                   0  57   0                 0
  66  Goto                     0  53   0                 0
  67  Halt                     0   0   0                 0
  68  Transaction              0   1  11                 0  iDb=0 tx_mode=Read
  69  String8                  0   6   0  2023-01-01     0  r[6]='2023-01-01'
  70  Integer                  1  22   0                 0  r[22]=1
  71  Integer                  2  28   0                 0  r[28]=2
  72  Goto                     0   1   0                 0
