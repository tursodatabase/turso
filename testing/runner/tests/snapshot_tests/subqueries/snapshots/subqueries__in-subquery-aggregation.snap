---
source: subqueries.sqltest
expression: |-
  SELECT c.id, c.name
      FROM customers c
      WHERE c.id IN (
          SELECT o.customer_id
          FROM orders o
          GROUP BY o.customer_id
          HAVING sum(o.total_amount) > 1000
      );
info:
  statement_type: SELECT
  tables:
  - customers
  - orders
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--LIST SUBQUERY 1
|  `--SCAN orders AS o USING INDEX idx_orders_customer
`--SCAN customers AS c

BYTECODE
addr  opcode                    p1  p2  p3  p4            p5  comment
   0          Init               0  65   0                 0  Start at 65
   1          Once              41   0   0                 0  goto 41
   2          OpenEphemeral      0   0   0                 0  cursor=0 is_table=false
   3          Null               0   7   0                 0  r[7]=NULL
   4          Integer            0   4   0                 0  r[4]=0; clear group by abort flag
   5          Null               0   5   0                 0  r[5]=NULL; initialize group by comparison registers to NULL
   6          Gosub             11  38   0                 0  ; go to clear accumulator subroutine
   7          OpenRead           1   4   0  k(4,B,B,B,B)   0  table=orders, root=4, iDb=0
   8          OpenRead           2   9   0  k(2,B)         0  index=idx_orders_customer, root=9, iDb=0
   9          Rewind             2  25   0                 0  Rewind index idx_orders_customer
  10            DeferredSeek     2   1   0                 0
  11            Column           1   1   9                 0  r[9]=orders.customer_id
  12            Column           1   3  10                 0  r[10]=orders.total_amount
  13            RealAffinity    10   0   0                 0
  14            Compare          5   9   1  k(1, Binary)   0  r[5..5]==r[9..9]
  15            Jump            16  20  16                 0  ; start new group if comparison is not equal
  16            Gosub            2  29   0                 0  ; check if ended group had data, and output if so
  17            Move             9   5   1                 0  r[5..5]=r[9..9]
  18            IfPos            4  41   0                 0  r[4]>0 -> r[4]-=0, goto 41; check abort flag
  19            Gosub           11  38   0                 0  ; goto clear accumulator subroutine
  20            AggStep          0  10   7  sum            0  accum=r[7] step(r[10])
  21            If               3  23   0                 0  if r[3] goto 23; don't emit group columns if continuing existing group
  22            Column           1   1   6                 0  r[6]=orders.customer_id
  23            Integer          1   3   0                 0  r[3]=1; indicate data in accumulator
  24          Next               2  10   0                 0
  25          Gosub              2  29   0                 0  ; emit row for final group
  26          Goto               0  41   0                 0  ; group by finished
  27          Integer            1   4   0                 0  r[4]=1
  28        Return               2   0   0                 0
  29        IfPos                3  31   0                 0  r[3]>0 -> r[3]-=0, goto 31; output group by row subroutine start
  30      Return                 2   0   0                 0
  31      AggFinal               0   7   0  sum            0  accum=r[7]
  32      Copy                   7  13   0                 0  r[13]=r[7]
  33      Le                    13  14  30  Binary         0  if r[13]<=r[14] goto 30
  34      Copy                   6   1   0                 0  r[1]=r[6]
  35      MakeRecord             1   1  15                 0  r[15]=mkrec(r[1..1]); for ephemeral_index_where_sub_t2
  36      IdxInsert              0  15   0                 8  key=r[15]
  37    Return                   2   0   0                 0
  38    Null                     0   6   7                 0  r[6..7]=NULL; clear accumulator subroutine start
  39    Integer                  0   3   0                 0  r[3]=0
  40  Return                    11   0   0                 0
  41  OpenRead                   3   6   0  k(4,B,B,B,B)   0  table=customers, root=6, iDb=0
  42  Rewind                     3  64   0                 0  Rewind table customers
  43    Integer                  0  18   0                 0  r[18]=0
  44    RowId                    3  19   0                 0  r[19]=customers.rowid
  45    Affinity                19   1   0                 0  r[19..20] = C
  46    NotFound                 0  48  19                 0  if not found goto 48
  47    Goto                     0  54   0                 0
  48    Rewind                   0  56   0                 0  Rewind  ephemeral(ephemeral_index_where_sub_t2)
  49      Column                 0   0  20                 0  r[20]=ephemeral(ephemeral_index_where_sub_t2).customer_id
  50      Ne                    19  20  52  Binary         0  if r[19]!=r[20] goto 52
  51      Goto                   0  58   0                 0
  52    Next                     0  49   0                 0
  53    Goto                     0  56   0                 0
  54    Integer                  1  18   0                 0  r[18]=1
  55    Goto                     0  59   0                 0
  56    Integer                  0  18   0                 0  r[18]=0
  57    Goto                     0  59   0                 0
  58    Null                     0  18   0                 0  r[18]=NULL
  59    IfNot                   18  63   1                 0  if !r[18] goto 63
  60    RowId                    3  16   0                 0  r[16]=customers.rowid
  61    Column                   3   1  17                 0  r[17]=customers.name
  62    ResultRow               16   2   0                 0  output=r[16..17]
  63  Next                       3  43   0                 0
  64  Halt                       0   0   0                 0
  65  Transaction                0   1  11                 0  iDb=0 tx_mode=Read
  66  Integer                 1000  14   0                 0  r[14]=1000
  67  Goto                       0   1   0                 0
