---
source: subqueries.sqltest
expression: "SELECT subq.category_id, subq.avg_price\n    FROM (\n        SELECT category_id, avg(price) AS avg_price\n        FROM products\n        GROUP BY category_id\n    ) AS subq\n    WHERE subq.avg_price > 50;"
info:
  statement_type: SELECT
  tables:
    - products
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
`--SCAN subq
   `--SCAN products USING INDEX idx_products_category

BYTECODE
addr  opcode                  p1  p2  p3  p4              p5  comment
   0          Init             0  48   0                   0  Start at 48
   1          InitCoroutine    1  39   2                   0
   2          Null             0   9   0                   0  r[9]=NULL
   3          Integer          0   6   0                   0  r[6]=0; clear group by abort flag
   4          Null             0   7   0                   0  r[7]=NULL; initialize group by comparison registers to NULL
   5          Gosub           13  35   0                   0  ; go to clear accumulator subroutine
   6          OpenRead         0   2   0  k(5,B,B,B,B,B)   0  table=products, root=2, iDb=0
   7          OpenRead         1   8   0  k(2,B)           0  index=idx_products_category, root=8, iDb=0
   8          Rewind           1  24   0                   0  Rewind index idx_products_category
   9            DeferredSeek   1   0   0                   0
  10            Column         0   2  11                   0  r[11]=products.category_id
  11            Column         0   3  12                   0  r[12]=products.price
  12            RealAffinity  12   0   0                   0
  13            Compare        7  11   1  k(1, Binary)     0  r[7..7]==r[11..11]
  14            Jump          15  19  15                   0  ; start new group if comparison is not equal
  15            Gosub          4  28   0                   0  ; check if ended group had data, and output if so
  16            Move          11   7   1                   0  r[7..7]=r[11..11]
  17            IfPos          6  38   0                   0  r[6]>0 -> r[6]-=0, goto 38; check abort flag
  18            Gosub         13  35   0                   0  ; goto clear accumulator subroutine
  19            AggStep        0  12   9  avg              0  accum=r[9] step(r[12])
  20            If             5  22   0                   0  if r[5] goto 22; don't emit group columns if continuing existing group
  21            Column         0   2   8                   0  r[8]=products.category_id
  22            Integer        1   5   0                   0  r[5]=1; indicate data in accumulator
  23          Next             1   9   0                   0
  24          Gosub            4  28   0                   0  ; emit row for final group
  25          Goto             0  38   0                   0  ; group by finished
  26          Integer          1   6   0                   0  r[6]=1
  27        Return             4   0   0                   0
  28        IfPos              5  30   0                   0  r[5]>0 -> r[5]-=0, goto 30; output group by row subroutine start
  29      Return               4   0   0                   0
  30      AggFinal             0   9   0  avg              0  accum=r[9]
  31      Copy                 8   2   0                   0  r[2]=r[8]
  32      Copy                 9   3   0                   0  r[3]=r[9]
  33      Yield                1   0   0                   0
  34    Return                 4   0   0                   0
  35    Null                   0   8   9                   0  r[8..9]=NULL; clear accumulator subroutine start
  36    Integer                0   5   0                   0  r[5]=0
  37  Return                  13   0   0                   0
  38  EndCoroutine             1   0   0                   0
  39  InitCoroutine            1   0   2                   0
  40    Yield                  1  47   0                   0
  41    Copy                   3  17   0                   0  r[17]=r[3]
  42    Le                    17  18  46  Binary           0  if r[17]<=r[18] goto 46
  43    Copy                   2  14   0                   0  r[14]=r[2]
  44    Copy                   3  15   0                   0  r[15]=r[3]
  45    ResultRow             14   2   0                   0  output=r[14..15]
  46  Goto                     0  40   0                   0
  47  Halt                     0   0   0                   0
  48  Transaction              0   1  11                   0  iDb=0 tx_mode=Read
  49  Integer                 50  18   0                   0  r[18]=50
  50  Goto                     0   1   0                   0
