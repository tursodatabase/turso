---
source: subqueries.sqltest
expression: "SELECT top_customers.name, top_customers.total_spent\n    FROM (\n        SELECT c.name, stats.total_spent\n        FROM customers c\n        JOIN (\n            SELECT customer_id, sum(total_amount) AS total_spent\n            FROM orders\n            GROUP BY customer_id\n        ) AS stats ON stats.customer_id = c.id\n    ) AS top_customers\n    WHERE top_customers.total_spent > 1000\n    ORDER BY top_customers.total_spent DESC;"
info:
  statement_type: SELECT
  tables:
    - customers
    - orders
    - stats.customer_id
  setup_blocks:
    - schema
  database: ":memory:"
---
QUERY PLAN
|--SCAN top_customers
|  |--SEARCH c USING INTEGER PRIMARY KEY (rowid=?)
|  `--SCAN stats
|     `--SCAN orders USING INDEX idx_orders_customer
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                    p1  p2  p3  p4            p5  comment
   0          Init               0  68   0                 0  Start at 68
   1          InitCoroutine      1  50   2                 0
   2          InitCoroutine      2  40   3                 0
   3          Null               0  10   0                 0  r[10]=NULL
   4          Integer            0   7   0                 0  r[7]=0; clear group by abort flag
   5          Null               0   8   0                 0  r[8]=NULL; initialize group by comparison registers to NULL
   6          Gosub             14  36   0                 0  ; go to clear accumulator subroutine
   7          OpenRead           0   4   0  k(4,B,B,B,B)   0  table=orders, root=4, iDb=0
   8          OpenRead           1   9   0  k(2,B)         0  index=idx_orders_customer, root=9, iDb=0
   9          Rewind             1  25   0                 0  Rewind index idx_orders_customer
  10            DeferredSeek     1   0   0                 0
  11            Column           0   1  12                 0  r[12]=orders.customer_id
  12            Column           0   3  13                 0  r[13]=orders.total_amount
  13            RealAffinity    13   0   0                 0
  14            Compare          8  12   1  k(1, Binary)   0  r[8..8]==r[12..12]
  15            Jump            16  20  16                 0  ; start new group if comparison is not equal
  16            Gosub            5  29   0                 0  ; check if ended group had data, and output if so
  17            Move            12   8   1                 0  r[8..8]=r[12..12]
  18            IfPos            7  39   0                 0  r[7]>0 -> r[7]-=0, goto 39; check abort flag
  19            Gosub           14  36   0                 0  ; goto clear accumulator subroutine
  20            AggStep          0  13  10  sum            0  accum=r[10] step(r[13])
  21            If               6  23   0                 0  if r[6] goto 23; don't emit group columns if continuing existing group
  22            Column           0   1   9                 0  r[9]=orders.customer_id
  23            Integer          1   6   0                 0  r[6]=1; indicate data in accumulator
  24          Next               1  10   0                 0
  25          Gosub              5  29   0                 0  ; emit row for final group
  26          Goto               0  39   0                 0  ; group by finished
  27          Integer            1   7   0                 0  r[7]=1
  28        Return               5   0   0                 0
  29        IfPos                6  31   0                 0  r[6]>0 -> r[6]-=0, goto 31; output group by row subroutine start
  30      Return                 5   0   0                 0
  31      AggFinal               0  10   0  sum            0  accum=r[10]
  32      Copy                   9   3   0                 0  r[3]=r[9]
  33      Copy                  10   4   0                 0  r[4]=r[10]
  34      Yield                  2   0   0                 0
  35    Return                   5   0   0                 0
  36    Null                     0   9  10                 0  r[9..10]=NULL; clear accumulator subroutine start
  37    Integer                  0   6   0                 0  r[6]=0
  38  Return                    14   0   0                 0
  39  EndCoroutine               2   0   0                 0
  40  OpenRead                   2   6   0  k(4,B,B,B,B)   0  table=customers, root=6, iDb=0
  41  InitCoroutine              2   0   3                 0
  42    Yield                    2  49   0                 0
  43    Copy                     3  17   0                 0  r[17]=r[3]
  44    SeekRowid                2  17  48                 0  if (r[17]!=cursor 2 for table customers.rowid) goto 48
  45    Column                   2   1  15                 0  r[15]=customers.name
  46    Copy                     4  16   0                 0  r[16]=r[4]
  47    Yield                    1   0   0                 0
  48  Goto                       0  42   0                 0
  49  EndCoroutine               1   0   0                 0
  50  SorterOpen                 3   1   0  k(1,-B)        0  cursor=3
  51  InitCoroutine              1   0   2                 0
  52    Yield                    1  60   0                 0
  53    Copy                    16  22   0                 0  r[22]=r[16]
  54    Le                      22  23  59  Binary         0  if r[22]<=r[23] goto 59
  55    Copy                    16  24   0                 0  r[24]=r[16]
  56    Copy                    15  25   0                 0  r[25]=r[15]
  57    MakeRecord              24   2  20                 0  r[20]=mkrec(r[24..25])
  58    SorterInsert             3  20   0  0              0  key=r[20]
  59  Goto                       0  52   0                 0
  60  OpenPseudo                 4  20   2                 0  2 columns in r[20]
  61  SorterSort                 3  67   0                 0
  62    SorterData               3  20   4                 0  r[20]=data
  63    Column                   4   1  18                 0  r[18]=pseudo.column 1
  64    Column                   4   0  19                 0  r[19]=pseudo.column 0
  65    ResultRow               18   2   0                 0  output=r[18..19]
  66  SorterNext                 3  62   0                 0
  67  Halt                       0   0   0                 0
  68  Transaction                0   1  11                 0  iDb=0 tx_mode=Read
  69  Integer                 1000  23   0                 0  r[23]=1000
  70  Goto                       0   1   0                 0
