---
source: subqueries.sqltest
expression: |-
  WITH
      product_sales AS (
          SELECT
              oi.product_id,
              sum(oi.quantity) AS total_quantity,
              sum(oi.quantity * oi.unit_price) AS total_revenue
          FROM order_items oi
          GROUP BY oi.product_id
      ),
      top_products AS (
          SELECT product_id, total_quantity, total_revenue
          FROM product_sales
          WHERE total_revenue > 1000
      ),
      top_product_details AS (
          SELECT p.name, p.category_id, tp.total_quantity, tp.total_revenue
          FROM top_products tp
          JOIN products p ON p.id = tp.product_id
      )
      SELECT tpd.name, c.name AS category_name, tpd.total_revenue
      FROM top_product_details tpd
      JOIN categories c ON c.id = tpd.category_id
      ORDER BY tpd.total_revenue DESC;
info:
  statement_type: WITH (CTE)
  tables:
  - c.id
  - categories
  - order_items
  - p.id
  - product_sales
  - products
  - top_product_details
  - top_products
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SEARCH tpd USING INDEX ephemeral_subquery_t7
|  |--SEARCH tp USING INDEX ephemeral_subquery_t5
|  |  `--SCAN product_sales
|  |     `--SCAN order_items AS oi USING INDEX idx_order_items_product
|  `--SCAN products AS p
|--SCAN categories AS c
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                    p1   p2  p3  p4              p5  comment
   0          Init               0  106   0                   0  Start at 106
   1          OpenEphemeral      0    0   0                   0  cursor=0 is_table=false
   2          OpenEphemeral      1    0   0                   0  cursor=1 is_table=false
   3          InitCoroutine      8   47   4                   0
   4          Null               0   17  18                   0  r[17..18]=NULL
   5          Integer            0   14   0                   0  r[14]=0; clear group by abort flag
   6          Null               0   15   0                   0  r[15]=NULL; initialize group by comparison registers to NULL
   7          Gosub             23   43   0                   0  ; go to clear accumulator subroutine
   8          OpenRead           2    5   0  k(5,B,B,B,B,B)   0  table=order_items, root=5, iDb=0
   9          OpenRead           3   11   0  k(2,B)           0  index=idx_order_items_product, root=11, iDb=0
  10          Rewind             3   30   0                   0  Rewind index idx_order_items_product
  11            DeferredSeek     3    2   0                   0
  12            Column           2    2  20                   0  r[20]=order_items.product_id
  13            Column           2    3  21                   0  r[21]=order_items.quantity
  14            Column           2    3  24                   0  r[24]=order_items.quantity
  15            Column           2    4  25                   0  r[25]=order_items.unit_price
  16            RealAffinity    25    0   0                   0
  17            Multiply        24   25  22                   0  r[22]=r[24]*r[25]
  18            Compare         15   20   1  k(1, Binary)     0  r[15..15]==r[20..20]
  19            Jump            20   24  20                   0  ; start new group if comparison is not equal
  20            Gosub           12   34   0                   0  ; check if ended group had data, and output if so
  21            Move            20   15   1                   0  r[15..15]=r[20..20]
  22            IfPos           14   46   0                   0  r[14]>0 -> r[14]-=0, goto 46; check abort flag
  23            Gosub           23   43   0                   0  ; goto clear accumulator subroutine
  24            AggStep          0   21  17  sum              0  accum=r[17] step(r[21])
  25            AggStep          0   22  18  sum              0  accum=r[18] step(r[22])
  26            If              13   28   0                   0  if r[13] goto 28; don't emit group columns if continuing existing group
  27            Column           2    2  16                   0  r[16]=order_items.product_id
  28            Integer          1   13   0                   0  r[13]=1; indicate data in accumulator
  29          Next               3   11   0                   0
  30          Gosub             12   34   0                   0  ; emit row for final group
  31          Goto               0   46   0                   0  ; group by finished
  32          Integer            1   14   0                   0  r[14]=1
  33        Return              12    0   0                   0
  34        IfPos               13   36   0                   0  r[13]>0 -> r[13]-=0, goto 36; output group by row subroutine start
  35      Return                12    0   0                   0
  36      AggFinal               0   17   0  sum              0  accum=r[17]
  37      AggFinal               0   18   0  sum              0  accum=r[18]
  38      Copy                  16    9   0                   0  r[9]=r[16]
  39      Copy                  17   10   0                   0  r[10]=r[17]
  40      Copy                  18   11   0                   0  r[11]=r[18]
  41      Yield                  8    0   0                   0
  42    Return                  12    0   0                   0
  43    Null                     0   16  18                   0  r[16..18]=NULL; clear accumulator subroutine start
  44    Integer                  0   13   0                   0  r[13]=0
  45  Return                    23    0   0                   0
  46  EndCoroutine               8    0   0                   0
  47  InitCoroutine              8    0   4                   0
  48    Yield                    8   59   0                   0
  49    Copy                    11   30   0                   0  r[30]=r[11]
  50    Le                      30   31  58  Binary           0  if r[30]<=r[31] goto 58
  51    Copy                     9   26   0                   0  r[26]=r[9]
  52    Copy                    10   27   0                   0  r[27]=r[10]
  53    Copy                    11   28   0                   0  r[28]=r[11]
  54    Copy                    26   33   2                   0  r[33]=r[26]
  55    Sequence                 1   36   0                   0
  56    MakeRecord              33    4  32                   0  r[32]=mkrec(r[33..36]); for ephemeral_subquery_t5
  57    IdxInsert                1   32   0                   8  key=r[32]
  58  Goto                       0   48   0                   0
  59  OpenRead                   4    2   0  k(5,B,B,B,B,B)   0  table=products, root=2, iDb=0
  60  Rewind                     4   80   0                   0  Rewind table products
  61    RowId                    4   41   0                   0  r[41]=products.rowid
  62    SeekGE                   1   79  41                   0  key=[41..41]
  63      IdxGT                  1   79  41                   0  key=[41..41]
  64      Column                 1    0   5                   0  r[5]=ephemeral_subquery_t5.product_id
  65      Column                 1    1   6                   0  r[6]=ephemeral_subquery_t5.total_quantity
  66      Column                 1    2   7                   0  r[7]=ephemeral_subquery_t5.total_revenue
  67      Column                 4    1  37                   0  r[37]=products.name
  68      Column                 4    2  38                   0  r[38]=products.category_id
  69      Column                 1    1  39                   0  r[39]=ephemeral_subquery_t5.total_quantity
  70      Column                 1    2  40                   0  r[40]=ephemeral_subquery_t5.total_revenue
  71      Copy                  38   43   0                   0  r[43]=r[38]
  72      Copy                  37   44   0                   0  r[44]=r[37]
  73      Copy                  39   45   0                   0  r[45]=r[39]
  74      Copy                  40   46   0                   0  r[46]=r[40]
  75      Sequence               0   47   0                   0
  76      MakeRecord            43    5  42                   0  r[42]=mkrec(r[43..47]); for ephemeral_subquery_t7
  77      IdxInsert              0   42   0                   8  key=r[42]
  78    Next                     1   63   0                   0
  79  Next                       4   61   0                   0
  80  SorterOpen                 5    1   0  k(1,-B)          0  cursor=5
  81  OpenRead                   6    3   0  k(3,B,B,B)       0  table=categories, root=3, iDb=0
  82  Rewind                     6   97   0                   0  Rewind table categories
  83    RowId                    6   52   0                   0  r[52]=categories.rowid
  84    SeekGE                   0   96  52                   0  key=[52..52]
  85      IdxGT                  0   96  52                   0  key=[52..52]
  86      Column                 0    0   1                   0  r[1]=ephemeral_subquery_t7.category_id
  87      Column                 0    1   2                   0  r[2]=ephemeral_subquery_t7.name
  88      Column                 0    2   3                   0  r[3]=ephemeral_subquery_t7.total_quantity
  89      Column                 0    3   4                   0  r[4]=ephemeral_subquery_t7.total_revenue
  90      Column                 0    3  53                   0  r[53]=ephemeral_subquery_t7.total_revenue
  91      Column                 0    1  54                   0  r[54]=ephemeral_subquery_t7.name
  92      Column                 6    1  55                   0  r[55]=categories.name
  93      MakeRecord            53    3  51                   0  r[51]=mkrec(r[53..55])
  94      SorterInsert           5   51   0  0                0  key=r[51]
  95    Next                     0   85   0                   0
  96  Next                       6   83   0                   0
  97  OpenPseudo                 7   51   3                   0  3 columns in r[51]
  98  SorterSort                 5  105   0                   0
  99    SorterData               5   51   7                   0  r[51]=data
 100    Column                   7    1  48                   0  r[48]=pseudo.column 1
 101    Column                   7    2  49                   0  r[49]=pseudo.column 2
 102    Column                   7    0  50                   0  r[50]=pseudo.column 0
 103    ResultRow               48    3   0                   0  output=r[48..50]
 104  SorterNext                 5   99   0                   0
 105  Halt                       0    0   0                   0
 106  Transaction                0    1  11                   0  iDb=0 tx_mode=Read
 107  Integer                 1000   31   0                   0  r[31]=1000
 108  Goto                       0    1   0                   0
