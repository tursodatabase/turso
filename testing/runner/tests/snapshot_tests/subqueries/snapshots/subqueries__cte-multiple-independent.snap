---
source: subqueries.sqltest
expression: |-
  WITH
      expensive_products AS (
          SELECT id, name, price
          FROM products
          WHERE price > 500
      ),
      large_orders AS (
          SELECT id, customer_id, total_amount
          FROM orders
          WHERE total_amount > 1000
      ),
      vip_customers AS (
          SELECT id, name
          FROM customers
          WHERE id IN (SELECT customer_id FROM large_orders)
      )
      SELECT v.name, l.total_amount
      FROM vip_customers v
      JOIN large_orders l ON l.customer_id = v.id;
info:
  statement_type: WITH (CTE)
  tables:
  - customers
  - l.customer_id
  - large_orders
  - orders
  - products
  - vip_customers
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SCAN vip_customers AS v
|  |--SCAN large_orders
|  |  `--SCAN orders
|  `--SCAN customers
`--SCAN large_orders AS l
   `--SCAN orders

BYTECODE
addr  opcode             p1  p2  p3  p4            p5  comment
   0  Init                0  73   0                 0  Start at 73
   1  InitCoroutine       1  47   2                 0
   2  Once               23   0   0                 0  goto 23
   3  OpenEphemeral       1   0   0                 0  cursor=1 is_table=false
   4  InitCoroutine       2  17   5                 0
   5  OpenRead            2   4   0  k(4,B,B,B,B)   0  table=orders, root=4, iDb=0
   6  Rewind              2  16   0                 0  Rewind table orders
   7    Column            2   3   7                 0  r[7]=orders.total_amount
   8    RealAffinity      7   0   0                 0
   9    Le                7   8  15  Binary         0  if r[7]<=r[8] goto 15
  10    RowId             2   3   0                 0  r[3]=orders.rowid
  11    Column            2   1   4                 0  r[4]=orders.customer_id
  12    Column            2   3   5                 0  r[5]=orders.total_amount
  13    RealAffinity      5   0   0                 0
  14    Yield             2   0   0                 0
  15  Next                2   7   0                 0
  16  EndCoroutine        2   0   0                 0
  17  InitCoroutine       2   0   5                 0
  18    Yield             2  23   0                 0
  19    Copy              4   9   0                 0  r[9]=r[4]
  20    MakeRecord        9   1  10                 0  r[10]=mkrec(r[9..9]); for ephemeral_index_where_sub_t11
  21    IdxInsert         1  10   0                 8  key=r[10]
  22  Goto                0  18   0                 0
  23  OpenRead            3   6   0  k(4,B,B,B,B)   0  table=customers, root=6, iDb=0
  24  Rewind              3  46   0                 0  Rewind table customers
  25    Integer           0  13   0                 0  r[13]=0
  26    RowId             3  14   0                 0  r[14]=customers.rowid
  27    Affinity         14   1   0                 0  r[14..15] = D
  28    NotFound          1  30  14                 0  if not found goto 30
  29    Goto              0  36   0                 0
  30    Rewind            1  38   0                 0  Rewind  ephemeral_index_where_sub_t11
  31      Column          1   0  15                 0  r[15]=ephemeral_index_where_sub_t11.customer_id
  32      Ne             14  15  34  Binary         0  if r[14]!=r[15] goto 34
  33      Goto            0  40   0                 0
  34    Next              1  31   0                 0
  35    Goto              0  38   0                 0
  36    Integer           1  13   0                 0  r[13]=1
  37    Goto              0  41   0                 0
  38    Integer           0  13   0                 0  r[13]=0
  39    Goto              0  41   0                 0
  40    Null              0  13   0                 0  r[13]=NULL
  41    IfNot            13  45   1                 0  if !r[13] goto 45
  42    RowId             3  11   0                 0  r[11]=customers.rowid
  43    Column            3   1  12                 0  r[12]=customers.name
  44    Yield             1   0   0                 0
  45  Next                3  25   0                 0
  46  EndCoroutine        1   0   0                 0
  47  InitCoroutine      16  60  48                 0
  48  OpenRead            4   4   0  k(4,B,B,B,B)   0  table=orders, root=4, iDb=0
  49  Rewind              4  59   0                 0  Rewind table orders
  50    Column            4   3  21                 0  r[21]=orders.total_amount
  51    RealAffinity     21   0   0                 0
  52    Le               21  22  58  Binary         0  if r[21]<=r[22] goto 58
  53    RowId             4  17   0                 0  r[17]=orders.rowid
  54    Column            4   1  18                 0  r[18]=orders.customer_id
  55    Column            4   3  19                 0  r[19]=orders.total_amount
  56    RealAffinity     19   0   0                 0
  57    Yield            16   0   0                 0
  58  Next                4  50   0                 0
  59  EndCoroutine       16   0   0                 0
  60  InitCoroutine       1   0   2                 0
  61    Yield             1  72   0                 0
  62    InitCoroutine    16   0  48                 0
  63      Yield          16  71   0                 0
  64      Copy           18  26   0                 0  r[26]=r[18]
  65      Copy           11  27   0                 0  r[27]=r[11]
  66      Ne             26  27  70  Binary         0  if r[26]!=r[27] goto 70
  67      Copy           12  23   0                 0  r[23]=r[12]
  68      Copy           19  24   0                 0  r[24]=r[19]
  69      ResultRow      23   2   0                 0  output=r[23..24]
  70    Goto              0  63   0                 0
  71  Goto                0  61   0                 0
  72  Halt                0   0   0                 0
  73  Transaction         0   1  11                 0  iDb=0 tx_mode=Read
  74  Integer          1000   8   0                 0  r[8]=1000
  75  Integer          1000  22   0                 0  r[22]=1000
  76  Goto                0   1   0                 0
