---
source: subqueries.sqltest
expression: |-
  WITH
      expensive_products AS (
          SELECT id, name, price
          FROM products
          WHERE price > 500
      ),
      large_orders AS (
          SELECT id, customer_id, total_amount
          FROM orders
          WHERE total_amount > 1000
      ),
      vip_customers AS (
          SELECT id, name
          FROM customers
          WHERE id IN (SELECT customer_id FROM large_orders)
      )
      SELECT v.name, l.total_amount
      FROM vip_customers v
      JOIN large_orders l ON l.customer_id = v.id;
info:
  statement_type: WITH (CTE)
  tables:
  - customers
  - l.customer_id
  - large_orders
  - orders
  - products
  - vip_customers
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SCAN orders
|--SCAN large_orders AS l
`--SEARCH v USING INDEX ephemeral_subquery_t6
   |--LIST SUBQUERY 1
   |  `--SCAN large_orders
   `--SCAN customers

BYTECODE
addr  opcode            p1  p2  p3  p4            p5  comment
   0  Init               0  72   0                 0  Start at 72
   1  OpenEphemeral      1   1   0                 0  cursor=1 is_table=true
   2  OpenRead           2   4   0  k(4,B,B,B,B)   0  table=orders, root=4, iDb=0
   3  Rewind             2  15   0                 0  Rewind table orders
   4    Column           2   3   8                 0  r[8]=orders.total_amount
   5    RealAffinity     8   0   0                 0
   6    Le               8   9  14  Binary         0  if r[8]<=r[9] goto 14
   7    RowId            2   4   0                 0  r[4]=orders.rowid
   8    Column           2   1   5                 0  r[5]=orders.customer_id
   9    Column           2   3   6                 0  r[6]=orders.total_amount
  10    RealAffinity     6   0   0                 0
  11    MakeRecord       4   3  10                 0  r[10]=mkrec(r[4..6]); for
  12    NewRowid         1  11   0                 0  r[11]=rowid
  13    Insert           1  10  11                 4  intkey=r[11] data=r[10]
  14  Next               2   4   0                 0
  15  OpenDup            3   1   0                 0  new_cursor=3, original_cursor=1
  16  OpenEphemeral      4   0   0                 0  cursor=4 is_table=false
  17  Once              28   0   0                 0  goto 28
  18  OpenEphemeral      0   0   0                 0  cursor=0 is_table=false
  19  OpenDup            5   1   0                 0  new_cursor=5, original_cursor=1
  20  Rewind             5  28   0                 0  Rewind  ephemeral()
  21    Column           5   0  17                 0  r[17]=ephemeral().column 0
  22    Column           5   1  18                 0  r[18]=ephemeral().column 1
  23    Column           5   2  19                 0  r[19]=ephemeral().column 2
  24    Copy            18  20   0                 0  r[20]=r[18]
  25    MakeRecord      20   1  21                 0  r[21]=mkrec(r[20..20]); for ephemeral_index_where_sub_t4
  26    IdxInsert        0  21   0                 8  key=r[21]
  27  Next               5  21   0                 0
  28  OpenRead           6   6   0  k(4,B,B,B,B)   0  table=customers, root=6, iDb=0
  29  Rewind             6  55   0                 0  Rewind table customers
  30    Integer          0  24   0                 0  r[24]=0
  31    RowId            6  25   0                 0  r[25]=customers.rowid
  32    IsNull          25  36   0                 0  if (r[25]==NULL) goto 36
  33    Affinity        25   1   0                 0  r[25..26] = C
  34    NotFound         0  36  25                 0  if not found goto 36
  35    Goto             0  42   0                 0
  36    Rewind           0  44   0                 0  Rewind  ephemeral(ephemeral_index_where_sub_t4)
  37      Column         0   0  26                 0  r[26]=ephemeral(ephemeral_index_where_sub_t4).customer_id
  38      Ne            25  26  40  Binary         0  if r[25]!=r[26] goto 40
  39      Goto           0  46   0                 0
  40    Next             0  37   0                 0
  41    Goto             0  44   0                 0
  42    Integer          1  24   0                 0  r[24]=1
  43    Goto             0  47   0                 0
  44    Integer          0  24   0                 0  r[24]=0
  45    Goto             0  47   0                 0
  46    Null             0  24   0                 0  r[24]=NULL
  47    IfNot           24  54   1                 0  if !r[24] goto 54
  48    RowId            6  22   0                 0  r[22]=customers.rowid
  49    Column           6   1  23                 0  r[23]=customers.name
  50    Copy            22  28   1                 0  r[28]=r[22]
  51    Sequence         4  30   0                 0
  52    MakeRecord      28   3  27                 0  r[27]=mkrec(r[28..30]); for ephemeral_subquery_t6
  53    IdxInsert        4  27   0                 8  key=r[27]
  54  Next               6  30   0                 0
  55  Rewind             3  71   0                 0  Rewind  ephemeral()
  56    Column           3   0  12                 0  r[12]=ephemeral().column 0
  57    Column           3   1  13                 0  r[13]=ephemeral().column 1
  58    Column           3   2  14                 0  r[14]=ephemeral().column 2
  59    Copy            13  33   0                 0  r[33]=r[13]
  60    IsNull          33  70   0                 0  if (r[33]==NULL) goto 70
  61    Affinity        33   1   0                 0  r[33..34] = D
  62    SeekGE           4  70  33                 0  key=[33..33]
  63      IdxGT          4  70  33                 0  key=[33..33]
  64      Column         4   0  15                 0  r[15]=ephemeral(ephemeral_subquery_t6).id
  65      Column         4   1  16                 0  r[16]=ephemeral(ephemeral_subquery_t6).name
  66      Column         4   1  31                 0  r[31]=ephemeral(ephemeral_subquery_t6).name
  67      Copy          14  32   0                 0  r[32]=r[14]
  68      ResultRow     31   2   0                 0  output=r[31..32]
  69    Next             4  63   0                 0
  70  Next               3  56   0                 0
  71  Halt               0   0   0                 0
  72  Transaction        0   1  11                 0  iDb=0 tx_mode=Read
  73  Integer         1000   9   0                 0  r[9]=1000
  74  Goto               0   1   0                 0
