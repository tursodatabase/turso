@database :memory:

# Regression test for https://github.com/tursodatabase/turso/issues/5276
# page_free_array used u16 for offset/len which overflows when offset + len > 65535
# on 65536-byte pages with large index cells.

test large-page-index-insert {
    PRAGMA page_size = 65536;
    CREATE TABLE t(a INTEGER PRIMARY KEY, b TEXT);
    CREATE INDEX idx ON t(b);
    INSERT INTO t VALUES (1, printf('%010000d', 1));
    INSERT INTO t VALUES (2, printf('%010000d', 2));
    INSERT INTO t VALUES (3, printf('%010000d', 3));
    INSERT INTO t VALUES (4, printf('%010000d', 4));
    INSERT INTO t VALUES (5, printf('%010000d', 5));
    INSERT INTO t VALUES (6, printf('%010000d', 6));
    INSERT INTO t VALUES (7, printf('%010000d', 7));
    INSERT INTO t VALUES (8, printf('%010000d', 8));
    INSERT INTO t VALUES (9, printf('%010000d', 9));
    INSERT INTO t VALUES (10, printf('%010000d', 10));
    INSERT INTO t VALUES (11, printf('%010000d', 11));
    SELECT a FROM t ORDER BY a;
}
expect {
    1
    2
    3
    4
    5
    6
    7
    8
    9
    10
    11
}
