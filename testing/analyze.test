#!/usr/bin/env tclsh
set testdir [file dirname $argv0]
source $testdir/tester.tcl

# Things that do work:

do_execsql_test_on_specific_db {:memory:} empty-table {
  CREATE TABLE temp (a integer);
  ANALYZE temp;
  SELECT * FROM sqlite_stat1;
} {}

do_execsql_test_on_specific_db {:memory:} one-row-table {
  CREATE TABLE temp (a integer);
  INSERT INTO temp VALUES (1);
  ANALYZE temp;
  SELECT * FROM sqlite_stat1;
} {temp||1}

do_execsql_test_on_specific_db {:memory:} analyze-overwrites {
  CREATE TABLE temp (a integer);
  INSERT INTO temp VALUES (1);
  ANALYZE temp;
  INSERT INTO temp VALUES (2);
  ANALYZE temp;
  SELECT * FROM sqlite_stat1;
} {temp||2}

do_execsql_test_on_specific_db {:memory:} analyze-all {
  create table t(a, b);
  insert into t values(1, 2);
  ANALYZE;
  SELECT * FROM sqlite_stat1;
} {t||1}

do_execsql_test_on_specific_db {:memory:} analyze-table-with-pk {
  CREATE TABLE temp (a integer primary key);
  INSERT INTO temp VALUES (1);
  ANALYZE temp;
  SELECT * FROM sqlite_stat1;
} {temp||1}

do_execsql_test_on_specific_db {:memory:} analyze-one-database {
  ANALYZE main;
} {}

do_execsql_test_on_specific_db {:memory:} analyze-index {
  CREATE TABLE temp (a integer, b integer);
  CREATE INDEX temp_b ON temp (b);
  INSERT INTO temp select value, value + 1 from generate_series(1,100);
  ANALYZE temp_b;
  SELECT idx, stat FROM sqlite_stat1 where idx = 'temp_b';
} {{temp_b|100 100}}

# Things that don't work:
do_execsql_test_in_memory_error analyze-table-without-rowid-fails {
  CREATE TABLE temp (a integer primary key) WITHOUT ROWID;
  ANALYZE temp;
} {.*ANALYZE.*not supported.*}
