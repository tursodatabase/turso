#!/usr/bin/env tclsh

# Tests for LATERAL JOIN functionality
# Based on Master's thesis "Lateral Join for SQLite" by Jonatan Braun (2021)
#
# Note: LATERAL JOIN currently works with subqueries as the left-side table.
# Support for BTree tables as the left-side requires additional changes to
# the cursor emission order and is a future enhancement.

set testdir [file dirname $argv0]
source $testdir/tester.tcl

# Basic LATERAL JOIN with simple value binding
# The subquery references the outer value 'x' from q1
do_execsql_test lateral-basic-value-binding {
    SELECT * FROM (SELECT 42 AS x) AS q1 LATERAL JOIN (SELECT x + 1 AS res) AS result;
} {42|43}

# Chained LATERAL JOINs (like thesis example)
# Each subsequent subquery can reference columns from all preceding tables
do_execsql_test lateral-chained {
    SELECT result.res FROM
        (SELECT 42 AS x) AS q1
        LATERAL JOIN (SELECT x AS y_2) AS let1
        LATERAL JOIN (SELECT y_2 + 1 AS res) AS result;
} {43}

# Multiple LATERAL with references to different preceding tables
do_execsql_test lateral-multiple-references {
    SELECT * FROM
        (SELECT 10 AS a) AS t1
        LATERAL JOIN (SELECT a * 2 AS b) AS t2
        LATERAL JOIN (SELECT a + b AS c) AS t3;
} {10|20|30}

# LATERAL JOIN vs regular JOIN - LATERAL can reference outer, regular cannot
# This shows that LATERAL actually makes the reference work
do_execsql_test lateral-versus-regular-join {
    SELECT * FROM (SELECT 5 AS x) AS outer_tbl LATERAL JOIN (SELECT x * x AS square) AS inner_tbl;
} {5|25}

# LATERAL with nested computation
do_execsql_test lateral-nested-computation {
    SELECT result
    FROM (SELECT 100 AS base) AS q1
    LATERAL JOIN (SELECT base / 10 AS tenth) AS q2
    LATERAL JOIN (SELECT tenth + 5 AS result) AS q3;
} {15}

# LATERAL with string values
do_execsql_test lateral-string-values {
    SELECT * FROM (SELECT 'hello' AS greeting) AS q1 LATERAL JOIN (SELECT greeting || ' world' AS message) AS q2;
} {hello|hello\ world}

# LATERAL referencing multiple columns from preceding subquery
do_execsql_test lateral-multiple-columns {
    SELECT sum
    FROM (SELECT 1 AS a, 2 AS b, 3 AS c) AS q1
    LATERAL JOIN (SELECT a + b + c AS sum) AS q2;
} {6}

# Error: LATERAL on non-subquery should fail
do_catchsql_test lateral-error-non-subquery {
    CREATE TABLE IF NOT EXISTS dummy1 (x INTEGER);
    SELECT * FROM dummy1 LATERAL JOIN dummy1;
} {1 {LATERAL can only be applied to subqueries}}

# Cleanup
do_execsql_test lateral-cleanup-error-test {
    DROP TABLE IF EXISTS dummy1;
} {}

# Error: LEFT LATERAL JOIN should fail (not supported)
do_catchsql_test lateral-error-left-lateral {
    SELECT * FROM (SELECT 1 AS x) AS t1 LEFT LATERAL JOIN (SELECT x) AS t2;
} {1 {LEFT/RIGHT LATERAL JOIN is not yet supported}}

# Error: RIGHT LATERAL JOIN should fail (not supported)
do_catchsql_test lateral-error-right-lateral {
    SELECT * FROM (SELECT 1 AS x) AS t1 RIGHT LATERAL JOIN (SELECT x) AS t2;
} {1 {RIGHT JOIN is not supported}}

finish_test
