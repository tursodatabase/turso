name: SQL Tests

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  sqltest-check:
    name: Check .sqltest syntax
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - name: Build test runner
        run: make -C turso-test-runner build-runner
      - name: Check test syntax
        run: make -C turso-test-runner check

  sqltest-run-cli:
    name: Run SQL tests (CLI backend)
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Build tursodb
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: make -C turso-test-runner build-tursodb
      - name: Build test runner
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: make -C turso-test-runner build-runner
      - name: Run tests
        run: make -C turso-test-runner run-cli

  sqltest-run-rust:
    name: Run SQL tests (Rust backend)
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - name: Build test runner
        run: make -C turso-test-runner build-runner
      - name: Run tests
        run: make -C turso-test-runner run-rust

  sqltest-sqlite:
    name: Run SQL tests (SQLite)
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - uses: "./.github/shared/install_sqlite"
      - name: Build test runner
        run: make -C turso-test-runner build-runner
      - name: Run tests against SQLite
        run: make -C turso-test-runner test-sqlite
