name: SQL Tests

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  sqltest-check:
    name: Check .sqltest syntax
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - name: Build test runner
        run: make -C turso-test-runner build-runner
      - name: Check test syntax
        run: make -C turso-test-runner check

  sqltest-run-cli:
    name: SQL tests CLI (${{ matrix.mode }})
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - mode: normal
            mvcc_flag: ""
          - mode: mvcc
            mvcc_flag: "MVCC=1"
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Build tursodb
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: make -C turso-test-runner build-tursodb
      - name: Build test runner
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: make -C turso-test-runner build-runner
      - name: Run tests
        run: make -C turso-test-runner run-cli ${{ matrix.mvcc_flag }}

  sqltest-run-rust:
    name: SQL tests Rust (${{ matrix.mode }})
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - mode: normal
            mvcc_flag: ""
          - mode: mvcc
            mvcc_flag: "MVCC=1"
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - name: Build test runner
        run: make -C turso-test-runner build-runner
      - name: Run tests
        run: make -C turso-test-runner run-rust ${{ matrix.mvcc_flag }}

  sqltest-run-js:
    name: SQL tests JS (${{ matrix.mode }})
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - mode: normal
            mvcc_flag: ""
          - mode: mvcc
            mvcc_flag: "MVCC=1"
    defaults:
      run:
        working-directory: bindings/javascript
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - name: Setup node
        uses: useblacksmith/setup-node@v5
        with:
          node-version: 20
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install JS dependencies
        run: yarn install
      - name: Build common package
        run: yarn workspace @tursodatabase/database-common build
      - name: Build native bindings
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: yarn workspace @tursodatabase/database napi-build --target x86_64-unknown-linux-gnu
      - name: Build TypeScript
        run: yarn workspace @tursodatabase/database tsc-build
      - name: Build test runner
        working-directory: turso-test-runner
        env:
          SCCACHE_GHA_ENABLED: "true"
          RUSTC_WRAPPER: "sccache"
        run: cargo build --release
      - name: Run tests
        working-directory: turso-test-runner
        run: make run-js ${{ matrix.mvcc_flag }}

  sqltest-sqlite:
    name: Run SQL tests (SQLite)
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v3
      - uses: useblacksmith/rust-cache@v3
        with:
          prefix-key: "v1-rust"
      - uses: "./.github/shared/install_sqlite"
      - name: Build test runner
        run: make -C turso-test-runner build-runner
      - name: Run tests against SQLite
        run: make -C turso-test-runner test-sqlite
