# AUTOINCREMENT Tests
# Ported from testing/autoincr.test

@database :memory:

# Create AUTOINCREMENT table and verify sqlite_sequence is created
setup autoinc-create-sequence-table {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
}

@setup autoinc-create-sequence-table
test autoinc-create-sequence-table {
    SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;
}
expect {
    sqlite_sequence
    t1
}

# sqlite_sequence table is initially empty after table creation
setup autoinc-sequence-table-is-initially-empty {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
}

@setup autoinc-sequence-table-is-initially-empty
test autoinc-sequence-table-is-initially-empty {
    SELECT * FROM sqlite_sequence;
}
expect {
}

# Cannot drop sqlite_sequence table
setup autoinc-fail-drop-sequence-table {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
}

@setup autoinc-fail-drop-sequence-table
test autoinc-fail-drop-sequence-table {
    DROP TABLE sqlite_sequence;
}
expect error {}

# Cannot create index on sqlite_sequence table
setup autoinc-fail-index-sequence-table {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
}

@setup autoinc-fail-index-sequence-table
test autoinc-fail-index-sequence-table {
    CREATE INDEX seqidx ON sqlite_sequence(name);
}
expect error {}

# First insert populates sqlite_sequence
setup autoinc-first-insert-populates-sequence {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
}

@setup autoinc-first-insert-populates-sequence
test autoinc-first-insert-populates-sequence {
    INSERT INTO t1 VALUES(12,34);
    SELECT * FROM sqlite_sequence;
}
expect {
    t1|12
}

# Inserting larger value updates sequence
setup autoinc-larger-insert-updates-sequence {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    INSERT INTO t1 VALUES(12,34);
}

@setup autoinc-larger-insert-updates-sequence
test autoinc-larger-insert-updates-sequence {
    INSERT INTO t1 VALUES(123,456);
    SELECT * FROM sqlite_sequence;
}
expect {
    t1|123
}

# Inserting NULL generates key one greater than max
setup autoinc-null-insert-increments-sequence {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    INSERT INTO t1 VALUES(123,456);
}

@setup autoinc-null-insert-increments-sequence
test autoinc-null-insert-increments-sequence {
    INSERT INTO t1 VALUES(NULL,567);
    SELECT * FROM sqlite_sequence;
}
expect {
    t1|124
}

# Sequence value is not decreased after DELETE
setup autoinc-sequence-not-decremented-by-delete {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    INSERT INTO t1 VALUES(123,456);
    INSERT INTO t1 VALUES(NULL,567);
}

@setup autoinc-sequence-not-decremented-by-delete
test autoinc-sequence-not-decremented-by-delete {
    DELETE FROM t1 WHERE y=567;
    SELECT * FROM sqlite_sequence;
}
expect {
    t1|124
}

# NULL insert after DELETE continues from high-water mark
setup autoinc-insert-after-delete-uses-high-water-mark {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    INSERT INTO t1 VALUES(125, 1);
    DELETE FROM t1;
}

@setup autoinc-insert-after-delete-uses-high-water-mark
test autoinc-insert-after-delete-uses-high-water-mark {
    INSERT INTO t1 VALUES(NULL, 2);
    SELECT x FROM t1;
}
expect {
    126
}

# Clearing table does not reset sequence
setup autoinc-delete-all-does-not-reset-sequence {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    INSERT INTO t1 VALUES(125, 456);
    DELETE FROM t1;
}

@setup autoinc-delete-all-does-not-reset-sequence
test autoinc-delete-all-does-not-reset-sequence {
    SELECT * FROM sqlite_sequence;
}
expect {
    t1|125
}

# Manually updating sequence table affects next generated key
setup autoinc-manual-update-to-sequence-table {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    INSERT INTO t1 VALUES(1, 1);
}

@setup autoinc-manual-update-to-sequence-table
test autoinc-manual-update-to-sequence-table {
    UPDATE sqlite_sequence SET seq=1234 WHERE name='t1';
    INSERT INTO t1 VALUES(NULL, 2);
    SELECT * FROM t1 ORDER BY x;
}
expect {
    1|1
    1235|2
}

# AUTOINCREMENT works for multiple tables independently
setup autoinc-multiple-tables {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    CREATE TABLE t2(d, e INTEGER PRIMARY KEY AUTOINCREMENT, f);
    CREATE TABLE t3(g INTEGER PRIMARY KEY AUTOINCREMENT, h);
}

@setup autoinc-multiple-tables
test autoinc-multiple-tables {
    INSERT INTO t1(y) VALUES('a');
    INSERT INTO t2(d) VALUES('b');
    INSERT INTO t2(d) VALUES('c');
    INSERT INTO t3(h) VALUES('d');
    INSERT INTO t1(x) VALUES(100);
    SELECT name, seq FROM sqlite_sequence ORDER BY name;
}
expect {
    t1|100
    t2|2
    t3|1
}

# Dropping AUTOINCREMENT table removes its entry from sqlite_sequence
setup autoinc-drop-table-removes-sequence-entry {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    CREATE TABLE t2(d, e INTEGER PRIMARY KEY AUTOINCREMENT, f);
    INSERT INTO t1(y) VALUES('a');
    INSERT INTO t2(d) VALUES('b');
}

@setup autoinc-drop-table-removes-sequence-entry
test autoinc-drop-table-removes-sequence-entry {
    DROP TABLE t1;
    SELECT name FROM sqlite_sequence;
}
expect {
    t2
}

# When last AUTOINCREMENT table is dropped, sequence table remains but is empty
setup autoinc-drop-last-table-empties-sequence {
    CREATE TABLE t1(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
}

@setup autoinc-drop-last-table-empties-sequence
test autoinc-drop-last-table-empties-sequence {
    DROP TABLE t1;
    SELECT * FROM sqlite_sequence;
}
expect {
}

# AUTOINCREMENT fails when maximum rowid is reached
setup autoinc-fail-on-max-rowid {
    CREATE TABLE t6(v INTEGER PRIMARY KEY AUTOINCREMENT, w);
    INSERT INTO t6 VALUES(9223372036854775807, 1);
}

@setup autoinc-fail-on-max-rowid
test autoinc-fail-on-max-rowid {
    INSERT INTO t6 VALUES(NULL, 2);
}
expect error {}

# AUTOINCREMENT keyword in separate PRIMARY KEY clause
setup autoinc-keyword-in-pk-clause {
    CREATE TABLE t7(x INTEGER, y REAL, PRIMARY KEY(x AUTOINCREMENT));
}

@setup autoinc-keyword-in-pk-clause
test autoinc-keyword-in-pk-clause {
    INSERT INTO t7(y) VALUES(123);
    INSERT INTO t7(y) VALUES(234);
    DELETE FROM t7;
    INSERT INTO t7(y) VALUES(345);
    SELECT * FROM t7;
}
expect {
    3|345.0
}

# AUTOINCREMENT fails if primary key is not INTEGER
test autoinc-fail-on-non-integer-pk {
    CREATE TABLE t8(x TEXT PRIMARY KEY AUTOINCREMENT);
}
expect error {}

# Empty INSERT...SELECT does not damage sequence table
setup autoinc-empty-insert-select-is-safe {
    CREATE TABLE t2(x INTEGER PRIMARY KEY AUTOINCREMENT, y);
    INSERT INTO t2 VALUES(NULL, 1);
    CREATE TABLE t3(a INTEGER PRIMARY KEY AUTOINCREMENT, b);
}

@setup autoinc-empty-insert-select-is-safe
test autoinc-empty-insert-select-is-safe {
    INSERT INTO t3 SELECT * FROM t2 WHERE y > 1;
    SELECT * FROM sqlite_sequence WHERE name='t3';
}
expect {
    t3|0
}

# AUTOINCREMENT with xfer optimization
setup autoinc-with-xfer-optimization {
    CREATE TABLE t10a(a INTEGER PRIMARY KEY AUTOINCREMENT, b UNIQUE);
    INSERT INTO t10a VALUES(888,9999);
    CREATE TABLE t10b(x INTEGER PRIMARY KEY AUTOINCREMENT, y UNIQUE);
}

@setup autoinc-with-xfer-optimization
test autoinc-with-xfer-optimization {
    INSERT INTO t10b SELECT * FROM t10a;
    SELECT * FROM sqlite_sequence ORDER BY name;
}
expect {
    t10a|888
    t10b|888
}

# AUTOINCREMENT with UPSERT
setup autoinc-with-upsert {
    CREATE TABLE t11(a INTEGER PRIMARY KEY AUTOINCREMENT, b UNIQUE);
}

@setup autoinc-with-upsert
test autoinc-with-upsert {
    INSERT INTO t11(a,b) VALUES(2,3),(5,6),(4,3),(1,2)
        ON CONFLICT(b) DO UPDATE SET a=a+1000;
    SELECT seq FROM sqlite_sequence WHERE name='t11';
}
expect {
    5
}

# AUTOINCREMENT skips manually updated PK
setup autoinc-skips-manually-updated-pk {
    CREATE TABLE t(a INTEGER PRIMARY KEY AUTOINCREMENT);
    INSERT INTO t DEFAULT VALUES;
}

@setup autoinc-skips-manually-updated-pk
test autoinc-skips-manually-updated-pk {
    select * from sqlite_sequence;
    UPDATE t SET a = a + 1;
    SELECT * FROM sqlite_sequence;
    INSERT INTO t DEFAULT VALUES;
    SELECT * FROM sqlite_sequence;
}
expect {
    t|1
    t|1
    t|3
}

