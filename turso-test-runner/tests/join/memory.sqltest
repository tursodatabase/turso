# JOIN Tests (Memory - standalone tests)
# Ported from testing/join.test

@database :memory:

setup min-null-regression {
    create table t (x integer primary key, y);
    create table u (x integer primary key, y);
    insert into t values (1,1),(2,2);
    insert into u values (1,1),(3,3);
}

@setup min-null-regression
test min-null-regression-test {
    select count(u.x) from t left join u using(y);
}
expect {
    1
}

setup left-join-seek-key-regression {
    CREATE TABLE t (x INTEGER PRIMARY KEY);
    CREATE TABLE u (x INTEGER PRIMARY KEY);
    INSERT INTO t VALUES (1);
}

@setup left-join-seek-key-regression
test left-join-seek-key-regression-test {
    SELECT * FROM t LEFT JOIN u ON false WHERE u.x = 1;
}
expect {
}

setup next-crash {
    create table a(x int primary key,y);
    create table b(x int primary key,y);
    create table c(x int primary key,y);
    insert into a values (1,1),(2,2);
}

@setup next-crash
test next-crash {
    select a.x, b.x, c.x from a left join b on a.y=b.x left join c on b.y=c.x;
}
expect {
    1||
    2||
}

setup left-join-column-crash {
    create table a(x int primary key,y);
    create table b(x int primary key,y);
    insert into a values (1,1),(2,2);
    insert into b values (3,3),(4,4);
}

@setup left-join-column-crash
test left-join-column-crash {
    select * from a left join b on a.x < 2 where a.x < 3 and b.x < 12;
}
expect {
    1|1|3|3
    1|1|4|4
}

setup left-join-subquery-on {
    CREATE TABLE t1(a INTEGER);
    INSERT INTO t1 VALUES (1),(2),(3);
    CREATE TABLE t2(b INTEGER);
    INSERT INTO t2 VALUES (2),(4);
}

@setup left-join-subquery-on
test left-join-subquery-on {
    SELECT a, b FROM t1 LEFT JOIN (SELECT * FROM t2 WHERE b > 2) ON t1.a = b ORDER BY a;
}
expect {
    1|
    2|
    3|
}

setup using-deduplicates-columns {
    create table t(a);
    create table tt(a);
    insert into t values (1),(2),(3),(4),(5);
    insert into tt values (4),(5),(6),(7),(8);
}

@setup using-deduplicates-columns
test using-deduplicates-columns {
    select a from t join tt using(a);
}
expect {
    4
    5
}

setup left-join-where-clause-regression {
    create table t(a);
    create table s(a);
    insert into t values (1), (2);
    insert into s values (2);
}

@setup left-join-where-clause-regression
test left-join-where-clause-regression {
    select t.a, s.a from t left join s on t.a=s.a where t.a = 2;
    select t.a, s.a from t left join s on t.a=s.a where s.a = 2;
}
expect {
    2|2
    2|2
}

setup left-join-using-star-vs-explicit {
    create table t(a, tb);
    create table s(a, sb);
    insert into t values (1, 't1'), (2, 't2');
    insert into s values (1, 's1'), (3, 's3');
}

@setup left-join-using-star-vs-explicit
test left-join-using-star-vs-explicit {
    select * from t left join s using(a);
    select a, tb, sb from t left join s using(a);
}
expect {
    1|t1|s1
    2|t2|
    1|t1|s1
    2|t2|
}

setup left-join-using-null {
    create table t(a, b);
    create table s(a, b);
    insert into t values (1, null), (2, null);
    insert into s values (1, null), (2, null);
}

@setup left-join-using-null
test left-join-using-null {
    select a, b from t left join s using (a, b);
}
expect {
    1|
    2|
}

setup redundant-join-condition {
    create table t(x);
    insert into t values ('lol');
}

@setup redundant-join-condition
test redundant-join-condition {
    select t1.x from t t1 join t t2 on t1.x=t2.x where t1.x=t2.x;
}
expect {
    lol
}

setup left-join-duplicate-column-constraints {
    CREATE TABLE t1(id INTEGER PRIMARY KEY, a INT, c INT);
    CREATE TABLE t2(id INTEGER PRIMARY KEY, a INT, c INT);
    CREATE TABLE t3(id INTEGER PRIMARY KEY, b INT);
    INSERT INTO t1 VALUES (1, 17, 20);
    INSERT INTO t2 VALUES (1, 17, 20);
    INSERT INTO t3 VALUES (1, 17);
}

@setup left-join-duplicate-column-constraints
test left-join-duplicate-column-constraints {
    SELECT t1.a, t2.a, t2.c, t3.b FROM t1 LEFT JOIN t2 ON t1.a = t2.a AND t1.c = t2.c LEFT JOIN t3 ON t2.a = t3.b WHERE t2.a = 17;
}
expect {
    17|17|20|17
}

setup spill-hash-join {
    CREATE TABLE t(a,b);
    CREATE TABLE t2(a,b);
    INSERT INTO t SELECT replace(substr(quote(zeroblob((1024*10 + 1) / 2)), 3, 1024*10), '0', 'a'), 'abcdef' FROM generate_series(1,150);
    INSERT INTO t2 SELECT replace(substr(quote(zeroblob((1024*10 + 1) / 2)), 3,1024*10), '0', 'a'), 'abcdef' FROM generate_series(1,150);
}

@setup spill-hash-join
test test-spill-hash-join-count {
    SELECT count(*) FROM t JOIN t2 ON t.a = t2.a;
}
expect {
    22500
}

@setup spill-hash-join
test test-spill-hash-join-rows {
    SELECT substr(t.a, 1,4), substr(t2.b, 1, 4) FROM t JOIN t2 ON t.a = t2.a limit 2;
}
expect {
    aaaa|abcd
    aaaa|abcd
}

setup inner-join-using-null {
    create table t(a, b);
    create table s(a, b);
    insert into t values (1, null), (2, null);
    insert into s values (1, null), (2, null);
}

@setup inner-join-using-null
test inner-join-using-null {
    select a, b from t join s using (a, b);
}
expect {
}

setup left-join-null-probe-key {
    create table t(a, b);
    create table s(a, b);
    insert into t values (1, 'x'), (null, 'y');
    insert into s values (1, 'x');
}

@setup left-join-null-probe-key
test left-join-null-probe-key {
    select t.a, t.b, s.a, s.b
      from t
      left join s on t.a = s.a and t.b = s.b
     order by t.rowid;
}
expect {
    1|x|1|x
    |y||
}

setup three-way-left-chain-null {
    create table t(a, b);
    create table u(a, b);
    create table v(a, b);
    insert into t values (1, 't1'), (2, 't2'), (3, null);
    insert into u values (1, 'u1'), (2, null);
    insert into v values (1, 'v1'), (2, 'v2'), (3, 'v3');
}

@setup three-way-left-chain-null
test three-way-left-chain-null {
    select t.a, t.b, u.b, v.b
      from t
      left join u on t.a = u.a and t.b = u.b
      left join v on t.a = v.a
     order by t.a;
}
expect {
    1|t1||v1
    2|t2||v2
    3|||v3
}

setup three-way-inner-using-null {
    create table t(a, b);
    create table u(a, b);
    create table v(a, b);
    insert into t values (1, 'x'), (2, null), (3, 'z');
    insert into u values (1, 'x'), (2, null), (3, 'z');
    insert into v values (1, 'x'), (2, null), (3, 'z');
}

@setup three-way-inner-using-null
test three-way-inner-using-null {
    select a, b, '|' as sep
      from t
      join u using(a, b)
      join v using(a, b)
     order by a;
}
expect {
    1|x||
    3|z||
}

setup four-way-left-joins-null-keys {
    create table t(a, b);
    create table u(a, b);
    create table v(a, b);
    create table w(a, b);
    insert into t values (1, 't1'), (2, null);
    insert into u values (1, 't1'), (2, 'u2');
    insert into v values (1, 'v1'), (2, null);
    insert into w values (1, 'w1');
}

@setup four-way-left-joins-null-keys
test four-way-left-joins-null-keys {
    select t.a, t.b, u.b, v.b, w.b
      from t
      left join u on t.a = u.a and t.b = u.b
      left join v on t.a = v.a and t.b = v.b
      left join w on t.a = w.a
     order by t.a;
}
expect {
    1|t1|t1||w1
    2||||
}

