# Aggregate Functions Tests (Readonly - uses products/users tables)
# Ported from testing/agg-functions.test

@database database/testing.db readonly
@database database/testing_norowidalias.db readonly

test select-avg {
    SELECT avg(age) FROM users;
}
expect {
    50.396
}

test select-avg-text {
    SELECT avg(first_name) FROM users;
}
expect {
    0.0
}

test select-sum {
    SELECT sum(age) FROM users;
}
expect {
    503960
}

test select-sum-text {
    SELECT sum(first_name) FROM users;
}
expect {
    0.0
}

test select-total {
    SELECT total(age) FROM users;
}
expect {
    503960.0
}

test select-total-text {
    SELECT total(first_name) FROM users WHERE id < 3;
}
expect {
    0.0
}

test select-limit {
    SELECT typeof(id) FROM users LIMIT 1;
}
expect {
    integer
}

test select-count {
    SELECT count(id) FROM users;
}
expect {
    10000
}

test select-count-star {
    SELECT count(*) FROM users;
}
expect {
    10000
}

test select-count-constant-true {
    SELECT count(*) FROM users WHERE true;
}
expect {
    10000
}

test select-count-constant-false {
    SELECT count(*) FROM users WHERE false;
}
expect {
    0
}

test select-max {
    SELECT max(age) FROM users;
}
expect {
    100
}

test select-min {
    SELECT min(age) FROM users;
}
expect {
    1
}

test select-max-text {
    SELECT max(first_name) FROM users;
}
expect {
    Zoe
}

test select-min-text {
    SELECT min(first_name) FROM users;
}
expect {
    Aaron
}

test select-group-concat {
    SELECT group_concat(name) FROM products;
}
expect {
    hat,cap,shirt,sweater,sweatshirt,shorts,jeans,sneakers,boots,coat,accessories
}

test select-group-concat-with-delimiter {
    SELECT group_concat(name, ';') FROM products;
}
expect {
    hat;cap;shirt;sweater;sweatshirt;shorts;jeans;sneakers;boots;coat;accessories
}

test select-group-concat-with-delimiter-expression {
    SELECT group_concat(name, ';' || '|') FROM products;
}
expect {
    hat;|cap;|shirt;|sweater;|sweatshirt;|shorts;|jeans;|sneakers;|boots;|coat;|accessories
}

test select-group-concat-with-column-delimiter {
    SELECT group_concat(name, id) FROM products;
}
expect {
    hat2cap3shirt4sweater5sweatshirt6shorts7jeans8sneakers9boots10coat11accessories
}

test select-group-concat-with-column-delimiter-group-by {
    SELECT group_concat(name, id) FROM products GROUP BY '1';
}
expect {
    hat2cap3shirt4sweater5sweatshirt6shorts7jeans8sneakers9boots10coat11accessories
}

test select-string-agg-with-delimiter {
    SELECT string_agg(name, ',') FROM products;
}
expect {
    hat,cap,shirt,sweater,sweatshirt,shorts,jeans,sneakers,boots,coat,accessories
}

test select-string-agg-with-delimiter-expression {
    SELECT string_agg(name, ';' || '|') FROM products;
}
expect {
    hat;|cap;|shirt;|sweater;|sweatshirt;|shorts;|jeans;|sneakers;|boots;|coat;|accessories
}

test select-string-agg-with-column-delimiter {
    SELECT string_agg(name, id) FROM products;
}
expect {
    hat2cap3shirt4sweater5sweatshirt6shorts7jeans8sneakers9boots10coat11accessories
}

test select-string-agg-with-column-delimiter-group-by {
    SELECT string_agg(name, id) FROM products GROUP BY '1';
}
expect {
    hat2cap3shirt4sweater5sweatshirt6shorts7jeans8sneakers9boots10coat11accessories
}

test select-agg-unary-negative {
    SELECT -max(age) FROM users;
}
expect {
    -100
}

test select-agg-unary-positive {
    SELECT +max(age) FROM users;
}
expect {
    100
}

test select-agg-binary-unary-negative {
    SELECT min(age) + -max(age) FROM users;
}
expect {
    -99
}

test select-agg-binary-unary-positive {
    SELECT min(age) + +max(age) FROM users;
}
expect {
    101
}

test select-non-agg-cols-should-be-not-null {
    SELECT id, first_name, sum(age) FROM users LIMIT 1;
}
expect {
    1|Jamie|503960
}

test select-with-group-by-and-agg-1 {
    SELECT id, first_name, avg(age) FROM users GROUP BY last_name LIMIT 1;
}
expect {
    274|Debra|66.25
}

test select-with-group-by-and-agg-2 {
    SELECT first_name, last_name FROM users WHERE state = 'AL' GROUP BY last_name LIMIT 10;
}
expect {
    Jay|Acosta
    Daniel|Adams
    Aaron|Baker
    Sharon|Becker
    Kim|Berg
    Donald|Bishop
    Brian|Bradford
    Jesus|Bradley
    John|Brown
    Hunter|Burke
}

test select-agg-json-array {
    SELECT json_group_array(name) FROM products;
}
expect {
    ["hat","cap","shirt","sweater","sweatshirt","shorts","jeans","sneakers","boots","coat","accessories"]
}

test select-agg-json-array-object {
    SELECT json_group_array(json_object('name', name)) FROM products;
}
expect {
    [{"name":"hat"},{"name":"cap"},{"name":"shirt"},{"name":"sweater"},{"name":"sweatshirt"},{"name":"shorts"},{"name":"jeans"},{"name":"sneakers"},{"name":"boots"},{"name":"coat"},{"name":"accessories"}]
}

test select-distinct-agg-functions {
    SELECT sum(distinct age), count(distinct age), avg(distinct age) FROM users;
}
expect {
    5050|100|50.5
}

test select-json-group-object {
    SELECT price, json_group_object(CAST (id AS text), name) FROM products GROUP BY price ORDER BY price;
}
expect {
    1.0|{"9":"boots"}
    18.0|{"3":"shirt"}
    25.0|{"4":"sweater"}
    33.0|{"10":"coat"}
    70.0|{"6":"shorts"}
    74.0|{"5":"sweatshirt"}
    78.0|{"7":"jeans"}
    79.0|{"1":"hat"}
    81.0|{"11":"accessories"}
    82.0|{"2":"cap","8":"sneakers"}
}

test select-json-group-object-no-sorting-required {
    SELECT age, json_group_object(CAST (id AS text), first_name)
    FROM users
    WHERE first_name LIKE 'Am%'
    GROUP BY age
    ORDER BY age
    LIMIT 5;
}
expect {
    1|{"6737":"Amy"}
    2|{"2297":"Amy","3580":"Amanda"}
    3|{"3437":"Amanda"}
    5|{"2378":"Amy","3227":"Amy","5605":"Amanda"}
    7|{"2454":"Amber"}
}

test select-max-star {
    SELECT max(*) FROM users;
}
expect error {
    wrong number of arguments to function
}

test select-max-star-in-expression {
    SELECT CASE WHEN max(*) > 0 THEN 1 ELSE 0 END FROM users;
}
expect error {
    wrong number of arguments to function
}

test select-scalar-func-star {
    SELECT abs(*) FROM users;
}
expect error {}

test select-scalar-func-star-in-expression {
    SELECT CASE WHEN abs(*) > 0 THEN 1 ELSE 0 END FROM users;
}
expect error {}

test select-nested-agg-func {
    SELECT max(abs(sum(age))), sum(age) FROM users;
}
expect error {
    misuse of aggregate function
}

test select-nested-agg-func-in-expression {
    SELECT CASE WHEN max(abs(sum(age))) > 0 THEN 1 ELSE 0 END, sum(age) FROM users;
}
expect error {
    misuse of aggregate function
}

# https://github.com/tursodatabase/turso/issues/3308
test printf-19029102 {
    SELECT printf('%d', 3.9);
}
expect {
    3
}
