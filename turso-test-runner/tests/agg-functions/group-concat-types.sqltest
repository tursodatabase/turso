@database :memory:

# Tests for GROUP_CONCAT always returning TEXT type
# Regression tests for: GROUP_CONCAT was returning Integer instead of Text

test group-concat-integer-returns-text-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-single-integer-returns-text-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (42);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-single-integer-value {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (42);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    42
}

test group-concat-integer-separator {
    CREATE TABLE t(x TEXT);
    INSERT INTO t VALUES ('a'), ('b'), ('c');
    SELECT GROUP_CONCAT(x, 100) FROM t;
}
expect {
    a100b100c
}

test group-concat-integer-separator-type {
    CREATE TABLE t(x TEXT);
    INSERT INTO t VALUES ('a'), ('b'), ('c');
    SELECT typeof(GROUP_CONCAT(x, 100)) FROM t;
}
expect {
    text
}

test group-concat-null-separator {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT GROUP_CONCAT(x, NULL) FROM t;
}
expect {
    123
}

test group-concat-null-separator-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT typeof(GROUP_CONCAT(x, NULL)) FROM t;
}
expect {
    text
}

test group-concat-with-null-values {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (NULL), (3);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1,3
}

test group-concat-only-null-values {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (NULL), (NULL);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
}

test group-concat-first-value-null {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (NULL), (1), (2);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1,2
}

test group-concat-first-value-null-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (NULL), (1), (2);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-float-returns-text-type {
    CREATE TABLE t(x REAL);
    INSERT INTO t VALUES (1.5);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-boolean-expression-returns-text {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2);
    SELECT typeof(GROUP_CONCAT(x > 0)) FROM t;
}
expect {
    text
}

test group-concat-boolean-expression-value {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2);
    SELECT GROUP_CONCAT(x > 0) FROM t;
}
expect {
    1,1
}

test string-agg-integer-returns-text-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT typeof(STRING_AGG(x, ',')) FROM t;
}
expect {
    text
}

test string-agg-single-integer-returns-text-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (42);
    SELECT typeof(STRING_AGG(x, ',')) FROM t;
}
expect {
    text
}

test string-agg-integer-separator {
    CREATE TABLE t(x TEXT);
    INSERT INTO t VALUES ('a'), ('b'), ('c');
    SELECT STRING_AGG(x, 100) FROM t;
}
expect {
    a100b100c
}

# Mixed type permutation tests

test group-concat-integer-and-text {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (1), ('hello'), (2);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1,hello,2
}

test group-concat-integer-and-text-type {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (1), ('hello'), (2);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-real-and-integer {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (1.5), (2), (3.7);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1.5,2,3.7
}

test group-concat-real-and-integer-type {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (1.5), (2), (3.7);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-text-and-real {
    CREATE TABLE t(x);
    INSERT INTO t VALUES ('abc'), (3.14), ('def');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    abc,3.14,def
}

test group-concat-blob-single {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (x'48454c4c4f');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    HELLO
}

test group-concat-blob-single-type {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (x'48454c4c4f');
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-blob-multiple {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (x'48454c4c4f'), (x'574f524c44');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    HELLO,WORLD
}

test group-concat-blob-and-text {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (x'48454c4c4f'), ('world');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    HELLO,world
}

test group-concat-blob-and-integer {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (x'4142'), (123), (x'4344');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    AB,123,CD
}

test group-concat-blob-and-real {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (x'4142'), (3.14);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    AB,3.14
}

test group-concat-null-and-integer {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (NULL), (1), (NULL), (2);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1,2
}

test group-concat-null-and-text {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (NULL), ('a'), (NULL), ('b');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    a,b
}

test group-concat-null-and-blob {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (NULL), (x'4142'), (NULL);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    AB
}

test group-concat-null-and-real {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (NULL), (1.5), (NULL), (2.5);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1.5,2.5
}

test group-concat-all-types-mixed {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (1), ('hello'), (3.14), (x'4142'), (NULL), (2);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1,hello,3.14,AB,2
}

test group-concat-all-types-mixed-type {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (1), ('hello'), (3.14), (x'4142'), (NULL), (2);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-integer-text-real-blob {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (42), ('foo'), (2.718), (x'424152');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    42,foo,2.718,BAR
}

test group-concat-real-blob-text-integer {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (1.1), (x'5858'), ('yy'), (99);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1.1,XX,yy,99
}

# Mixed types with custom separator

test group-concat-mixed-types-custom-separator {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (1), ('a'), (2.5);
    SELECT GROUP_CONCAT(x, ' | ') FROM t;
}
expect {
    1 | a | 2.5
}

test group-concat-blob-text-integer-separator {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (x'4142'), ('cd'), (12);
    SELECT GROUP_CONCAT(x, '-') FROM t;
}
expect {
    AB-cd-12
}

# Empty string and mixed types

test group-concat-empty-string-and-integer {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (''), (1), ('');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    ,1,
}

test group-concat-empty-string-and-blob {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (''), (x'4142'), ('');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    ,AB,
}

# Zero values with different types

test group-concat-zero-integer-and-text {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (0), ('zero'), (0);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    0,zero,0
}

test group-concat-zero-real-and-text {
    CREATE TABLE t(x);
    INSERT INTO t VALUES (0.0), ('zero');
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    0.0,zero
}

test group-concat-invalid-utf {
    CREATE TABLE t(s TEXT);
    INSERT INTO t VALUES (X'FF');
    INSERT INTO t VALUES (X'C0C1'); 
    select group_concat(s) from t;
}
expect {
    �,��
}


