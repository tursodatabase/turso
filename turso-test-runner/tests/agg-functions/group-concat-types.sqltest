@database :memory:

# Tests for GROUP_CONCAT always returning TEXT type
# Regression tests for: GROUP_CONCAT was returning Integer instead of Text

test group-concat-integer-returns-text-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-single-integer-returns-text-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (42);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-single-integer-value {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (42);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    42
}

test group-concat-integer-separator {
    CREATE TABLE t(x TEXT);
    INSERT INTO t VALUES ('a'), ('b'), ('c');
    SELECT GROUP_CONCAT(x, 100) FROM t;
}
expect {
    a100b100c
}

test group-concat-integer-separator-type {
    CREATE TABLE t(x TEXT);
    INSERT INTO t VALUES ('a'), ('b'), ('c');
    SELECT typeof(GROUP_CONCAT(x, 100)) FROM t;
}
expect {
    text
}

test group-concat-null-separator {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT GROUP_CONCAT(x, NULL) FROM t;
}
expect {
    123
}

test group-concat-null-separator-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT typeof(GROUP_CONCAT(x, NULL)) FROM t;
}
expect {
    text
}

test group-concat-with-null-values {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (NULL), (3);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1,3
}

test group-concat-only-null-values {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (NULL), (NULL);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
}

test group-concat-first-value-null {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (NULL), (1), (2);
    SELECT GROUP_CONCAT(x) FROM t;
}
expect {
    1,2
}

test group-concat-first-value-null-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (NULL), (1), (2);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-float-returns-text-type {
    CREATE TABLE t(x REAL);
    INSERT INTO t VALUES (1.5);
    SELECT typeof(GROUP_CONCAT(x)) FROM t;
}
expect {
    text
}

test group-concat-boolean-expression-returns-text {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2);
    SELECT typeof(GROUP_CONCAT(x > 0)) FROM t;
}
expect {
    text
}

test group-concat-boolean-expression-value {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2);
    SELECT GROUP_CONCAT(x > 0) FROM t;
}
expect {
    1,1
}

test string-agg-integer-returns-text-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (1), (2), (3);
    SELECT typeof(STRING_AGG(x, ',')) FROM t;
}
expect {
    text
}

test string-agg-single-integer-returns-text-type {
    CREATE TABLE t(x INTEGER);
    INSERT INTO t VALUES (42);
    SELECT typeof(STRING_AGG(x, ',')) FROM t;
}
expect {
    text
}

test string-agg-integer-separator {
    CREATE TABLE t(x TEXT);
    INSERT INTO t VALUES ('a'), ('b'), ('c');
    SELECT STRING_AGG(x, 100) FROM t;
}
expect {
    a100b100c
}
