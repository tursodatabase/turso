# DROP TABLE Tests
# Ported from testing/drop_table.test

@database :memory:

# Basic DROP TABLE functionality
setup drop-table-basic-1 {
    CREATE TABLE t1 (x INTEGER PRIMARY KEY);
    INSERT INTO t1 VALUES (1);
    INSERT INTO t1 VALUES (2);
}

@setup drop-table-basic-1
test drop-table-basic-1 {
    DROP TABLE t1;
    SELECT count(*) FROM sqlite_schema WHERE type='table' AND name='t1';
}
expect {
    0
}

# The table should be dropped irrespective of the case of the table name
setup drop-table-case-insensitive {
    CREATE TABLE test (x INTEGER PRIMARY KEY);
    INSERT INTO test VALUES (1);
    INSERT INTO test VALUES (2);
}

@setup drop-table-case-insensitive
test drop-table-case-insensitive {
    DROP TABLE TeSt;
    SELECT count(*) FROM sqlite_schema WHERE type='table' AND name='test';
}
expect {
    0
}

# Test DROP TABLE IF EXISTS on existing table
setup drop-table-if-exists-1 {
    CREATE TABLE t2 (x INTEGER PRIMARY KEY);
}

@setup drop-table-if-exists-1
test drop-table-if-exists-1 {
    DROP TABLE IF EXISTS t2;
    SELECT count(*) FROM sqlite_schema WHERE type='table' AND name='t2';
}
expect {
    0
}

# Test DROP TABLE IF EXISTS on non-existent table
test drop-table-if-exists-2 {
    DROP TABLE IF EXISTS nonexistent_table;
    SELECT 'success';
}
expect {
    success
}

# Test dropping table with index
setup drop-table-with-index-1 {
    CREATE TABLE t3 (x INTEGER PRIMARY KEY, y TEXT);
    CREATE INDEX idx_t3_y ON t3(y);
    INSERT INTO t3 VALUES(1, 'one');
}

@setup drop-table-with-index-1
test drop-table-with-index-1 {
    DROP TABLE t3;
    SELECT count(*) FROM sqlite_schema WHERE tbl_name='t3';
}
expect {
    0
}

# Test dropping table cleans up related schema entries
setup drop-table-schema-cleanup-1 {
    CREATE TABLE t4 (x INTEGER PRIMARY KEY, y TEXT);
    CREATE INDEX idx1_t4 ON t4(x);
    CREATE INDEX idx2_t4 ON t4(y);
    INSERT INTO t4 VALUES(1, 'one');
}

@setup drop-table-schema-cleanup-1
test drop-table-schema-cleanup-1 {
    DROP TABLE t4;
    SELECT count(*) FROM sqlite_schema WHERE tbl_name='t4';
}
expect {
    0
}

# Test dropping table after multiple inserts and deletes
setup drop-table-after-ops-1 {
    CREATE TABLE t6 (x INTEGER PRIMARY KEY);
    INSERT INTO t6 VALUES (1);
    INSERT INTO t6 VALUES (2);
    DELETE FROM t6 WHERE x = 1;
    INSERT INTO t6 VALUES (3);
}

@setup drop-table-after-ops-1
test drop-table-after-ops-1 {
    DROP TABLE t6;
    SELECT count(*) FROM sqlite_schema WHERE type='table' AND name='t6';
}
expect {
    0
}

# Test that DROP TABLE fails when table is referenced by foreign keys
setup drop-table-fk-constraint-failed {
    CREATE TABLE parent(a INTEGER PRIMARY KEY);
    CREATE TABLE child(a INTEGER PRIMARY KEY, b INTEGER, FOREIGN KEY(b) REFERENCES parent(a));
    INSERT INTO parent VALUES (1);
    INSERT INTO child VALUES (123, 1);
}

@setup drop-table-fk-constraint-failed
test drop-table-fk-constraint-failed {
    PRAGMA foreign_keys=ON;
    DROP TABLE parent;
}
expect error {}

# Test that DROP TABLE succeeds when foreign keys are disabled
setup drop-table-fk-disabled-ok {
    CREATE TABLE parent(a INTEGER PRIMARY KEY);
    CREATE TABLE child(a INTEGER PRIMARY KEY, b INTEGER, FOREIGN KEY(b) REFERENCES parent(a));
    INSERT INTO parent VALUES (1);
    INSERT INTO child VALUES (123, 1);
}

@setup drop-table-fk-disabled-ok
test drop-table-fk-disabled-ok {
    PRAGMA foreign_keys=OFF;
    DROP TABLE parent;
    SELECT count(*) FROM sqlite_schema WHERE type='table' AND name='parent';
}
expect {
    0
}

