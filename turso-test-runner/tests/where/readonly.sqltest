# WHERE Tests (Readonly - users/products tables)
# Ported from testing/where.test

@database database/testing.db readonly

# Basic WHERE comparisons
test where-clause-eq {
    select last_name from users where id = 2000;
}
expect {
    Rodriguez
}

test where-clause-eq-string {
    select count(1) from users where last_name = 'Rodriguez';
}
expect {
    61
}

test where-clause-isnull {
    select count(1) from users where last_name isnull;
}
expect {
    0
}

test where-clause-isnull-or-false {
    select count(1) from users where null isnull or 1 != 1;
}
expect {
    10000
}

test where-clause-notnull {
    select count(1) from users where last_name not null;
}
expect {
    10000
}

test where-clause-notnull-or-false {
    select count(1) from users where last_name not null or 1 != 1;
}
expect {
    10000
}

test where-clause-ne {
    select count(1) from users where id != 2000;
}
expect {
    9999
}

test where-clause-gt {
    select count(1) from users where id > 2000;
}
expect {
    8000
}

test where-clause-gte {
    select count(1) from users where id >= 2000;
}
expect {
    8001
}

test where-clause-lt {
    select count(1) from users where id < 2000;
}
expect {
    1999
}

test where-clause-lte {
    select count(1) from users where id <= 2000;
}
expect {
    2000
}

test where-clause-unary-true {
    select count(1) from users where 1;
}
expect {
    10000
}

test where-clause-unary-false {
    select count(1) from users where 0;
}
expect {
    0
}

# No table constant conditions
test where-clause-no-table-constant-condition-true {
    select 1 where 1;
}
expect {
    1
}

test where-clause-no-table-constant-condition-identifier-true {
    select 1 where true;
}
expect {
    1
}

test where-clause-no-table-constant-condition-true-2 {
    select 1 where '1';
}
expect {
    1
}

test where-clause-no-table-constant-condition-true-3 {
    select 1 where 6.66;
}
expect {
    1
}

test where-clause-no-table-constant-condition-true-4 {
    select 1 where '6.66';
}
expect {
    1
}

test where-clause-no-table-constant-condition-true-5 {
    select 1 where -1;
}
expect {
    1
}

test where-clause-no-table-constant-condition-true-6 {
    select 1 where '-1';
}
expect {
    1
}

test where-clause-no-table-constant-condition-false {
    select 1 where 0;
}
expect {
}

test where-clause-no-table-constant-condition-identifier-false {
    select 1 where false;
}
expect {
}

test where-clause-no-table-constant-condition-false-2 {
    select 1 where '0';
}
expect {
}

test where-clause-no-table-constant-condition-false-3 {
    select 1 where 0.0;
}
expect {
}

test where-clause-no-table-constant-condition-false-4 {
    select 1 where '0.0';
}
expect {
}

test where-clause-no-table-constant-condition-false-5 {
    select 1 where -0.0;
}
expect {
}

test where-clause-no-table-constant-condition-false-6 {
    select 1 where '-0.0';
}
expect {
}

test where-clause-no-table-constant-condition-false-7 {
    select 1 where 'hamburger';
}
expect {
}

# Index tests with AND/OR
test select-where-and {
    select first_name, age from users where first_name = 'Jamie' and age > 80
}
expect {
    Jamie|87
    Jamie|88
    Jamie|88
    Jamie|92
    Jamie|94
    Jamie|99
}

test select-where-or {
    select first_name, age from users where first_name = 'Jamie' and age > 80
}
expect {
    Jamie|87
    Jamie|88
    Jamie|88
    Jamie|92
    Jamie|94
    Jamie|99
}

test select-where-and-or {
    select first_name, age from users where first_name = 'Jamie' or age = 1 and age = 2
}
expect {
    Jamie|94
    Jamie|88
    Jamie|31
    Jamie|26
    Jamie|71
    Jamie|50
    Jamie|28
    Jamie|46
    Jamie|17
    Jamie|64
    Jamie|76
    Jamie|99
    Jamie|92
    Jamie|47
    Jamie|27
    Jamie|54
    Jamie|47
    Jamie|15
    Jamie|12
    Jamie|71
    Jamie|87
    Jamie|34
    Jamie|88
    Jamie|41
    Jamie|73
}

# Products table tests
test where-float-int {
    select * from products where price > 50 and name != 'hat';
}
expect {
    2|cap|82.0
    5|sweatshirt|74.0
    6|shorts|70.0
    7|jeans|78.0
    8|sneakers|82.0
    11|accessories|81.0
}

test where-multiple-and {
    select * from products where price > 50 and name != 'sweatshirt' and price < 75;
}
expect {
    6|shorts|70.0
}

test where-multiple-or {
    select * from products where price > 75 or name = 'shirt' or name = 'coat';
}
expect {
    1|hat|79.0
    2|cap|82.0
    3|shirt|18.0
    7|jeans|78.0
    8|sneakers|82.0
    10|coat|33.0
    11|accessories|81.0
}

# IN list tests
test where-in-list {
    select * from products where name in ('hat', 'sweatshirt', 'shorts');
}
expect {
    1|hat|79.0
    5|sweatshirt|74.0
    6|shorts|70.0
}

test where-not-in-list {
    select * from products where name not in ('hat', 'sweatshirt', 'shorts');
}
expect {
    2|cap|82.0
    3|shirt|18.0
    4|sweater|25.0
    7|jeans|78.0
    8|sneakers|82.0
    9|boots|1.0
    10|coat|33.0
    11|accessories|81.0
}

test where-in-list-or-another-list {
    select * from products where name in ('hat', 'sweatshirt', 'shorts') or price in (81.0, 82.0);
}
expect {
    1|hat|79.0
    2|cap|82.0
    5|sweatshirt|74.0
    6|shorts|70.0
    8|sneakers|82.0
    11|accessories|81.0
}

test where-not-in-list-and-not-in-another-list {
    select * from products where name not in ('hat', 'sweatshirt', 'shorts') and price not in (81.0, 82.0, 78.0, 1.0, 33.0);
}
expect {
    3|shirt|18.0
    4|sweater|25.0
}

test where-in-list-or-not-in-another-list {
    select * from products where name in ('hat', 'sweatshirt', 'shorts') or price not in (82.0, 18.0, 78.0, 33.0, 81.0);
}
expect {
    1|hat|79.0
    4|sweater|25.0
    5|sweatshirt|74.0
    6|shorts|70.0
    9|boots|1.0
}

test where-in-empty-list {
    select * from products where name in ();
}
expect {
}

test where-not-in-empty-list {
    select * from products where name not in ();
}
expect {
    1|hat|79.0
    2|cap|82.0
    3|shirt|18.0
    4|sweater|25.0
    5|sweatshirt|74.0
    6|shorts|70.0
    7|jeans|78.0
    8|sneakers|82.0
    9|boots|1.0
    10|coat|33.0
    11|accessories|81.0
}

test where-name-in-list-and-price-gt-70-or-name-exactly-boots {
    select * from products where name in ('hat', 'sweatshirt', 'shorts') and price > 70 or name = 'boots';
}
expect {
    1|hat|79.0
    5|sweatshirt|74.0
    9|boots|1.0
}

test where-name-in-list-or-price-gt-70-and-name-like-shirt {
    select * from products where name in ('hat', 'shorts') or price > 70 and name like '%shirt%';
}
expect {
    1|hat|79.0
    5|sweatshirt|74.0
    6|shorts|70.0
}

test where-name-not-in-list-or-name-eq-shirt {
    select * from products where name not in ('shirt', 'boots') or name = 'shirt';
}
expect {
    1|hat|79.0
    2|cap|82.0
    3|shirt|18.0
    4|sweater|25.0
    5|sweatshirt|74.0
    6|shorts|70.0
    7|jeans|78.0
    8|sneakers|82.0
    10|coat|33.0
    11|accessories|81.0
}

# Users table multiple conditions
test where-multiple {
    select id, first_name, age from users where id = 5 and age < 50;
}
expect {
    5|Edward|15
}

test where-multiple-flipped {
    select id, first_name, age from users where age < 50 and id = 5;
}
expect {
    5|Edward|15
}

# Parentheses tests
test where-parentheses-and {
    select id, name from products where (id = 5 and name = 'sweatshirt') and (id = 5 and name = 'sweatshirt') ORDER BY id;
}
expect {
    5|sweatshirt
}

test where-nested-parentheses {
    select id, name from products where ((id = 5 and name = 'sweatshirt') or (id = 1 and name = 'hat')) ORDER BY id;
}
expect {
    1|hat
    5|sweatshirt
}

test where-complex-parentheses {
    select id, name from products where ((id = 5 and name = 'sweatshirt') or (id = 1 and name = 'hat')) and (name = 'sweatshirt' or name = 'hat') ORDER BY id;
}
expect {
    1|hat
    5|sweatshirt
}

# Index regression tests
test where-id-index-seek-regression-test {
    select id from users where id > 9995;
}
expect {
    9996
    9997
    9998
    9999
    10000
}

test where-id-index-seek-regression-test-opposite {
    select id from users where 9999 < id;
    select id from users where 10000 <= id;
    select id from users where 2 > id;
    select id from users where 1 >= id;
}
expect {
    10000
    10000
    1
    1
}

test where-id-index-seek-regression-test-2 {
    select count(1) from users where id > 0;
}
expect {
    10000
}

test where-age-index-seek-regression-test {
    select age from users where age >= 100 limit 20;
}
expect {
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
    100
}

test where-age-index-seek-regression-test-2 {
    select count(1) from users where age > 0;
}
expect {
    10000
}

test where-age-index-seek-regression-test-3 {
    select age from users where age > 90 limit 1;
}
expect {
    91
}

# BETWEEN tests
test where-simple-between {
    SELECT * FROM products WHERE price BETWEEN 70 AND 100;
}
expect {
    1|hat|79.0
    2|cap|82.0
    5|sweatshirt|74.0
    6|shorts|70.0
    7|jeans|78.0
    8|sneakers|82.0
    11|accessories|81.0
}

test between-price-range-with-names {
    SELECT * FROM products
    WHERE (price BETWEEN 70 AND 100)
    AND (name = 'sweatshirt' OR name = 'sneakers');
}
expect {
    5|sweatshirt|74.0
    8|sneakers|82.0
}

test where-between-true-and-2 {
    select id from users where id between true and 2;
}
expect {
    1
    2
}

# Complex nested parentheses
test nested-parens-conditionals-or-and-or {
    SELECT count(*) FROM users WHERE ((age > 25 OR age < 18) AND (city = 'Boston' OR state = 'MA'));
}
expect {
    146
}

test nested-parens-conditionals-and-or-and {
    SELECT * FROM users WHERE (((age > 18 AND city = 'New Mario') OR age = 92) AND city = 'Lake Paul');
}
expect {
    9989|Timothy|Harrison|woodsmichael@example.net|+1-447-830-5123|782 Wright Harbors|Lake Paul|ID|52330|92
}

test nested-parens-conditionals-and-double-or {
    SELECT * FROM users WHERE ((age > 30 OR age < 20) AND (state = 'NY' OR state = 'CA')) AND first_name glob 'An*' order by id;
}
expect {
    1738|Angelica|Pena|jacksonjonathan@example.net|(867)536-1578x039|663 Jacqueline Estate Apt. 652|Clairehaven|NY|64172|74
    1811|Andrew|Mckee|jchen@example.net|359.939.9548|19809 Blair Junction Apt. 438|New Lawrencefort|NY|26240|42
    3773|Andrew|Peterson|cscott@example.com|(405)410-4972x90408|90513 Munoz Radial Apt. 786|Travisfurt|CA|52951|43
    3875|Anthony|Cordova|ocross@example.org|+1-356-999-4070x557|77081 Aguilar Turnpike|Michaelfurt|CA|73353|37
    4909|Andrew|Carson|michelle31@example.net|823.423.1516|78514 Luke Springs|Lake Crystal|CA|49481|74
    5498|Anna|Hall|elizabethheath@example.org|9778473725|5803 Taylor Tunnel|New Nicholaston|NY|21825|14
    6340|Angela|Freeman|juankelly@example.net|501.372.4720|3912 Ricardo Mission|West Nancyville|NY|60823|34
    8171|Andrea|Lee|dgarrison@example.com|001-594-430-0646|452 Anthony Stravenue|Sandraville|CA|28572|12
    9110|Anthony|Barrett|steven05@example.net|(562)928-9177x8454|86166 Foster Inlet Apt. 284|North Jeffreyburgh|CA|80147|97
    9279|Annette|Lynn|joanne37@example.com|(272)700-7181|2676 Laura Points Apt. 683|Tristanville|NY|48646|91
}

# Regression test for nested parens + OR + AND
test nested-parens-and-inside-or-regression-test {
    SELECT count(1) FROM users
    WHERE (
        (
            (
                (id != 5)
                AND
                (id = 5 OR TRUE)
            )
            OR FALSE
        )
        AND
        (id = 6 OR FALSE)
    );
}
expect {
    1
}

# Binary comparisons with NULL operand
test where-binary-one-operand-null-eq {
    select * from users where first_name = NULL
}
expect {
}

test where-binary-one-operand-null-or-eq {
    select first_name from users where first_name = NULL OR id = 1
}
expect {
    Jamie
}

test where-binary-one-operand-null-and-eq {
    select first_name from users where first_name = NULL AND id = 1
}
expect {
}

test where-binary-one-operand-null-gt {
    select * from users where first_name > NULL
}
expect {
}

test where-binary-one-operand-null-or-gt {
    select first_name from users where first_name > NULL OR id = 1
}
expect {
    Jamie
}

test where-binary-one-operand-null-and-gt {
    select first_name from users where first_name > NULL AND id = 1
}
expect {
}

test where-binary-one-operand-null-lt {
    select * from users where first_name < NULL
}
expect {
}

test where-binary-one-operand-null-or-lt {
    select first_name from users where first_name < NULL OR id = 1
}
expect {
    Jamie
}

test where-binary-one-operand-null-and-lt {
    select first_name from users where first_name < NULL AND id = 1
}
expect {
}

test where-binary-one-operand-null-gte {
    select * from users where first_name >= NULL
}
expect {
}

test where-binary-one-operand-null-or-gte {
    select first_name from users where first_name >= NULL OR id = 1
}
expect {
    Jamie
}

test where-binary-one-operand-null-and-gte {
    select first_name from users where first_name >= NULL AND id = 1
}
expect {
}

test where-binary-one-operand-null-lte {
    select * from users where first_name <= NULL
}
expect {
}

test where-binary-one-operand-null-or-lte {
    select first_name from users where first_name <= NULL OR id = 1
}
expect {
    Jamie
}

test where-binary-one-operand-null-and-lte {
    select first_name from users where first_name <= NULL AND id = 1
}
expect {
}

test where-binary-one-operand-null-ne {
    select * from users where first_name != NULL
}
expect {
}

test where-binary-one-operand-null-or-ne {
    select first_name from users where first_name != NULL OR id = 1
}
expect {
    Jamie
}

test where-binary-one-operand-null-and-ne {
    select first_name from users where first_name != NULL AND id = 1
}
expect {
}

# Literals in WHERE
test where-literal-string {
    select count(*) from users where 'yes';
}
expect {
    0
}

# CAST in WHERE
test where-cast-string-to-int {
    select count(*) from users where cast('1' as integer);
}
expect {
    10000
}

test where-cast-float-to-int {
    select count(*) from users where cast('0' as integer);
}
expect {
    0
}

# Function in WHERE
test where-function-length {
    select count(*) from users where length(first_name);
}
expect {
    10000
}

# CASE in WHERE
test where-case-simple {
    select count(*) from users where
    case when age > 0 then 1 else 0 end;
}
expect {
    10000
}

test where-case-searched {
    select count(*) from users where
    case age
        when 0 then 0
        else 1
    end;
}
expect {
    10000
}

# Unary operators in WHERE
test where-unary-not {
    select count(*) from users where not (id = 1);
}
expect {
    9999
}

test where-unary-plus {
    select count(*) from users where +1;
}
expect {
    10000
}

test where-unary-minus {
    select count(*) from users where -1;
}
expect {
    10000
}

test where-unary-bitnot {
    select count(*) from users where ~1;
}
expect {
    10000
}

# Binary math operators in WHERE
test where-binary-add {
    select count(*) from users where 1 + 1;
}
expect {
    10000
}

test where-binary-subtract {
    select count(*) from users where 2 - 1;
}
expect {
    10000
}

test where-binary-multiply {
    select count(*) from users where 2 * 1;
}
expect {
    10000
}

test where-binary-divide {
    select count(*) from users where 2 / 2;
}
expect {
    10000
}

test where-binary-modulo {
    select count(*) from users where 3 % 2;
}
expect {
    10000
}

test where-binary-shift-left {
    select count(*) from users where 1 << 1;
}
expect {
    10000
}

test where-binary-shift-right {
    select count(*) from users where 2 >> 1;
}
expect {
    10000
}

test where-binary-bitwise-and {
    select count(*) from users where 3 & 1;
}
expect {
    10000
}

test where-binary-bitwise-or {
    select count(*) from users where 2 | 1;
}
expect {
    10000
}

# Constant conditions without tables
test where-constant-condition-no-tables {
    select 1 where 1 IS NULL;
}
expect {
}

test where-constant-condition-no-tables-2 {
    select 1 where 1 IS NOT NULL;
}
expect {
    1
}

# NULL comparison regression tests
test where-null-comparison-index-seek-regression-test {
    select age from users where age > NULL;
}
expect {
}

# Self-referential comparison regression
test where-self-referential-regression {
    select count(1) from users where id = id;
}
expect {
    10000
}
