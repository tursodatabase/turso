# GROUP BY Tests (Readonly - uses products/users tables)
# Ported from testing/groupby.test

@database database/testing.db readonly

test group_by {
    SELECT u.first_name, sum(u.age) FROM users u GROUP BY u.first_name LIMIT 10;
}
expect {
    Aaron|2271
    Abigail|890
    Adam|1642
    Adrian|439
    Adriana|83
    Adrienne|318
    Aimee|33
    Alan|551
    Albert|369
    Alec|247
}

test group_by_without_aggs {
    SELECT u.first_name FROM users u GROUP BY u.first_name LIMIT 10;
}
expect {
    Aaron
    Abigail
    Adam
    Adrian
    Adriana
    Adrienne
    Aimee
    Alan
    Albert
    Alec
}

test group_by_two_joined_columns {
    SELECT u.first_name, p.name, sum(u.age) FROM users u JOIN products p ON u.id = p.id GROUP BY u.first_name, p.name LIMIT 10;
}
expect {
    Aimee|jeans|24
    Cindy|cap|37
    Daniel|coat|13
    Edward|sweatshirt|15
    Jamie|hat|94
    Jennifer|sweater|33
    Matthew|boots|77
    Nicholas|shorts|89
    Rachel|sneakers|63
    Tommy|shirt|18
}

test group_by_order_by {
    SELECT u.first_name, p.name, sum(u.age) FROM users u JOIN products p ON u.id = p.id GROUP BY u.first_name, p.name ORDER BY p.name LIMIT 10;
}
expect {
    Travis|accessories|22
    Matthew|boots|77
    Cindy|cap|37
    Daniel|coat|13
    Jamie|hat|94
    Aimee|jeans|24
    Tommy|shirt|18
    Nicholas|shorts|89
    Rachel|sneakers|63
    Jennifer|sweater|33
}

test group_by_order_by_aggregate {
    SELECT u.first_name, p.name, sum(u.age) FROM users u JOIN products p ON u.id = p.id GROUP BY u.first_name, p.name ORDER BY sum(u.age) LIMIT 10;
}
expect {
    Daniel|coat|13
    Edward|sweatshirt|15
    Tommy|shirt|18
    Travis|accessories|22
    Aimee|jeans|24
    Jennifer|sweater|33
    Cindy|cap|37
    Rachel|sneakers|63
    Matthew|boots|77
    Nicholas|shorts|89
}

test group_by_multiple_aggregates {
    SELECT u.first_name, sum(u.age), count(u.age) FROM users u GROUP BY u.first_name ORDER BY sum(u.age) LIMIT 10;
}
expect {
    Jaclyn|1|1
    Mia|1|1
    Kirsten|7|1
    Kellie|8|1
    Makayla|8|1
    Yvette|9|1
    Mckenzie|12|1
    Grant|14|1
    Mackenzie|15|1
    Cesar|17|1
}

test group_by_multiple_aggregates_2 {
    SELECT u.first_name, sum(u.age), group_concat(u.age) FROM users u GROUP BY u.first_name ORDER BY u.first_name LIMIT 10;
}
expect {
    Aaron|2271|52,46,17,69,71,91,34,30,97,81,47,98,45,69,97,18,38,26,98,60,33,97,42,43,43,22,18,75,56,67,83,58,82,28,22,72,5,58,96,32,55
    Abigail|890|17,82,62,57,55,5,9,83,93,22,23,57,56,100,74,95
    Adam|1642|34,23,10,11,46,40,2,57,51,80,65,24,15,84,59,6,34,100,32,79,57,5,77,34,30,19,54,74,89,98,72,91,90
    Adrian|439|37,28,94,76,69,60,34,41
    Adriana|83|83
    Adrienne|318|79,74,82,33,50
    Aimee|33|24,9
    Alan|551|18,52,30,62,96,13,85,97,98
    Albert|369|99,80,41,7,64,7,26,41,4
    Alec|247|55,48,53,91
}

test group_by_complex_order_by_2 {
    SELECT u.first_name, sum(u.age) FROM users u GROUP BY u.first_name ORDER BY -1 * sum(u.age) LIMIT 10;
}
expect {
    Michael|11204
    David|8758
    Robert|8109
    Jennifer|7700
    John|7299
    Christopher|6397
    James|5921
    Joseph|5711
    Brian|5059
    William|5047
}

test group_by_and_binary_expression_that_depends_on_two_aggregates {
    SELECT u.first_name, sum(u.age) + count(1) FROM users u GROUP BY u.first_name LIMIT 5;
}
expect {
    Aaron|2312
    Abigail|906
    Adam|1675
    Adrian|447
    Adriana|84
}

test group_by_function_expression {
    SELECT length(phone_number), count(1) FROM users GROUP BY length(phone_number) ORDER BY count(1);
}
expect {
    15|392
    22|416
    13|762
    20|791
    10|793
    19|816
    21|821
    17|1184
    18|1211
    16|1231
    12|1583
}

test group_by_function_expression_ridiculous {
    SELECT upper(substr(phone_number, 1,3)), count(1) FROM users GROUP BY upper(substr(phone_number, 1,3)) ORDER BY -1 * count(1) LIMIT 5;
}
expect {
    001|1677
    +1-|1606
    (97|36
    (20|35
    (31|35
}

test group_by_count_star {
    SELECT u.first_name, count(*) FROM users u GROUP BY u.first_name LIMIT 1;
}
expect {
    Aaron|41
}

test group_by_count_star_in_expression {
    SELECT u.first_name, count(*) % 3 FROM users u GROUP BY u.first_name ORDER BY u.first_name LIMIT 3;
}
expect {
    Aaron|2
    Abigail|1
    Adam|0
}

test group_by_count_no_args_in_expression {
    SELECT u.first_name, count() % 3 FROM users u GROUP BY u.first_name ORDER BY u.first_name LIMIT 3;
}
expect {
    Aaron|2
    Abigail|1
    Adam|0
}

test having {
    SELECT u.first_name, round(avg(u.age)) FROM users u GROUP BY u.first_name HAVING avg(u.age) > 97 ORDER BY avg(u.age) DESC LIMIT 5;
}
expect {
    Nina|100.0
    Kurt|99.0
    Selena|98.0
}

test having_with_binary_cond {
    SELECT u.first_name, sum(u.age) FROM users u GROUP BY u.first_name HAVING sum(u.age) + 1000 = 9109;
}
expect {
    Robert|8109
}

test having_with_scalar_fn_over_aggregate {
    SELECT u.first_name, concat(count(1), ' people with this name') FROM users u GROUP BY u.first_name HAVING count(1) > 50 ORDER BY count(1) ASC LIMIT 5;
}
expect {
    Angela|51 people with this name
    Justin|51 people with this name
    Rachel|52 people with this name
    Susan|52 people with this name
    Jeffrey|54 people with this name
}

test having_with_multiple_conditions {
    SELECT u.first_name, count(*), round(avg(u.age)) AS avg_age
    FROM users u
    GROUP BY u.first_name
    HAVING count(*) > 40 AND avg(u.age) > 40
    ORDER BY count(*) DESC, avg(u.age) DESC
    LIMIT 5;
}
expect {
    Michael|228|49.0
    David|165|53.0
    Robert|159|51.0
    Jennifer|151|51.0
    John|145|50.0
}

test column_alias_in_group_by_order_by_having {
    SELECT first_name AS fn, count(1) AS fn_count FROM users WHERE fn IN ('Wanda', 'Whitney', 'William') GROUP BY fn HAVING fn_count > 10 ORDER BY fn_count;
}
expect {
    Whitney|11
    William|111
}

test group_by_column_number {
    SELECT u.first_name, count(1) FROM users u GROUP BY 1 LIMIT 1;
}
expect {
    Aaron|41
}

test groupby_orderby_removal_regression_test {
    SELECT id, last_name, count(1) FROM users GROUP BY 1,2 ORDER BY id, last_name DESC LIMIT 3;
}
expect {
    1|Foster|1
    2|Salazar|1
    3|Perry|1
}

test group_by_no_sorting_required {
    SELECT age, count(1) FROM users GROUP BY age LIMIT 3;
}
expect {
    1|112
    2|113
    3|97
}

test distinct_agg_functions {
    SELECT first_name, sum(distinct age), count(distinct age), avg(distinct age)
    FROM users
    GROUP BY 1
    LIMIT 3;
}
expect {
    Aaron|1769|33|53.6060606060606
    Abigail|833|15|55.5333333333333
    Adam|1517|30|50.5666666666667
}

test complex_result_expression_containing_aggregate {
    SELECT
        CASE WHEN price > 70 THEN group_concat(name, ',') ELSE '<undisclosed>' END names
    FROM products
    GROUP BY price
    ORDER BY price;
}
expect {
    <undisclosed>
    <undisclosed>
    <undisclosed>
    <undisclosed>
    <undisclosed>
    sweatshirt
    jeans
    hat
    accessories
    cap,sneakers
}

test complex_result_expression_containing_aggregate_and_rowid {
    SELECT
        CASE WHEN rowid >= 5 THEN group_concat(name, ',') ELSE '<undisclosed>' END names
    FROM products
    GROUP BY rowid
    ORDER BY rowid;
}
expect {
    <undisclosed>
    <undisclosed>
    <undisclosed>
    <undisclosed>
    sweatshirt
    shorts
    jeans
    sneakers
    boots
    coat
    accessories
}

test complex_having_expression_containing_aggregate {
    SELECT group_concat(name, ',') FROM products GROUP BY price HAVING (group_concat(name, ',') || price) LIKE 'ca%';
}
expect {
    cap,sneakers
}

test complex_order_by_expression_containing_aggregate {
    SELECT group_concat(name, ',') FROM products GROUP BY price ORDER BY (group_concat(name, ',') || price);
}
expect {
    accessories
    boots
    cap,sneakers
    coat
    hat
    jeans
    shirt
    shorts
    sweater
    sweatshirt
}

test more_args_than_aggregates {
    SELECT group_concat(name, ','), group_concat(name, ';'), group_concat(name, '.') FROM products GROUP BY id;
}
expect {
    hat|hat|hat
    cap|cap|cap
    shirt|shirt|shirt
    sweater|sweater|sweater
    sweatshirt|sweatshirt|sweatshirt
    shorts|shorts|shorts
    jeans|jeans|jeans
    sneakers|sneakers|sneakers
    boots|boots|boots
    coat|coat|coat
    accessories|accessories|accessories
}

test proper-sort-order {
    SELECT u.first_name, COUNT(*) AS c
    FROM users u
    JOIN products p ON p.id = u.id
    GROUP BY u.first_name
    ORDER BY c DESC;
}
expect {
    Travis|1
    Tommy|1
    Rachel|1
    Nicholas|1
    Matthew|1
    Jennifer|1
    Jamie|1
    Edward|1
    Daniel|1
    Cindy|1
    Aimee|1
}
