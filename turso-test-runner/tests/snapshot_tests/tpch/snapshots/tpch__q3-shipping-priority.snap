---
source: tpch.sqltest
expression: |-
  select
          l_orderkey,
          sum(l_extendedprice * (1 - l_discount)) as revenue,
          o_orderdate,
          o_shippriority
      from
          customer,
          orders,
          lineitem
      where
          c_mktsegment = 'FURNITURE'
          and c_custkey = o_custkey
          and l_orderkey = o_orderkey
          and o_orderdate < '1995-03-29'
          and l_shipdate > '1995-03-29'
      group by
          l_orderkey,
          o_orderdate,
          o_shippriority
      order by
          revenue desc,
          o_orderdate
      limit 10;
info:
  statement_type: SELECT
  tables:
  - customer
  setup_blocks:
  - schema
  database: ':memory:'
---
QUERY PLAN
|--SEARCH customer USING INTEGER PRIMARY KEY (rowid=?)
|--SCAN orders
|--SEARCH lineitem USING INDEX sqlite_autoindex_lineitem_1
`--USE TEMP B-TREE FOR ORDER BY

BYTECODE
addr  opcode                    p1  p2  p3  p4                                     p5  comment
   0          Init               0  86   0                                          0  Start at 86
   1          SorterOpen         0   3   0  k(3,-B,B,Binary)                        0  cursor=0
   2          Null               0  15   0                                          0  r[15]=NULL
   3          SorterOpen         1   4   0  k(3,B,B,B)                              0  cursor=1
   4          Integer            0   8   0                                          0  r[8]=0; clear group by abort flag
   5          Null               0   9  11                                          0  r[9..11]=NULL; initialize group by comparison registers to NULL
   6          Gosub             21  72   0                                          0  ; go to clear accumulator subroutine
   7          Integer           10  22   0                                          0  r[22]=10; LIMIT counter
   8          IfNot             22  37   0                                          0  if !r[22] goto 37
   9          OpenRead           3   8   0  k(8,B,B,B,B,B,B,B,B)                    0  table=customer, root=8, iDb=0
  10          OpenRead           4   9   0  k(9,B,B,B,B,B,B,B,B,B)                  0  table=orders, root=9, iDb=0
  11          OpenRead           5  10   0  k(17,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B,B)   0  table=lineitem, root=10, iDb=0
  12          OpenRead           6  11   0  k(3,B,B)                                0  index=sqlite_autoindex_lineitem_1, root=11, iDb=0
  13          Rewind             4  37   0                                          0  Rewind table orders
  14            Column           4   4  24                                          0  r[24]=orders.o_orderdate
  15            Ge              24  25  36  Binary                                  0  if r[24]>=r[25] goto 36
  16            Column           4   1  26                                          0  r[26]=orders.o_custkey
  17            SeekRowid        3  26  36                                          0  if (r[26]!=cursor 3 for table customer.rowid) goto 36
  18            Column           3   6  28                                          0  r[28]=customer.c_mktsegment
  19            Ne              28  29  36  Binary                                  0  if r[28]!=r[29] goto 36
  20            RowId            4  30   0                                          0  r[30]=orders.rowid
  21            SeekGE           6  36  30                                          0  key=[30..30]
  22              IdxGT          6  36  30                                          0  key=[30..30]
  23              DeferredSeek   6   5   0                                          0
  24              Column         5  10  32                                          0  r[32]=lineitem.l_shipdate
  25              Le            32  33  35  Binary                                  0  if r[32]<=r[33] goto 35
  26              Column         5   0  17                                          0  r[17]=lineitem.l_orderkey
  27              Column         4   4  18                                          0  r[18]=orders.o_orderdate
  28              Column         4   7  19                                          0  r[19]=orders.o_shippriority
  29              Column         5   5  34                                          0  r[34]=lineitem.l_extendedprice
  30              Column         5   6  37                                          0  r[37]=lineitem.l_discount
  31              Subtract      36  37  35                                          0  r[35]=r[36]-r[37]
  32              Multiply      34  35  20                                          0  r[20]=r[34]*r[35]
  33              MakeRecord    17   4  16                                          0  r[16]=mkrec(r[17..20])
  34              SorterInsert   1  16   0  0                                       0  key=r[16]
  35            Next             6  22   0                                          0
  36          Next               4  14   0                                          0
  37          OpenPseudo         2  16   4                                          0  4 columns in r[16]
  38          SorterSort         1  57   0                                          0
  39            SorterData       1  16   2                                          0  r[16]=data
  40            Column           2   0  38                                          0  r[38]=pseudo.column 0
  41            Column           2   1  39                                          0  r[39]=pseudo.column 1
  42            Column           2   2  40                                          0  r[40]=pseudo.column 2
  43            Compare          9  38   3  k(3, Binary, Binary, Binary)            0  r[9..11]==r[38..40]
  44            Jump            45  49  45                                          0  ; start new group if comparison is not equal
  45            Gosub            6  61   0                                          0  ; check if ended group had data, and output if so
  46            Move            38   9   3                                          0  r[9..11]=r[38..40]
  47            IfPos            8  75   0                                          0  r[8]>0 -> r[8]-=0, goto 75; check abort flag
  48            Gosub           21  72   0                                          0  ; goto clear accumulator subroutine
  49            Column           2   3  41                                          0  r[41]=pseudo.column 3
  50            AggStep          0  41  15  sum                                     0  accum=r[15] step(r[41])
  51            If               7  55   0                                          0  if r[7] goto 55; don't emit group columns if continuing existing group
  52            Column           2   0  12                                          0  r[12]=pseudo.column 0
  53            Column           2   1  13                                          0  r[13]=pseudo.column 1
  54            Column           2   2  14                                          0  r[14]=pseudo.column 2
  55            Integer          1   7   0                                          0  r[7]=1; indicate data in accumulator
  56          SorterNext         1  39   0                                          0
  57          Gosub              6  61   0                                          0  ; emit row for final group
  58          Goto               0  75   0                                          0  ; group by finished
  59          Integer            1   8   0                                          0  r[8]=1
  60        Return               6   0   0                                          0
  61        IfPos                7  63   0                                          0  r[7]>0 -> r[7]-=0, goto 63; output group by row subroutine start
  62      Return                 6   0   0                                          0
  63      AggFinal               0  15   0  sum                                     0  accum=r[15]
  64      Copy                  15  42   0                                          0  r[42]=r[15]
  65      Copy                  13  43   0                                          0  r[43]=r[13]
  66      Sequence               0  44   0                                          0
  67      Copy                  12  45   0                                          0  r[45]=r[12]
  68      Copy                  14  46   0                                          0  r[46]=r[14]
  69      MakeRecord            42   5   5                                          0  r[5]=mkrec(r[42..46])
  70      SorterInsert           0   5   0  0                                       0  key=r[5]
  71    Return                   6   0   0                                          0
  72    Null                     0  12  15                                          0  r[12..15]=NULL; clear accumulator subroutine start
  73    Integer                  0   7   0                                          0  r[7]=0
  74  Return                    21   0   0                                          0
  75  OpenPseudo                 7   5   5                                          0  5 columns in r[5]
  76  SorterSort                 0  85   0                                          0
  77    SorterData               0   5   7                                          0  r[5]=data
  78    Column                   7   3   1                                          0  r[1]=pseudo.column 3
  79    Column                   7   0   2                                          0  r[2]=pseudo.column 0
  80    Column                   7   1   3                                          0  r[3]=pseudo.column 1
  81    Column                   7   4   4                                          0  r[4]=pseudo.column 4
  82    ResultRow                1   4   0                                          0  output=r[1..4]
  83    DecrJumpZero            22  85   0                                          0  if (--r[22]==0) goto 85
  84  SorterNext                 0  77   0                                          0
  85  Halt                       0   0   0                                          0
  86  Transaction                0   1   8                                          0  iDb=0 tx_mode=Read
  87  String8                    0  25   0  1995-03-29                              0  r[25]='1995-03-29'
  88  String8                    0  29   0  FURNITURE                               0  r[29]='FURNITURE'
  89  String8                    0  33   0  1995-03-29                              0  r[33]='1995-03-29'
  90  Integer                    1  36   0                                          0  r[36]=1
  91  Goto                       0   1   0                                          0
