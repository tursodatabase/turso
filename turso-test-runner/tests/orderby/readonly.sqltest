# ORDER BY Tests (Readonly - uses products/users tables)
# Ported from testing/orderby.test

@database testing/testing.db readonly

test basic-order-by-asc {
    SELECT * FROM products ORDER BY price;
}
expect {
    9|boots|1.0
    3|shirt|18.0
    4|sweater|25.0
    10|coat|33.0
    6|shorts|70.0
    5|sweatshirt|74.0
    7|jeans|78.0
    1|hat|79.0
    11|accessories|81.0
    2|cap|82.0
    8|sneakers|82.0
}

test basic-order-by-desc {
    SELECT * FROM products ORDER BY price DESC;
}
expect {
    2|cap|82.0
    8|sneakers|82.0
    11|accessories|81.0
    1|hat|79.0
    7|jeans|78.0
    5|sweatshirt|74.0
    6|shorts|70.0
    10|coat|33.0
    4|sweater|25.0
    3|shirt|18.0
    9|boots|1.0
}

test basic-order-by-and-limit-asc {
    SELECT * FROM products ORDER BY name LIMIT 5;
}
expect {
    11|accessories|81.0
    9|boots|1.0
    2|cap|82.0
    10|coat|33.0
    1|hat|79.0
}

test basic-order-by-and-limit-desc {
    SELECT * FROM products ORDER BY name DESC LIMIT 5;
}
expect {
    5|sweatshirt|74.0
    4|sweater|25.0
    8|sneakers|82.0
    6|shorts|70.0
    3|shirt|18.0
}

test basic-order-by-and-limit-2-asc {
    SELECT id, name FROM products ORDER BY name LIMIT 5;
}
expect {
    11|accessories
    9|boots
    2|cap
    10|coat
    1|hat
}

test basic-order-by-and-limit-2-desc {
    SELECT id, name FROM products ORDER BY name DESC LIMIT 5;
}
expect {
    5|sweatshirt
    4|sweater
    8|sneakers
    6|shorts
    3|shirt
}

test basic-order-by-and-limit-3-asc {
    SELECT price, name FROM products WHERE price > 70 ORDER BY name;
}
expect {
    81.0|accessories
    82.0|cap
    79.0|hat
    78.0|jeans
    82.0|sneakers
    74.0|sweatshirt
}

test basic-order-by-and-limit-3-desc {
    SELECT price, name FROM products WHERE price > 70 ORDER BY name DESC;
}
expect {
    74.0|sweatshirt
    82.0|sneakers
    78.0|jeans
    79.0|hat
    82.0|cap
    81.0|accessories
}

test order-by-qualified-asc {
    SELECT u.first_name FROM users u ORDER BY u.first_name LIMIT 1;
}
expect {
    Aaron
}

test order-by-qualified-desc {
    SELECT u.first_name FROM users u ORDER BY u.first_name DESC LIMIT 1;
}
expect {
    Zoe
}

test order-by-column-number {
    SELECT first_name, last_name, age FROM users ORDER BY 3,2 LIMIT 2;
}
expect {
    Teresa|Allen|1
    David|Baker|1
}

test order-by-column-number-desc-asc {
    SELECT first_name, last_name, age FROM users ORDER BY 3 DESC, 2 ASC LIMIT 2;
}
expect {
    Connor|Adkins|100
    John|Bell|100
}

test order-by-column-number-asc-desc {
    SELECT first_name, last_name, age FROM users ORDER BY 3 ASC, 2 DESC LIMIT 2;
}
expect {
    Kyle|Wolf|1
    Jason|Williams|1
}

test order-by-column-number-asc-desc-limit-10 {
    SELECT first_name, last_name, age FROM users ORDER BY 3 ASC, 2 DESC LIMIT 10;
}
expect {
    Kyle|Wolf|1
    Jason|Williams|1
    Tracey|Williams|1
    Jessica|Werner|1
    Jasmine|Warren|1
    Dennis|Ward|1
    Whitney|Walker|1
    Robert|Villanueva|1
    Cynthia|Thomas|1
    Brandon|Tate|1
}

test order-by-case-insensitive-aggregate {
    SELECT u.first_name, sum(u.age) FROM users u GROUP BY u.first_name ORDER BY SUM(u.aGe) DESC LIMIT 10;
}
expect {
    Michael|11204
    David|8758
    Robert|8109
    Jennifer|7700
    John|7299
    Christopher|6397
    James|5921
    Joseph|5711
    Brian|5059
    William|5047
}

test order-by-agg-not-mentioned-in-select {
    SELECT u.first_name, length(group_concat(u.last_name)) FROM users u GROUP BY u.first_name ORDER BY max(u.email) DESC LIMIT 5;
}
expect {
    Louis|65
    Carolyn|118
    Katelyn|40
    Erik|88
    Collin|15
}

test case-insensitive-alias {
    SELECT u.first_name AS fF, count(1) > 0 AS cC FROM users u WHERE fF = 'Jamie' GROUP BY fF ORDER BY cC;
}
expect {
    Jamie|1
}

test age_idx_order_desc {
    SELECT first_name FROM users ORDER BY age DESC LIMIT 3;
}
expect {
    Robert
    Sydney
    Matthew
}

test rowid_or_integer_pk_desc {
    SELECT first_name FROM users ORDER BY id DESC LIMIT 3;
}
expect {
    Nicole
    Gina
    Dorothy
}

test orderby_asc_verify_rows {
    SELECT count(1) FROM (SELECT * FROM users ORDER BY age DESC);
}
expect {
    10000
}

test orderby_desc_verify_rows {
    SELECT count(1) FROM (SELECT * FROM users ORDER BY age DESC);
}
expect {
    10000
}

test orderby_desc_with_offset {
    SELECT first_name, age FROM users ORDER BY age DESC LIMIT 3 OFFSET 666;
}
expect {
    Francis|94
    Matthew|94
    Theresa|94
}

test orderby_desc_with_filter {
    SELECT first_name, age FROM users WHERE age <= 50 ORDER BY age DESC LIMIT 5;
}
expect {
    Gerald|50
    Nicole|50
    Tammy|50
    Marissa|50
    Daniel|50
}

test orderby_asc_with_filter_range {
    SELECT first_name, age FROM users WHERE age <= 50 AND age >= 49 ORDER BY age ASC LIMIT 5;
}
expect {
    William|49
    Jennifer|49
    Robert|49
    David|49
    Stephanie|49
}

test orderby_desc_with_filter_id_lt {
    SELECT id FROM users WHERE id < 6666 ORDER BY id DESC LIMIT 5;
}
expect {
    6665
    6664
    6663
    6662
    6661
}

test orderby_desc_with_filter_id_le {
    SELECT id FROM users WHERE id <= 6666 ORDER BY id DESC LIMIT 5;
}
expect {
    6666
    6665
    6664
    6663
    6662
}

test orderby_desc_regression {
    SELECT count(1) FROM (SELECT * FROM users WHERE id < 100 ORDER BY id DESC);
}
expect {
    99
}

test orderby_desc_regression_verify_order {
    SELECT id FROM users WHERE id < 100 ORDER BY id DESC LIMIT 3;
}
expect {
    99
    98
    97
}

test order_by_column_deduplication {
    SELECT name, name, price FROM products ORDER BY name;
}
expect {
    accessories|accessories|81.0
    boots|boots|1.0
    cap|cap|82.0
    coat|coat|33.0
    hat|hat|79.0
    jeans|jeans|78.0
    shirt|shirt|18.0
    shorts|shorts|70.0
    sneakers|sneakers|82.0
    sweater|sweater|25.0
    sweatshirt|sweatshirt|74.0
}
