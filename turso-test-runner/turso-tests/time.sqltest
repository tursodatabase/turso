# Time Extension Functions Tests
# Ported from testing/time.test

@database database/testing.db readonly

# time_date function tests

test time-date {
    SELECT time_fmt_iso(time_date(2011, 11, 18));
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35));
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35, 666777888));
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35, 0, 3*3600));
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35, 666777888, 3*3600));
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35, 666777888, 25*3600));
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35, 666777888, -25*3600));
}
expect {
    2011-11-18T00:00:00Z
    2011-11-18T15:56:35Z
    2011-11-18T15:56:35.666777888Z
    2011-11-18T12:56:35Z
    2011-11-18T12:56:35.666777888Z
    2011-11-17T14:56:35.666777888Z
    2011-11-19T16:56:35.666777888Z
}

test time-get-year {
    SELECT time_get_year(time_date(2011, 11, 18));
    SELECT time_get_year(time_date(1842, 11, 18));
    SELECT time_get_year(time_date(-1000, 11, 18));
}
expect {
    2011
    1842
    -1000
}

test time-get-month {
    SELECT time_get_month(time_date(2011, 12, 18));
    SELECT time_get_month(time_date(1842, 1, 18));
    SELECT time_get_month(time_date(-1000, 5, 18));
}
expect {
    12
    1
    5
}

test time-get-day {
    SELECT time_get_day(time_date(2011, 12, 31));
    SELECT time_get_day(time_date(1842, 1, 10));
    SELECT time_get_day(time_date(-1000, 5, 25));
}
expect {
    31
    10
    25
}

test time-get-hour {
    SELECT time_get_hour(time_date(2011, 12, 31, 10, 5, 30));
}
expect {
    10
}

test time-get-minute {
    SELECT time_get_minute(time_date(2011, 12, 31, 10, 5, 30));
}
expect {
    5
}

test time-get-second {
    SELECT time_get_second(time_date(2011, 12, 31, 10, 5, 30, 431295000));
}
expect {
    30
}

test time-get-nanosecond {
    SELECT time_get_nano(time_date(2011, 12, 31, 10, 5, 30, 431295000));
}
expect {
    431295000
}

test time-get-weekday {
    SELECT time_get_weekday(time_date(2011, 12, 31, 10, 5, 30, 431295000));
    SELECT time_get_weekday(time_date(2012, 01, 01, 10, 5, 30, 431295000));
}
expect {
    6
    0
}

test time-get-yearday {
    SELECT time_get_yearday(time_date(2011, 12, 31, 10, 5, 30, 431295000));
    SELECT time_get_yearday(time_date(2012, 01, 01, 10, 5, 30, 431295000));
}
expect {
    365
    1
}

test time-get-isoyear {
    SELECT time_get_isoyear(time_date(2011, 12, 31, 10, 5, 30, 431295000));
    SELECT time_get_isoyear(time_date(2012, 01, 01, 10, 5, 30, 431295000));
}
expect {
    2011
    2011
}

test time-get-isoweek {
    SELECT time_get_isoweek(time_date(2011, 12, 31, 10, 5, 30, 431295000));
    SELECT time_get_isoweek(time_date(2012, 01, 01, 10, 5, 30, 431295000));
    SELECT time_get_isoweek(time_date(2012, 01, 10, 10, 5, 30, 431295000));
}
expect {
    52
    52
    2
}

test time-get {
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'millennium');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'century');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'decade');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'year');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'quarter');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'month');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'day');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'hour');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'minute');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'second');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'milli');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'millisecond');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'micro');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'microsecond');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'nano');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'nanosecond');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'isoyear');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'isoweek');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'isodow');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'yearday');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'weekday');
    SELECT time_get(time_date(2024, 8, 6, 21, 22, 15, 431295000), 'epoch');
}
expect {
    2
    20
    202
    2024
    3
    8
    6
    21
    22
    15.431295
    431
    431
    431295
    431295
    431295000
    431295000
    2024
    32
    2
    219
    2
    1722979335.43129
}

# time_unix function tests

test time-unix {
    SELECT time_fmt_iso(time_unix(1321631795));
    SELECT time_fmt_iso(time_unix(1321631795, 666777888));
}
expect {
    2011-11-18T15:56:35Z
    2011-11-18T15:56:35.666777888Z
}

test time-milli {
    SELECT time_fmt_iso(time_milli(1321631795666));
}
expect {
    2011-11-18T15:56:35.666000000Z
}

test time-micro {
    SELECT time_fmt_iso(time_micro(1321631795666777));
}
expect {
    2011-11-18T15:56:35.666777000Z
}

test time-nano {
    SELECT time_fmt_iso(time_nano(1321631795666777888));
}
expect {
    2011-11-18T15:56:35.666777888Z
}

test time-to-milli {
    SELECT time_fmt_iso(time_milli(time_to_milli(time_date(2025, 01, 01))));
}
expect {
    2025-01-01T00:00:00Z
}

test time-to-micro {
    SELECT time_fmt_iso(time_micro(time_to_micro(time_date(2025, 01, 01))));
}
expect {
    2025-01-01T00:00:00Z
}

test time-to-nano {
    SELECT time_fmt_iso(time_nano(time_to_nano(time_date(2025, 01, 01))));
}
expect {
    2025-01-01T00:00:00Z
}

# time_after and time_before function tests

test time-after {
    SELECT time_after(time_date(2025, 10, 10), time_date(2011, 11, 18));
}
expect {
    1
}

test time-before {
    SELECT time_before(time_date(2025, 10, 10), time_date(2011, 11, 18));
}
expect {
    0
}

test time-compare {
    SELECT time_compare(time_date(2025, 10, 10), time_date(2011, 11, 18));
    SELECT time_compare(time_date(2025, 10, 10), time_date(2026, 11, 18));
    SELECT time_compare(time_date(2025, 10, 10), time_date(2025, 10, 10));
}
expect {
    1
    -1
    0
}

# time_add function tests

test time-add {
    SELECT time_fmt_iso(time_add(time_date(2025, 01, 01), 24*dur_h()));
    SELECT time_fmt_iso(time_add(time_date(2025, 01, 01), 60*dur_m()));
    SELECT time_fmt_iso(time_add(time_date(2025, 01, 01), 5*dur_m()+30*dur_s()));
    SELECT time_fmt_iso(date_add(time_date(2025, 01, 01), 24*dur_h()));
    SELECT time_fmt_iso(date_add(time_date(2025, 01, 01), 60*dur_m()));
    SELECT time_fmt_iso(date_add(time_date(2025, 01, 01), 5*dur_m()+30*dur_s()));
}
expect {
    2025-01-02T00:00:00Z
    2025-01-01T01:00:00Z
    2025-01-01T00:05:30Z
    2025-01-02T00:00:00Z
    2025-01-01T01:00:00Z
    2025-01-01T00:05:30Z
}

test time-add-date {
    SELECT time_fmt_date(time_add_date(time_date(2011, 11, 18), 5));
    SELECT time_fmt_date(time_add_date(time_date(2011, 11, 18), 3, 5));
    SELECT time_fmt_date(time_add_date(time_date(2011, 11, 18), 3, 5, -10));
}
expect {
    2016-11-18
    2015-04-18
    2015-04-08
}

# time_sub function tests

test time-sub {
    SELECT time_sub(time_date(2011, 11, 19), time_date(2011, 11, 18));
    SELECT time_sub(
        time_date(2011, 11, 18, 16, 56, 35),
        time_date(2011, 11, 18, 15, 56, 35)
    );
    SELECT time_sub(time_unix(1321631795, 5000000), time_unix(1321631795, 0));
}
expect {
    86400000000000
    3600000000000
    5000000
}

# time_trunc function tests

test time-trunc {
    SELECT 'original = '   || time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35, 666777888));
    SELECT 'millennium = ' || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'millennium'));
    SELECT 'century = '    || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'century'));
    SELECT 'decade = '     || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'decade'));
    SELECT 'year = '       || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'year'));
    SELECT 'quarter = '    || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'quarter'));
    SELECT 'month = '      || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'month'));
    SELECT 'week = '       || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'week'));
    SELECT 'day = '        || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'day'));
    SELECT 'hour = '       || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'hour'));
    SELECT 'minute = '     || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'minute'));
    SELECT 'second = '     || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'second'));
    SELECT 'milli = '      || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'milli'));
    SELECT 'micro = '      || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 'micro'));
    SELECT '12h = '        || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 12*dur_h()));
    SELECT '1h = '         || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), dur_h()));
    SELECT '30m = '        || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 30*dur_m()));
    SELECT '1m = '         || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), dur_m()));
    SELECT '30s = '        || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), 30*dur_s()));
    SELECT '1s = '         || time_fmt_iso(time_trunc(time_date(2011, 11, 18, 15, 56, 35, 666777888), dur_s()));
}
expect {
    original = 2011-11-18T15:56:35.666777888Z
    millennium = 2000-01-01T00:00:00Z
    century = 2000-01-01T00:00:00Z
    decade = 2010-01-01T00:00:00Z
    year = 2011-01-01T00:00:00Z
    quarter = 2011-10-01T00:00:00Z
    month = 2011-11-01T00:00:00Z
    week = 2011-11-12T00:00:00Z
    day = 2011-11-18T00:00:00Z
    hour = 2011-11-18T15:00:00Z
    minute = 2011-11-18T15:56:00Z
    second = 2011-11-18T15:56:35Z
    milli = 2011-11-18T15:56:35.666000000Z
    micro = 2011-11-18T15:56:35.666777000Z
    12h = 2011-11-18T12:00:00Z
    1h = 2011-11-18T15:00:00Z
    30m = 2011-11-18T15:30:00Z
    1m = 2011-11-18T15:56:00Z
    30s = 2011-11-18T15:56:30Z
    1s = 2011-11-18T15:56:35Z
}

# time_round function tests

test time-round {
    SELECT '12h = '        || time_fmt_iso(time_round(time_date(2011, 11, 18, 15, 56, 35, 666777888), 12*dur_h()));
    SELECT '1h = '         || time_fmt_iso(time_round(time_date(2011, 11, 18, 15, 56, 35, 666777888), dur_h()));
    SELECT '30m = '        || time_fmt_iso(time_round(time_date(2011, 11, 18, 15, 56, 35, 666777888), 30*dur_m()));
    SELECT '1m = '         || time_fmt_iso(time_round(time_date(2011, 11, 18, 15, 56, 35, 666777888), dur_m()));
    SELECT '30s = '        || time_fmt_iso(time_round(time_date(2011, 11, 18, 15, 56, 35, 666777888), 30*dur_s()));
    SELECT '1s = '         || time_fmt_iso(time_round(time_date(2011, 11, 18, 15, 56, 35, 666777888), dur_s()));
}
expect {
    12h = 2011-11-18T12:00:00Z
    1h = 2011-11-18T16:00:00Z
    30m = 2011-11-18T16:00:00Z
    1m = 2011-11-18T15:57:00Z
    30s = 2011-11-18T15:56:30Z
    1s = 2011-11-18T15:56:36Z
}

# time_fmt_iso function tests

test time-fmt-iso {
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35, 666777888), 3*3600);
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35, 666777888));
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35), 3*3600);
    SELECT time_fmt_iso(time_date(2011, 11, 18, 15, 56, 35));
}
expect {
    2011-11-18T18:56:35.666777888+03:00
    2011-11-18T15:56:35.666777888Z
    2011-11-18T18:56:35+03:00
    2011-11-18T15:56:35Z
}

# time_fmt_datetime function tests

test time-fmt-datetime {
    SELECT time_fmt_datetime(time_date(2011, 11, 18, 15, 56, 35), 3*3600);
    SELECT time_fmt_datetime(time_date(2011, 11, 18, 15, 56, 35));
    SELECT time_fmt_datetime(time_date(2011, 11, 18));
}
expect {
    2011-11-18 18:56:35
    2011-11-18 15:56:35
    2011-11-18 00:00:00
}

# time_fmt_date function tests

test time-fmt-date {
    SELECT time_fmt_date(time_date(2011, 11, 18, 15, 56, 35), 12*3600);
    SELECT time_fmt_date(time_date(2011, 11, 18, 15, 56, 35));
    SELECT time_fmt_date(time_date(2011, 11, 18));
}
expect {
    2011-11-19
    2011-11-18
    2011-11-18
}

# time_fmt_time function tests

test time-fmt-time {
    SELECT time_fmt_time(time_date(2011, 11, 18, 15, 56, 35), 3*3600);
    SELECT time_fmt_time(time_date(2011, 11, 18, 15, 56, 35));
    SELECT time_fmt_time(time_date(2011, 11, 18));
}
expect {
    18:56:35
    15:56:35
    00:00:00
}

# time_parse function tests

test time-parse {
    SELECT time_parse('2011-11-18T15:56:35.666777888Z')      = time_unix(1321631795, 666777888);
    SELECT time_parse('2011-11-18T19:26:35.666777888+03:30') = time_unix(1321631795, 666777888);
    SELECT time_parse('2011-11-18T12:26:35.666777888-03:30') = time_unix(1321631795, 666777888);
    SELECT time_parse('2011-11-18T15:56:35Z')                = time_unix(1321631795, 0);
    SELECT time_parse('2011-11-18T19:26:35+03:30')           = time_unix(1321631795, 0);
    SELECT time_parse('2011-11-18T12:26:35-03:30')           = time_unix(1321631795, 0);
    SELECT time_parse('2011-11-18 15:56:35')                 = time_unix(1321631795, 0);
    SELECT time_parse('2011-11-18')                          = time_date(2011, 11, 18);
    SELECT time_parse('15:56:35')                            = time_date(1, 1, 1, 15, 56, 35);
}
expect {
    1
    1
    1
    1
    1
    1
    1
    1
    1
}

# Duration constant function tests

test duration-constants {
    SELECT dur_ns();
    SELECT dur_us();
    SELECT dur_ms();
    SELECT dur_s();
    SELECT dur_m();
    SELECT dur_h();
}
expect {
    1
    1000
    1000000
    1000000000
    60000000000
    3600000000000
}
