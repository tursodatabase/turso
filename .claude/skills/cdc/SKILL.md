---
name: cdc
description: Change Data Capture - architecture, entrypoints, bytecode emission, sync engine integration, tests
---
# CDC (Change Data Capture) - Internal Feature Map

## Overview

CDC tracks INSERT/UPDATE/DELETE changes on database tables by writing change records into a
dedicated CDC table (`turso_cdc` by default). It is per-connection, enabled via PRAGMA, and
operates at the bytecode generation (translate) layer. The sync engine consumes CDC records
to replicate changes across nodes.

**Status:** Unstable (PRAGMA name prefixed with `unstable_`).

## Architecture Diagram

```
User SQL (INSERT/UPDATE/DELETE/DDL)
        |
        v
  ┌─────────────────────────────────────────────────┐
  │  Translate layer (core/translate/)              │
  │  ┌───────────────────────────────────────────┐  │
  │  │ prepare_cdc_if_necessary()                │  │
  │  │   - checks CaptureDataChangesMode         │  │
  │  │   - opens CDC table cursor (OpenWrite)    │  │
  │  │   - skips if target == CDC table itself   │  │
  │  └───────────────────────────────────────────┘  │
  │  ┌───────────────────────────────────────────┐  │
  │  │ emit_cdc_insns()                          │  │
  │  │   - writes (change_id, change_time,       │  │
  │  │     change_type, table_name, id,          │  │
  │  │     before, after, updates) into CDC tbl  │  │
  │  └───────────────────────────────────────────┘  │
  │  + emit_cdc_full_record() / emit_cdc_patch_record() │
  └─────────────────────────────────────────────────┘
        |
        v
  CDC table (turso_cdc or custom name)
        |
        v
  ┌─────────────────────────────────────────────────┐
  │  Sync engine (sync/engine/)                     │
  │  DatabaseTape reads CDC table → DatabaseChange  │
  │  → apply/revert → replicate to remote           │
  └─────────────────────────────────────────────────┘
```

## Core Data Types

### `CaptureDataChangesMode` — `core/lib.rs:1523-1581`

The central enum controlling CDC behavior per connection:

```rust
enum CaptureDataChangesMode {
    Off,                       // no capture
    Id { table: String },      // capture only rowid
    Before { table: String },  // capture before-image
    After { table: String },   // capture after-image
    Full { table: String },    // before + after + updates
}
```

Key methods:
- `parse(value: &str)` — parses PRAGMA argument `"<mode>[,<table_name>]"`
- `has_before()` / `has_after()` / `has_updates()` — mode capability checks
- `table()` — returns CDC table name (None for Off)

### CDC Table Schema — `core/translate/pragma.rs:1315-1370`

Default table name: `turso_cdc` (constant `TURSO_CDC_DEFAULT_TABLE_NAME` at pragma.rs:1315)

```sql
CREATE TABLE turso_cdc (
    change_id   INTEGER PRIMARY KEY AUTOINCREMENT,
    change_time INTEGER,        -- unixepoch()
    change_type INTEGER,        -- 1=INSERT, 0=UPDATE, -1=DELETE
    table_name  TEXT,
    id          <untyped>,      -- rowid of changed row
    before      BLOB,           -- binary record (before-image)
    after       BLOB,           -- binary record (after-image)
    updates     BLOB            -- binary record of per-column changes
);
```

Column definitions are programmatically generated by `turso_cdc_table_columns()` at `pragma.rs:1316`.

### `DatabaseChange` — `sync/engine/src/types.rs:229-249`

Sync engine's Rust representation of a CDC row. Has `into_apply()` and `into_revert()` methods
for forward/backward replay.

### `OperationMode` — `core/translate/emitter.rs:354-359`

Used by `emit_cdc_insns()` to determine `change_type` value:
- `INSERT` → 1
- `UPDATE` / `SELECT` → 0
- `DELETE` → -1

## Entry Points

### 1. PRAGMA — Enable/Disable CDC

**Set:** `core/translate/pragma.rs:350-378`
- Parses mode string via `CaptureDataChangesMode::parse()`
- Auto-creates CDC table if it doesn't exist (`translate_create_table`)
- Sets mode on connection via `connection.set_capture_data_changes(opts)`

**Get (read current mode):** `core/translate/pragma.rs:1044-1047`

**Pragma registration:** `core/pragma.rs:149-152` — `UnstableCaptureDataChangesConn`

### 2. Connection State

**Field:** `core/connection.rs:80` — `capture_data_changes: RwLock<CaptureDataChangesMode>`
**Getter:** `core/connection.rs:987-991` — `get_capture_data_changes()`
**Setter:** `core/connection.rs:992-993` — `set_capture_data_changes()`
**Default:** `core/lib.rs:1216` — initialized as `CaptureDataChangesMode::Off`

### 3. ProgramBuilder Integration

**Field:** `core/vdbe/builder.rs:138` — `capture_data_changes_mode`
**Accessor:** `core/vdbe/builder.rs:518-519` — `capture_data_changes_mode()`
**Passed from:** `core/translate/mod.rs:90` — read from connection when creating builder

## Bytecode Emission (core/translate/emitter.rs)

These are the core CDC code generation functions:

| Function | Line | Purpose |
|----------|------|---------|
| `prepare_cdc_if_necessary()` | 3998 | Opens CDC table cursor if CDC is active and target != CDC table |
| `emit_cdc_full_record()` | 4061 | Reads all columns from cursor into a MakeRecord (for before/after image) |
| `emit_cdc_patch_record()` | 4026 | Builds record from in-flight register values (for after-image of INSERT/UPDATE) |
| `emit_cdc_insns()` | 4095 | Writes a full CDC row: change_id, change_time, change_type, table_name, id, before, after, updates |

## Integration Points — Where CDC Records Are Emitted

### INSERT — `core/translate/insert.rs`
- **After insert:** lines 723-742 — emits CDC with after-image
- **Before delete (for REPLACE/conflict):** lines 2941-2959 — emits CDC before-image

### UPDATE — `core/translate/emitter.rs`
- **Before update:** lines 3769-3775 — captures before-image
- **After update:** lines 3898-3905 — captures after-image via patch record
- **Updates column tracking:** lines 2810-2838 — allocates 2*C registers for per-column change tracking
- **CDC write:** lines 3925-3968 — emits CDC insns (handles id/before/after/full modes separately)

### DELETE — `core/translate/emitter.rs`
- **Before delete:** lines 1955-1973 — captures before-image and emits CDC row

### UPSERT (ON CONFLICT DO UPDATE) — `core/translate/upsert.rs`
- Lines 969-1042 — emits CDC for all three cases: pure insert, update after conflict, replace

### Schema Changes (DDL) — `core/translate/schema.rs`
- **CREATE TABLE:** line 270 — captures insert into `sqlite_schema`
- **DROP TABLE:** lines 829-865 — captures delete from `sqlite_schema` with before-image
- **CREATE INDEX:** line 218 — captures insert into `sqlite_schema`
- **DROP INDEX:** lines 867-882 — captures delete from `sqlite_schema`

### ALTER TABLE — `core/translate/update.rs:106-107`
- Sets `cdc_update_alter_statement` on the update plan when CDC has updates mode
- `core/translate/emitter.rs:2590-2592` — writes DDL statement into the updates column

### Schema changes via schema.rs
- `core/translate/schema.rs:270,360,702,779` — all DDL operations check/prepare CDC

### Views/Triggers — Explicitly excluded
- `core/translate/view.rs:139,173,200,287` — passes `None` for CDC cursor
- `core/translate/trigger.rs:161` — passes `None` for CDC cursor

### Subqueries — No CDC
- `core/translate/subquery.rs:1109,1206,1291` — `cdc_cursor_id: None`

## Helper Functions (for reading CDC data)

### `table_columns_json_array(table_name)` — `core/function.rs:590`, `core/vdbe/execute.rs:5388`
Returns JSON array of column names for a table. Used to interpret binary records.

### `bin_record_json_object(columns_json, blob)` — `core/function.rs:591`, `core/vdbe/execute.rs:5439`
Decodes a binary record (from `before`/`after`/`updates` columns) into a JSON object using column names.

## Sync Engine Integration

The sync engine is the primary consumer of CDC data.

### DatabaseTape — `sync/engine/src/database_tape.rs`
- **CDC config:** lines 28-36 — `DEFAULT_CDC_TABLE_NAME = "turso_cdc"`, `DEFAULT_CDC_MODE = "full"`
- **PRAGMA name:** line 31 — `CDC_PRAGMA_NAME = "unstable_capture_data_changes_conn"`
- **Initialization:** lines 121-126 — sets CDC pragma on connection open
- **Iterator:** lines 378-416 — reads CDC table in batches, emits `DatabaseTapeOperation`

### Sync Operations — `sync/engine/src/database_sync_operations.rs`
- **Change counting:** line 723 — `SELECT COUNT(*) FROM turso_cdc WHERE change_id > ?`

### Sync Engine — `sync/engine/src/database_sync_engine.rs`
- Lines 876-1004 — during `apply_changes`, checks if CDC table existed, re-creates it after sync

### Replay Generator — `sync/engine/src/database_replay_generator.rs`
- Line 264 — requires `updates` column to be populated (full mode)

## Bindings CDC Surface

All bindings expose `cdc_operations` as part of sync stats:

| Binding | File | Line |
|---------|------|------|
| Python | `bindings/python/src/turso_sync.rs` | 230 |
| JavaScript | `bindings/javascript/sync/src/lib.rs` | 415 |
| JS (generator) | `bindings/javascript/sync/src/generator.rs` | 47 |
| Go | `bindings/go/bindings_sync.go` | 155, 597 |
| React Native | `bindings/react-native/src/types.ts` | 346 |
| SDK Kit (C header) | `sync/sdk-kit/turso_sync.h` | — |
| SDK Kit (Rust) | `sync/sdk-kit/src/bindings.rs` | 91 |

## Tests

### Integration tests — `tests/integration/functions/test_cdc.rs`

| Test | Line | What it covers |
|------|------|----------------|
| `test_cdc_simple_id` | 18 | Mode `id`: INSERT only captures rowid |
| `test_cdc_simple_before` | 79 | Mode `before`: INSERT/UPDATE/DELETE captures before-image |
| `test_cdc_simple_after` | 149 | Mode `after`: INSERT/UPDATE/DELETE captures after-image |
| `test_cdc_simple_full` | 219 | Mode `full`: captures before+after+updates |
| `test_cdc_crud` | 294 | All CRUD operations with mode `id` |
| `test_cdc_failed_op` | 415 | Failed INSERT (unique constraint) doesn't produce CDC entries |
| `test_cdc_uncaptured_connection` | 489 | CDC only captures for enabled connection |
| `test_cdc_custom_table` | 569 | Custom CDC table name |
| `test_cdc_ignore_changes_in_cdc_table` | 617 | Changes to CDC table itself are not re-captured |
| `test_cdc_transaction` | 656 | Transaction boundary: CDC records appear after COMMIT |
| `test_cdc_independent_connections` | 738 | Two connections with different CDC tables |
| `test_cdc_independent_connections_different_cdc_not_ignore` | 792 | Cross-CDC-table operations are captured |
| `test_cdc_table_columns` | 880 | `table_columns_json_array()` helper function |
| `test_cdc_bin_record` | 895 | `bin_record_json_object()` helper function |
| `test_cdc_schema_changes` | 923 | CDC captures CREATE TABLE/INDEX, DROP TABLE/INDEX as sqlite_schema changes |
| `test_cdc_schema_changes_alter_table` | 1045 | CDC captures ALTER TABLE with before/after/updates |

Test module registration: `tests/integration/functions/mod.rs`

Note: Many tests use `#[turso_macros::test()]` (non-MVCC) because they require indexes.
Some use `#[turso_macros::test(mvcc)]`.

### Sync engine tests — `sync/engine/src/database_tape.rs`
- Internal tests (line 713+) that verify CDC table reads and tape iteration.

### JS binding tests
- `bindings/javascript/sync/packages/wasm/promise.test.ts` — lines 93-99, queries `turso_cdc` directly
- `bindings/javascript/sync/packages/native/promise.test.ts` — uses `cdcOperations` stat

## User-facing Documentation

- **CLI manual page:** `cli/manuals/cdc.md` — accessible via `.manual cdc` in the REPL
- **Database manual:** `docs/manual.md` — CDC section linked in TOC

## Key Design Decisions

1. **Per-connection, not per-database.** Each connection has its own CDC mode and can target different tables.
2. **Bytecode-level implementation.** CDC instructions are emitted alongside the actual DML bytecode during translation — no runtime hooks or triggers.
3. **Self-exclusion.** Changes to the CDC table itself are never re-captured (checked in `prepare_cdc_if_necessary`).
4. **Schema changes tracked.** DDL operations are recorded as changes to `sqlite_schema` table.
5. **Binary record format.** Before/after/updates columns use SQLite's MakeRecord format (same as B-tree payload).
6. **Transaction-aware.** CDC writes happen within the same transaction as the DML, so rollback naturally discards CDC entries.

## TODOs Found in Code

- `core/translate/emitter.rs:4021` — fix DB number for ATTACH support
- `core/translate/emitter.rs:4183` — properly set prev_largest_reg from sqlite_sequence for AUTOINCREMENT
- `core/translate/pragma.rs:352` — consistently update capture_data_changes only after successful schema change
- `sync/engine/src/database_tape.rs:394` — iterator needs to be smarter about transaction boundaries
- `tests/integration/functions/test_cdc.rs:413,487,567,615,655,737,791,878,921,1043` — many tests can't use MVCC because of indexes
